<!doctype html public "-//W3C//DTD HTML 4.0 Frameset//EN""http://www.w3.org/TR/REC-html40/frameset.dtd">
<html>
<head>
<title>
<a href='http://mapbuilder.sourceforge.net'>Community Map Builder</a> 22 Dec 2006 Overview
</title>
<link rel ="stylesheet" type="text/css" href="stylesheet.css" title="Style">
<script>
function asd() {
	
		parent.document.title="MapPane.js Overview";
	
}
</script>
</head>
<body bgcolor="white" onload="asd();">

<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<table border="0" width="100%" cellpadding="1" cellspacing="0">
<tr>
<td colspan=2 bgcolor="#EEEEFF" class="NavBarCell1">
<a name="navbar_top_firstrow"><!-- --></a>
<table border="0" cellpadding="0" cellspacing="3">
  <tr align="center" valign="top">
  
  
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-summary.html"><font class="NavBarFont1"><b>Overview</b></font></a>&nbsp;</td>
  <td bgcolor="#FFFFFF" class="NavBarCell1Rev">	&nbsp;<font class="NavBarFont1Rev"><b>File</b></font>&nbsp;</td>
  

  <td bgcolor="#FFFFFF" class="NavBarCell1"> 	<font class="NavBarFont1">Class</font>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-tree.html"><font class="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="index-all.html"--><font class="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="help-doc.html"><font class="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
  </tr>
</table>
</td>
<td bgcolor="#EEEEFF" align="right" valign="top">
<em>
<b><a href='http://mapbuilder.sourceforge.net'>Community Map Builder</a> 22 Dec 2006</b></em>
</td>
</tr>

<tr>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
&nbsp;PREV&nbsp;
&nbsp;NEXT</font></td>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
  <a href="index.html" target="_top"><b>FRAMES</b></a>  &nbsp;
&nbsp;<a href="overview-summary.html" target="_top"><b>NO FRAMES</b></a>
&nbsp;&nbsp;
<script>
  <!--
  if(window==top) {
    document.writeln('<A HREF="allclasses-noframe.html" TARGET=""><B>All Classes</B></A>');
  }
  //-->
</script>
<noscript>
<a href="allclasses-noframe.html" target=""><b>All Classes</b></a>
</noscript>
</font></td>
</tr>
</table>
<!-- =========== END OF NAVBAR =========== -->

<hr>
<center>
	
	   <h2>MapPane.js</h2>
	
</center>

	


<h4>Summary</h4>
<p>
	
		No overview generated for 'MapPane.js'<BR/><BR/>
	
</p>

<hr>


    <table border="1" cellpadding="3" cellspacing="0" width="100%">
    <tr bgcolor="#CCCCFF" class="TableHeadingColor">
    <td colspan=2><font size="+2">
    
        <b>Class Summary</b>
    
    </font></td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="MapPane.html">MapPane</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    </table>
    <hr/> 


<!-- ========== METHOD SUMMARY =========== -->

	<a name="method_summary"><!-- --></a>
	<table border="1" cellpadding="3" cellspacing="0" width="100%">
		<tr bgcolor="#CCCCFF" class="TableHeadingColor">
			<td colspan=2>
				<font size="+2">
					<b>Method Summary</b>
				</font>
			</td>
		</tr>
	
		
		   <tr bgcolor="white" class="TableRowColor">
		      <td align="right" valign="top" width="1%">
			 <font size="-1">
			    <code>static&nbsp;void</code>
			 </font>
		      </td>
		      <td>
			 <code>
			    <b>
			       <a href="GLOBALS.html#MapImgLoad">MapImgLoad</a></b>( objRef, layer )
			 </code>
			 <br>
			 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			 Sets up an image to be loaded.
		      </td>
		   </tr>
		
		   <tr bgcolor="white" class="TableRowColor">
		      <td align="right" valign="top" width="1%">
			 <font size="-1">
			    <code>static&nbsp;void</code>
			 </font>
		      </td>
		      <td>
			 <code>
			    <b>
			       <a href="GLOBALS.html#MapImgLoadHandler">MapImgLoadHandler</a></b>()
			 </code>
			 <br>
			 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			 image onload handler function.
		      </td>
		   </tr>
		
	
	</table>
    <p>

<!-- ========== END METHOD SUMMARY =========== -->


        <pre class="sourceview"><span class="comment">/*
Author:       Cameron Shorter cameronAtshorter.net
License:      LGPL as per: http://www.gnu.org/copyleft/lesser.html

$Id: MapPane.js 2096 2006-04-26 17:31:22 +0000 (mer., 26 avr. 2006) madair $
*/</span>
<span class="comment">
// Ensure this object's dependancies are loaded.</span>
mapbuilder.loadScript(baseDir+<span class="literal">"/widget/WidgetBase.js"</span>);
mapbuilder.loadScript(baseDir+<span class="literal">"/widget/MapContainerBase.js"</span>);

<span class="comment">/**
 * Widget to render a map from an OGC context document.  The layers are rendered
 * as an array of DHTML layers that contain an &lt;IMG&gt; tag with src attribute set 
 * to the GetMap request.
 * <span class="attrib">@constructor</span>
 * <span class="attrib">@base</span> WidgetBaseXSL
 * <span class="attrib">@base</span> MapContainerBase
 * <span class="attrib">@param</span> widgetNode  The widget's XML object node from the configuration document.
 * <span class="attrib">@param</span> model       The model object that this widget belongs to.
 */</span>
<span class="reserved">function</span> MapPane(widgetNode, model) {
  WidgetBase.apply(<span class="reserved">this</span>,new Array(widgetNode, model));
  MapContainerBase.apply(<span class="reserved">this</span>,new Array(widgetNode, model));

  var node = widgetNode.selectSingleNode(<span class="literal">"mb:noPreload"</span>);
  <span class="reserved">if</span>( node ) {
    <span class="reserved">this</span>.doNotPreload = widgetNode.selectSingleNode(<span class="literal">"mb:noPreload"</span>).firstChild.nodeValue;
  } <span class="reserved">else</span> {
    <span class="reserved">this</span>.doNotPreload = false;
  }
<span class="comment">  
  // Set this.stylesheet</span>
<span class="comment">  // Defaults to "widget/&lt;widgetName&gt;.xsl" if not defined in config file.</span>
  <span class="reserved">if</span> ( !<span class="reserved">this</span>.stylesheet ) {
    var styleNode = widgetNode.selectSingleNode(<span class="literal">"mb:stylesheet"</span>);
    <span class="reserved">if</span> (styleNode ) {
      <span class="reserved">this</span>.stylesheet = new XslProcessor(styleNode.firstChild.nodeValue,model.namespace);
    } <span class="reserved">else</span> {
      <span class="reserved">this</span>.stylesheet = new XslProcessor(baseDir+<span class="literal">"/widget/"</span>+widgetNode.nodeName+<span class="literal">".xsl"</span>,model.namespace);
    }
  }
<span class="comment">
  //loading img to be displayed while models load</span>
  var loadingSrc = widgetNode.selectSingleNode(<span class="literal">"mb:loadingSrc"</span>);
  <span class="reserved">if</span> (loadingSrc) {
    <span class="reserved">this</span>.loadingSrc = config.skinDir + loadingSrc.firstChild.nodeValue;
  } <span class="reserved">else</span> {
    <span class="reserved">this</span>.loadingSrc = config.skinDir + <span class="literal">"/images/Loading.gif"</span>;
  }
<span class="comment">
  // Set stylesheet parameters for all the child nodes from the config file</span>
  <span class="reserved">for</span> (var j=0;j&lt;widgetNode.childNodes.length;j++) {
    <span class="reserved">if</span> (widgetNode.childNodes[j].firstChild
      &amp;&amp; widgetNode.childNodes[j].firstChild.nodeValue)
    {
      <span class="reserved">this</span>.stylesheet.setParameter(
        widgetNode.childNodes[j].nodeName,
        widgetNode.childNodes[j].firstChild.nodeValue);
    }
  }
<span class="comment">
  //all stylesheets will have these properties available</span>
  <span class="reserved">this</span>.stylesheet.setParameter(<span class="literal">"modelId"</span>, <span class="reserved">this</span>.model.id );
  <span class="reserved">this</span>.stylesheet.setParameter(<span class="literal">"modelTitle"</span>, <span class="reserved">this</span>.model.title );
  <span class="reserved">this</span>.stylesheet.setParameter(<span class="literal">"widgetId"</span>, <span class="reserved">this</span>.id );
  <span class="reserved">this</span>.stylesheet.setParameter(<span class="literal">"skinDir"</span>, config.skinDir );
  <span class="reserved">this</span>.stylesheet.setParameter(<span class="literal">"lang"</span>, config.lang );

  <span class="comment">/**
   * Called when the context's hidden attribute changes.
   * <span class="attrib">@param</span> objRef This object.
   * <span class="attrib">@param</span> layerName  The name of the layer that was toggled.
   */</span>
  <span class="reserved">this</span>.hiddenListener=<span class="reserved">function</span>(objRef, layerName){
    var vis=<span class="literal">"visible"</span>;
    <span class="reserved">if</span>(objRef.model.getHidden(layerName)==<span class="literal">"1"</span>) {
      vis=<span class="literal">"hidden"</span>;
    }
    var layerId = objRef.model.id + <span class="literal">"_"</span> + objRef.id + <span class="literal">"_"</span> + layerName;
    var layer = document.getElementById(layerId);
    <span class="reserved">if</span> (layer) {
      layer.style.visibility=vis;
      imgId = <span class="literal">"real"</span>+layer.imgId;
      domImg = document.getElementById(imgId); // Hack to make sure that the child element is toggled in IE
      <span class="reserved">if</span>( domImg ) {
        <span class="reserved">if</span>( domImg.isLoading ) {
          domImg.style.visibility = vis;
        } <span class="reserved">else</span> <span class="reserved">if</span> (vis == <span class="literal">'visible'</span>) {
<span class="comment">          // load map image and make it visible</span>
          MapImgLoad( objRef, layer );
        }
        <span class="reserved">else</span> { 
<span class="comment">          // hide image</span>
          domImg.style.visibility = vis;
        }
      }
    }
  }
  <span class="reserved">this</span>.model.addListener(<span class="literal">"hidden"</span>,<span class="reserved">this</span>.hiddenListener,<span class="reserved">this</span>);

  <span class="comment">/**
   * Called after a feature has been added to a WFS.  This function triggers
   * the WMS basemaps to be redrawn.  A timestamp param is added to the URL
   * to ensure the basemap image is not cached.
   */</span>
  <span class="reserved">this</span>.refreshWmsLayers=<span class="reserved">function</span>(objRef){
    objRef.d=new Date();
    objRef.stylesheet.setParameter(<span class="literal">"uniqueId"</span>,objRef.d.getTime());
    objRef.paint(objRef);
  }
  <span class="reserved">this</span>.model.addListener(<span class="literal">"refreshWmsLayers"</span>,<span class="reserved">this</span>.refreshWmsLayers,<span class="reserved">this</span>);

  <span class="reserved">this</span>.model.addListener(<span class="literal">"refresh"</span>,<span class="reserved">this</span>.paint, <span class="reserved">this</span>);
  <span class="reserved">this</span>.model.addListener(<span class="literal">"addLayer"</span>,<span class="reserved">this</span>.addLayer, <span class="reserved">this</span>);
  <span class="reserved">this</span>.model.addListener(<span class="literal">"deleteLayer"</span>,<span class="reserved">this</span>.deleteLayer, <span class="reserved">this</span>);
  <span class="reserved">this</span>.model.addListener(<span class="literal">"moveLayerUp"</span>,<span class="reserved">this</span>.moveLayerUp, <span class="reserved">this</span>);
  <span class="reserved">this</span>.model.addListener(<span class="literal">"moveLayerDown"</span>,<span class="reserved">this</span>.moveLayerDown, <span class="reserved">this</span>);
  <span class="reserved">this</span>.model.addListener(<span class="literal">"timestamp"</span>,<span class="reserved">this</span>.timestampListener,<span class="reserved">this</span>);
}

<span class="comment">/**
 * Render the widget.
 * <span class="attrib">@param</span> objRef Pointer to widget object.
 */</span>
MapPane.<span class="reserved">prototype</span>.paint = <span class="reserved">function</span>(objRef) {

  <span class="reserved">if</span> (objRef.model.doc &amp;&amp; objRef.node) {
<span class="comment">    //if (objRef.debug) alert("source:"+Sarissa.serialize(objRef.model.doc));</span>

    objRef.stylesheet.setParameter(<span class="literal">"width"</span>, objRef.model.getWindowWidth());
    objRef.stylesheet.setParameter(<span class="literal">"height"</span>, objRef.model.getWindowHeight());
    objRef.stylesheet.setParameter(<span class="literal">"bbox"</span>, objRef.model.getBoundingBox().join(<span class="literal">","</span>));
    objRef.stylesheet.setParameter(<span class="literal">"srs"</span>, objRef.model.getSRS());
<span class="comment">
    //confirm inputs</span>
    <span class="reserved">if</span> (objRef.debug) alert(<span class="literal">"painting:"</span>+Sarissa.serialize(objRef.model.doc));
    <span class="reserved">if</span> (objRef.debug) alert(<span class="literal">"stylesheet:"</span>+Sarissa.serialize(objRef.stylesheet.xslDom));
<span class="comment">//alert("PAINT MODEL.DOC  : "+Sarissa.serialize(objRef.model.doc));</span>
<span class="comment">
    //process the doc with the stylesheet</span>
    var tempDom = objRef.stylesheet.transformNodeToObject(objRef.model.doc);
<span class="comment">//alert(Sarissa.serialize(tempDom));</span>
    var tempNodeList = tempDom.selectNodes(<span class="literal">"//img"</span>);
<span class="comment">
    //debug output</span>
    <span class="reserved">if</span> (objRef.debug) {
      alert(<span class="literal">"painting:"</span>+objRef.id+<span class="literal">":"</span>+s);
      <span class="reserved">if</span> (config.serializeUrl) postLoad(config.serializeUrl, s);
    }
<span class="comment">
    //create a DIV to hold all the individual image DIVs</span>
    var outputNode = document.getElementById( objRef.outputNodeId );
    <span class="reserved">if</span> (!outputNode) {
      outputNode = document.createElement(<span class="literal">"div"</span>);
      outputNode.setAttribute(<span class="literal">"id"</span>, objRef.outputNodeId);
      outputNode.style.position = <span class="literal">"absolute"</span>; 
      objRef.node.appendChild(outputNode);
      outputNode.style.left=<span class="literal">'0px'</span>;
      outputNode.style.top=<span class="literal">'0px'</span>;
    } 
<span class="comment">
    //loop through all layers and create an array of IMG objects for preloading </span>
<span class="comment">    // the WMS getMap calls</span>
    var layers = objRef.model.getAllLayers();
    <span class="reserved">if</span> (!objRef.imageStack) objRef.imageStack = new Array(layers.length);
    objRef.firstImageLoaded = false;

    objRef.layerCount = layers.length;
    objRef.loadingLayerCount = 0;
    <span class="reserved">for</span> (var i=0;i&lt;layers.length;i++){
      <span class="reserved">if</span> (!objRef.imageStack[i]) {
        objRef.imageStack[i] = new Image();
        objRef.imageStack[i].objRef = objRef;
      }
<span class="comment">      
      //var newSrc = tempNode.firstChild.childNodes[i].firstChild.getAttribute("src"); </span>
      var newSrc = tempNodeList[i].getAttribute(<span class="literal">"src"</span>);
      objRef.loadImgDiv(layers[i],newSrc,objRef.imageStack[i]);
    }
  }
}

<span class="comment">/**
 * Returns an ID for the image DIV given a layer name
 * <span class="attrib">@param</span> layerName the name of the WMS layer
 */</span>
MapPane.<span class="reserved">prototype</span>.getLayerDivId = <span class="reserved">function</span>(layerName) {
  <span class="reserved">return</span> <span class="reserved">this</span>.model.id +<span class="literal">"_"</span>+ <span class="reserved">this</span>.id +<span class="literal">"_"</span>+ layerName; 
<span class="comment">
  //add timestamp to layerID if layer have a timestampList</span>
  <span class="reserved">if</span> (<span class="reserved">this</span>.model.timestampList &amp;&amp; <span class="reserved">this</span>.model.timestampList.getAttribute(<span class="literal">"layerName"</span>) == layerName) {
    
    var timestampIndex = <span class="reserved">this</span>.model.getParam(<span class="literal">"timestamp"</span>);
    var timestamp = <span class="reserved">this</span>.model.timestampList.childNodes[timestampIndex];
    layerId += <span class="literal">"_"</span> + timestamp.firstChild.nodeValue;
  }
}

  <span class="comment">/**
   * Called when the map timestamp is changed so set the layer visiblity.
   * <span class="attrib">@param</span> objRef This object.
   * <span class="attrib">@param</span> timestampIndex  The array index for the layer to be displayed. 
   */</span>
MapPane.<span class="reserved">prototype</span>.timestampListener = <span class="reserved">function</span>(objRef, timestampIndex){
    var layerName = objRef.model.timestampList.getAttribute(<span class="literal">"layerName"</span>);
    var timestamp = objRef.model.timestampList.childNodes[timestampIndex];
    var vis = (timestamp.getAttribute(<span class="literal">"current"</span>)==<span class="literal">"1"</span>) ? <span class="literal">"visible"</span>:<span class="literal">"hidden"</span>;
    var layerId = objRef.model.id + <span class="literal">"_"</span> + objRef.id + <span class="literal">"_"</span> + layerName + <span class="literal">"_"</span> + timestamp.firstChild.nodeValue;
    var layer = document.getElementById(layerId);
    <span class="reserved">if</span> (layer) {
      layer.style.visibility=vis;
    } <span class="reserved">else</span> {
      alert(<span class="literal">"error finding layerId:"</span>+layerId);
    }
  }

<span class="comment">/**
 * Adds a layer into the output
 * <span class="attrib">@param</span> layerName the WMS name for the layer to be added
 */</span>
MapPane.<span class="reserved">prototype</span>.addLayer = <span class="reserved">function</span>(objRef, layerNode) {
<span class="comment">  
  //process the doc with the stylesheet</span>
  objRef.stylesheet.setParameter(<span class="literal">"width"</span>, objRef.model.getWindowWidth());
  objRef.stylesheet.setParameter(<span class="literal">"height"</span>, objRef.model.getWindowHeight());
  objRef.stylesheet.setParameter(<span class="literal">"bbox"</span>, objRef.model.getBoundingBox().join(<span class="literal">","</span>));
  objRef.stylesheet.setParameter(<span class="literal">"srs"</span>, objRef.model.getSRS());
 
  var s = objRef.stylesheet.transformNodeToString(layerNode);
  var tempNode = document.createElement(<span class="literal">"div"</span>);
  tempNode.innerHTML = s;
  var newSrc = tempNode.firstChild.firstChild.getAttribute(<span class="literal">"src"</span>); 

  objRef.imageStack.push(new Image());
  objRef.imageStack[objRef.imageStack.length-1].objRef = objRef;
  objRef.firstImageLoaded = true;

  ++objRef.layerCount;
  objRef.loadImgDiv(layerNode,newSrc,objRef.imageStack[objRef.imageStack.length-1]);
}

<span class="comment">/**
 * Modify a layer into the output
 * <span class="attrib">@param</span> layerName the WMS name for the layer to be modified
 */</span>
MapPane.<span class="reserved">prototype</span>.modifyLayer = <span class="reserved">function</span>(objRef, layerNode) {
<span class="comment">
  //process the doc with the stylesheet</span>
  objRef.stylesheet.setParameter(<span class="literal">"width"</span>, objRef.model.getWindowWidth());
  objRef.stylesheet.setParameter(<span class="literal">"height"</span>, objRef.model.getWindowHeight());
  objRef.stylesheet.setParameter(<span class="literal">"bbox"</span>, objRef.model.getBoundingBox().join(<span class="literal">","</span>));
  objRef.stylesheet.setParameter(<span class="literal">"srs"</span>, objRef.model.getSRS());
  var s = objRef.stylesheet.transformNodeToString(layerNode);
  var tempNode = document.createElement(<span class="literal">"div"</span>);
  tempNode.innerHTML = s;
  var newSrc = tempNode.firstChild.firstChild.getAttribute(<span class="literal">"src"</span>); 

  objRef.imageStack.push(new Image());
  objRef.imageStack[objRef.imageStack.length-1].objRef = objRef;
  objRef.firstImageLoaded = true;
  
  ++objRef.layerCount;
  objRef.loadImgDiv(layerNode,newSrc,objRef.imageStack[objRef.imageStack.length-1]);
}

<span class="comment">/**
 * Removes a layer from the output
 * <span class="attrib">@param</span> layerName the WMS name for the layer to be removed
 */</span>
MapPane.<span class="reserved">prototype</span>.deleteLayer = <span class="reserved">function</span>(objRef, layerName) {
  var imgDivId = objRef.getLayerDivId(layerName); 
  
  var imgDiv = document.getElementById(imgDivId);
  var outputNode = document.getElementById( objRef.outputNodeId );
  outputNode.removeChild(imgDiv);
}

<span class="comment">/**
 * Moves a layer up in the stack of map layers
 * <span class="attrib">@param</span> layerName the WMS name for the layer to be moved up
 */</span>
MapPane.<span class="reserved">prototype</span>.moveLayerUp = <span class="reserved">function</span>(objRef, layerName) {
  var outputNode = document.getElementById( objRef.outputNodeId );
  var imgDivId = objRef.getLayerDivId(layerName); 
  var movedNode = document.getElementById(imgDivId);
  var sibNode = movedNode.nextSibling;
  <span class="reserved">if</span> (!sibNode) {
    alert(<span class="literal">"can't move node past beginning of list:"</span>+layerName);
    <span class="reserved">return</span>;
  }
  outputNode.insertBefore(sibNode,movedNode);
}

<span class="comment">/**
 * Moves a layer up in the stack of map layers
 * <span class="attrib">@param</span> layerName the WMS name for the layer to be moved down
 */</span>
MapPane.<span class="reserved">prototype</span>.moveLayerDown = <span class="reserved">function</span>(objRef, layerName) {
  var outputNode = document.getElementById( objRef.outputNodeId );
  var imgDivId = objRef.getLayerDivId(layerName); 
  var movedNode = document.getElementById(imgDivId);
  var sibNode = movedNode.previousSibling;
  <span class="reserved">if</span> (!sibNode) {
    alert(<span class="literal">"can't move node past end of list:"</span>+layerName);
    <span class="reserved">return</span>;
  }
  outputNode.insertBefore(movedNode,sibNode);
}

<span class="comment">/**
 * sets up the image div to be loaded.  Images are preloaded in the imageStack
 * array and replaced in the document DOM in the onload handler
 * <span class="attrib">@param</span> layerNode the context layer to be loaded
 * <span class="attrib">@param</span> newSrc the new URL to be used for the image
 * <span class="attrib">@param</span> newImg an HTML IMG object to pre-load the image in
 */</span>
MapPane.<span class="reserved">prototype</span>.loadImgDiv = <span class="reserved">function</span>(layerNode,newSrc,newImg) {
  var outputNode = document.getElementById( <span class="reserved">this</span>.outputNodeId );
  var layerName = layerNode.selectSingleNode(<span class="literal">"wmc:Name"</span>).firstChild.nodeValue;  
  var layerHidden = (layerNode.getAttribute(<span class="literal">"hidden"</span>)==1)?true:false;  
  var imageFormat = <span class="literal">"image/gif"</span>;
  var imageFormatNode = layerNode.selectSingleNode(<span class="literal">"wmc:FormatList/wmc:Format[@current='1']"</span>);  
  <span class="reserved">if</span> (imageFormatNode) imageFormat = imageFormatNode.firstChild.nodeValue;  
<span class="comment">
  //make sure there is an image DIV in the output node for this layer</span>
  var imgDivId = <span class="reserved">this</span>.getLayerDivId(layerName); 
  var imgDiv = document.getElementById(imgDivId);
  <span class="reserved">if</span> (!imgDiv) {
    imgDiv = document.createElement(<span class="literal">"div"</span>);
    imgDiv.setAttribute(<span class="literal">"id"</span>, imgDivId);
    imgDiv.style.position = <span class="literal">"absolute"</span>; 
    imgDiv.style.visibility = (layerHidden)?<span class="literal">"hidden"</span>:<span class="literal">"visible"</span>;
    imgDiv.style.top = <span class="literal">'0px'</span>; 
    imgDiv.style.left = <span class="literal">'0px'</span>;
    imgDiv.imgId = Math.random().toString(); 
    var domImg = document.createElement(<span class="literal">"img"</span>);
    domImg.id = <span class="literal">"real"</span>+imgDiv.imgId;
<span class="comment">    //domImg.src = this.loadingSrc;</span>
    domImg.src = config.skinDir+<span class="literal">"/images/Spacer.gif"</span>;
    domImg.layerHidden = layerHidden;
    imgDiv.appendChild(domImg);
    outputNode.appendChild(imgDiv);
  } <span class="reserved">else</span> {
<span class="comment">    // NB this assumes that the img element is the first child!?</span>
    var domImg = imgDiv.firstChild;
  }
<span class="comment">
  // preload image</span>
  newImg.id = imgDiv.imgId;
  newImg.hidden = layerHidden;
  newImg.fixPng = false;
  <span class="reserved">if</span> (_SARISSA_IS_IE &amp;&amp; imageFormat==<span class="literal">"image/png"</span>) newImg.fixPng = true;

  <span class="reserved">if</span>( <span class="reserved">this</span>.doNotPreload &amp;&amp; layerHidden ) {
<span class="comment">    // delay loading until visible</span>
    newImg.srcToLoad = newSrc;
    domImg.isLoading = false;
<span class="comment">    //alert( 'hiding: ' + newSrc + '\n' + this.loadingLayerCount + '/' + this.layerCount );</span>
  }
  <span class="reserved">else</span> {
<span class="comment">    // increment number of loading layers</span>
    ++<span class="reserved">this</span>.loadingLayerCount;
    var message = <span class="literal">"loading "</span> + <span class="reserved">this</span>.loadingLayerCount + <span class="literal">" map layer"</span> + ((<span class="reserved">this</span>.loadingLayerCount&gt;1)?<span class="literal">"s"</span>:<span class="literal">""</span>);
    <span class="reserved">this</span>.model.setParam(<span class="literal">"modelStatus"</span>, message);
<span class="comment">    // load now</span>
    newImg.onload = MapImgLoadHandler;
    newImg.src = newSrc;
    domImg.isLoading = true;
  }
}

<span class="comment">/**
* image onload handler function.
* Replaces the source with the new one and fixes the displacement to 
* compensate the container main div displacement to result in in a zero displacement.
* The first image to be returned will hide all other layers and re-position them
* and they are made visible when their onload event fires.
*/</span>
<span class="reserved">function</span> MapImgLoadHandler() {
  var oldImg = document.getElementById(<span class="literal">"real"</span>+<span class="reserved">this</span>.id );

  <span class="reserved">if</span> (!<span class="reserved">this</span>.objRef.firstImageLoaded) {
    <span class="reserved">this</span>.objRef.firstImageLoaded = true;
    var outputNode = document.getElementById( <span class="reserved">this</span>.objRef.outputNodeId );
    var siblingImageDivs = outputNode.childNodes;
    <span class="reserved">for</span> (var i=0; i&lt;siblingImageDivs.length ;++i) {
      var sibImg = siblingImageDivs[i].firstChild;
      sibImg.parentNode.style.visibility = <span class="literal">"hidden"</span>;
      sibImg.style.visibility = <span class="literal">"hidden"</span>;//Make sure <span class="reserved">for</span> IE that the child node is hidden as well
      <span class="reserved">if</span> (_SARISSA_IS_IE) sibImg.src = config.skinDir+<span class="literal">"/images/Spacer.gif"</span>;
    }
    <span class="reserved">if</span> (_SARISSA_IS_IE) siblingImageDivs[0].firstChild.parentNode.parentNode.style.visibility = <span class="literal">"hidden"</span>;
    outputNode.style.left=<span class="literal">'0px'</span>;
    outputNode.style.top=<span class="literal">'0px'</span>;
  }
<span class="comment">
  // decrement number of loading layers</span>
  --<span class="reserved">this</span>.objRef.loadingLayerCount;
  <span class="reserved">if</span> (<span class="reserved">this</span>.objRef.loadingLayerCount &gt; 0) {
    var message = <span class="literal">"loading "</span> + <span class="reserved">this</span>.objRef.loadingLayerCount + <span class="literal">" map layer"</span> + ((<span class="reserved">this</span>.objRef.loadingLayerCount&gt;1)?<span class="literal">"s"</span>:<span class="literal">""</span>);
    <span class="reserved">this</span>.objRef.model.setParam(<span class="literal">"modelStatus"</span>, message);
  } <span class="reserved">else</span> {
    <span class="reserved">this</span>.objRef.model.setParam(<span class="literal">"modelStatus"</span>);
  }

  <span class="reserved">if</span> (_SARISSA_IS_IE) oldImg.parentNode.parentNode.style.visibility = <span class="literal">"visible"</span>;
  <span class="reserved">if</span> (<span class="reserved">this</span>.fixPng) {
    var vis = oldImg.layerHidden?<span class="literal">"hidden"</span>:<span class="literal">"visible"</span>;
    oldImg.outerHTML = fixPNG(<span class="reserved">this</span>,<span class="literal">"real"</span>+<span class="reserved">this</span>.id);
    <span class="reserved">if</span> (!<span class="reserved">this</span>.hidden) {
      fixImg = document.getElementById(<span class="literal">"real"</span>+<span class="reserved">this</span>.id); // The result of fixPng is a span, so we need to set that particular element visible
      fixImg.style.visibility = <span class="literal">"visible"</span>
    }
  } <span class="reserved">else</span> {
    oldImg.src = <span class="reserved">this</span>.src;
    oldImg.width = <span class="reserved">this</span>.objRef.model.getWindowWidth();
    oldImg.height = <span class="reserved">this</span>.objRef.model.getWindowHeight();
    <span class="reserved">if</span> (!<span class="reserved">this</span>.hidden) {
      oldImg.parentNode.style.visibility = <span class="literal">"visible"</span>;
      oldImg.style.visibility = <span class="literal">"visible"</span>; //Make sure <span class="reserved">for</span> IE that the child node is visible as well
    }
  }
}

<span class="comment">/**
 * Sets up an image to be loaded. Used when images are not preloaded in the
 * image stack.
 * <span class="attrib">@param</span> objRef Pointer to widget object.
 * <span class="attrib">@param</span> layer Layer element.
 */</span>
<span class="reserved">function</span> MapImgLoad( objRef, layer ) {
  var imgId = layer.imgId;
  <span class="reserved">for</span>( var i = 0; i &lt; objRef.imageStack.length; i++ )
  {
    <span class="reserved">if</span>( objRef.imageStack[i].id == imgId ) {
<span class="comment">      // increment number of loading layers</span>
      ++objRef.loadingLayerCount;
      var message = <span class="literal">"loading "</span> + objRef.loadingLayerCount + <span class="literal">" map layer"</span> + ((objRef.loadingLayerCount&gt;1)?<span class="literal">"s"</span>:<span class="literal">""</span>);
      objRef.model.setParam(<span class="literal">"modelStatus"</span>, message);
      
      var newImg = objRef.imageStack[i];
      newImg.onload = MapImgLoadHandler;
      newImg.src = newImg.srcToLoad;
      newImg.hidden = false;
      var domImg = document.getElementById(<span class="literal">"real"</span>+imgId );
      domImg.isLoading = true;
      domImg.layerHidden = false;
      <span class="reserved">return</span>;
    }
  }
  alert( <span class="literal">'ERROR: image not found'</span> );
}

</pre>
	<hr>



<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<table border="0" width="100%" cellpadding="1" cellspacing="0">
<tr>
<td colspan=2 bgcolor="#EEEEFF" class="NavBarCell1">
<a name="navbar_top_firstrow"><!-- --></a>
<table border="0" cellpadding="0" cellspacing="3">
  <tr align="center" valign="top">
  
  
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-summary.html"><font class="NavBarFont1"><b>Overview</b></font></a>&nbsp;</td>
  <td bgcolor="#FFFFFF" class="NavBarCell1Rev">	&nbsp;<font class="NavBarFont1Rev"><b>File</b></font>&nbsp;</td>
  

  <td bgcolor="#FFFFFF" class="NavBarCell1"> <font class="NavBarFont1">Class</font>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-tree.html"><font class="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="index-all.html"--><font class="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="help-doc.html"><font class="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
  </tr>
</table>
</td>
<td bgcolor="#EEEEFF" align="right" valign="top"><em>
<b><a href='http://mapbuilder.sourceforge.net'>Community Map Builder</a> 22 Dec 2006</b></em>
</td>
</tr>

<tr>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
&nbsp;PREV&nbsp;
&nbsp;NEXT</font></td>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
  <a href="index.html" target="_top"><b>FRAMES</b></a>  &nbsp;
&nbsp;<a href="overview-summary.html" target="_top"><b>NO FRAMES</b></a>
&nbsp;&nbsp;
<script>
  <!--
  if(window==top) {
    document.writeln('<A HREF="allclasses-noframe.html" TARGET=""><B>All Classes</B></A>');
  }
  //-->
</script>
<noscript>
<a href="allclasses-noframe.html" target=""><b>All Classes</b></a>
</noscript>
</font></td>
</tr>
</table>
<!-- =========== END OF NAVBAR =========== -->

<hr>
<font size="-1">

</font>
<div class="jsdoc_ctime">Documentation generated by <a href="http://jsdoc.sourceforge.net/" target="_parent">JSDoc</a> on Fri Dec 22 07:58:58 2006</div>
</body>
</html>
