<!doctype html public "-//W3C//DTD HTML 4.0 Frameset//EN""http://www.w3.org/TR/REC-html40/frameset.dtd">
<html>
<head>
<title>
<a href='http://mapbuilder.sourceforge.net'>Community Map Builder</a> 22 Dec 2006 Overview
</title>
<link rel ="stylesheet" type="text/css" href="stylesheet.css" title="Style">
<script>
function asd() {
	
		parent.document.title="MapScaleBar.js Overview";
	
}
</script>
</head>
<body bgcolor="white" onload="asd();">

<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<table border="0" width="100%" cellpadding="1" cellspacing="0">
<tr>
<td colspan=2 bgcolor="#EEEEFF" class="NavBarCell1">
<a name="navbar_top_firstrow"><!-- --></a>
<table border="0" cellpadding="0" cellspacing="3">
  <tr align="center" valign="top">
  
  
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-summary.html"><font class="NavBarFont1"><b>Overview</b></font></a>&nbsp;</td>
  <td bgcolor="#FFFFFF" class="NavBarCell1Rev">	&nbsp;<font class="NavBarFont1Rev"><b>File</b></font>&nbsp;</td>
  

  <td bgcolor="#FFFFFF" class="NavBarCell1"> 	<font class="NavBarFont1">Class</font>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-tree.html"><font class="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="index-all.html"--><font class="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="help-doc.html"><font class="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
  </tr>
</table>
</td>
<td bgcolor="#EEEEFF" align="right" valign="top">
<em>
<b><a href='http://mapbuilder.sourceforge.net'>Community Map Builder</a> 22 Dec 2006</b></em>
</td>
</tr>

<tr>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
&nbsp;PREV&nbsp;
&nbsp;NEXT</font></td>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
  <a href="index.html" target="_top"><b>FRAMES</b></a>  &nbsp;
&nbsp;<a href="overview-summary.html" target="_top"><b>NO FRAMES</b></a>
&nbsp;&nbsp;
<script>
  <!--
  if(window==top) {
    document.writeln('<A HREF="allclasses-noframe.html" TARGET=""><B>All Classes</B></A>');
  }
  //-->
</script>
<noscript>
<a href="allclasses-noframe.html" target=""><b>All Classes</b></a>
</noscript>
</font></td>
</tr>
</table>
<!-- =========== END OF NAVBAR =========== -->

<hr>
<center>
	
	   <h2>MapScaleBar.js</h2>
	
</center>

	


<h4>Summary</h4>
<p>
	
		No overview generated for 'MapScaleBar.js'<BR/><BR/>
	
</p>

<hr>


    <table border="1" cellpadding="3" cellspacing="0" width="100%">
    <tr bgcolor="#CCCCFF" class="TableHeadingColor">
    <td colspan=2><font size="+2">
    
        <b>Class Summary</b>
    
    </font></td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="MapScaleBar.html">MapScaleBar</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    <tr bgcolor="white" class="TableRowColor">
    <td width="15%"><b><a href="HandsomeNumber.html">HandsomeNumber</a></b></td>
    <td>&nbsp;</td>
    </tr>
    
    </table>
    <hr/> 


<!-- ========== METHOD SUMMARY =========== -->

	<a name="method_summary"><!-- --></a>
	<table border="1" cellpadding="3" cellspacing="0" width="100%">
		<tr bgcolor="#CCCCFF" class="TableHeadingColor">
			<td colspan=2>
				<font size="+2">
					<b>Method Summary</b>
				</font>
			</td>
		</tr>
	
		
		   <tr bgcolor="white" class="TableRowColor">
		      <td align="right" valign="top" width="1%">
			 <font size="-1">
			    <code>static&nbsp;Object</code>
			 </font>
		      </td>
		      <td>
			 <code>
			    <b>
			       <a href="GLOBALS.html#formatNumber">formatNumber</a></b>(aNumber, numDecimals)
			 </code>
			 <br>
			 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			 
		      </td>
		   </tr>
		
		   <tr bgcolor="white" class="TableRowColor">
		      <td align="right" valign="top" width="1%">
			 <font size="-1">
			    <code>static&nbsp;Object</code>
			 </font>
		      </td>
		      <td>
			 <code>
			    <b>
			       <a href="GLOBALS.html#styleValue">styleValue</a></b>(aSelector, styleKey)
			 </code>
			 <br>
			 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			 
		      </td>
		   </tr>
		
	
	</table>
    <p>

<!-- ========== END METHOD SUMMARY =========== -->


        <pre class="sourceview"><span class="comment">/*
JavaScript Scalebar for MapServer (scalebar.js)

Copyright (c) 2005 Tim Schaub of CommEn Space (http://www.commenspace.org)

This is free software; you can redistribute it and/or modify it under
the terms of the GNU Lesser General Public License as published by the
Free Software Foundation; either version 2.1 of the License, or (at
your option) any later version.

This software is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Lesser General Public
License for more details.

You should have received a copy of the GNU Lesser General Public License
along with this software; if not, write to the Free Software Foundation,
Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA

v1.3 - scalebar is now centered on .sbWrapper div by default, more css control
     - reduced likelihood of displaying very large numbers
     - added condition to deal with <span class="attrib">@import</span> styles (thanks dokai)

*/</span>
<span class="comment">/*
adapted from http://mapserver.commenspace.org/tools/scalebar/

$Id: MapScaleBar.js 1851 2006-01-12 20:18:08Z madair $
*/</span>
<span class="comment">
// Ensure this object's dependancies are loaded.</span>
mapbuilder.loadScript(baseDir+<span class="literal">"/widget/WidgetBase.js"</span>);

<span class="comment">/**
 * Widget to display the scale of a map as a graphical bar.  The model of this widget
 * must have an extent object associated with it which is the case when the 
 * model has a MapContanier widget.
 *
 * <span class="attrib">@constructor</span>
 * <span class="attrib">@base</span> WidgetBase
 * <span class="attrib">@param</span> widgetNode  This widget's object node from the configuration document.
 * <span class="attrib">@param</span> model       The model that this widget is a view of.
 */</span>

<span class="reserved">function</span> MapScaleBar(widgetNode, model) {
  WidgetBase.apply(<span class="reserved">this</span>,new Array(widgetNode, model));
<span class="comment">
	// default properties</span>
<span class="comment">	// may be modified after construction</span>
<span class="comment">	// if modified after ScaleBar.place(), use ScaleBar.update()</span>
	<span class="reserved">this</span>.scaleDenominator = 1;    //<span class="reserved">this</span> will get updated on the first paint

	<span class="reserved">this</span>.displaySystem = <span class="literal">'metric'</span>; // metric or english supported
  var displaySystem = widgetNode.selectSingleNode(<span class="literal">"mb:displaySystem"</span>);
  <span class="reserved">if</span> (displaySystem) <span class="reserved">this</span>.displaySystem = displaySystem.firstChild.nodeValue;

	<span class="reserved">this</span>.minWidth = 100; // pixels
  var minWidth = widgetNode.selectSingleNode(<span class="literal">"mb:minWidth"</span>);
  <span class="reserved">if</span> (minWidth) <span class="reserved">this</span>.minWidth = minWidth.firstChild.nodeValue;

	<span class="reserved">this</span>.maxWidth = 200; // pixels
  var maxWidth = widgetNode.selectSingleNode(<span class="literal">"mb:maxWidth"</span>);
  <span class="reserved">if</span> (maxWidth) <span class="reserved">this</span>.maxWidth = maxWidth.firstChild.nodeValue;

	<span class="reserved">this</span>.divisions = 2;
  var divisions = widgetNode.selectSingleNode(<span class="literal">"mb:divisions"</span>);
  <span class="reserved">if</span> (divisions) <span class="reserved">this</span>.divisions = divisions.firstChild.nodeValue;

	<span class="reserved">this</span>.subdivisions = 2;
  var subdivisions = widgetNode.selectSingleNode(<span class="literal">"mb:subdivisions"</span>);
  <span class="reserved">if</span> (subdivisions) <span class="reserved">this</span>.subdivisions = subdivisions.firstChild.nodeValue;

	<span class="reserved">this</span>.showMinorMeasures = false;
  var showMinorMeasures = widgetNode.selectSingleNode(<span class="literal">"mb:showMinorMeasures"</span>);
  <span class="reserved">if</span> (showMinorMeasures &amp;&amp; showMinorMeasures.firstChild.nodeValue==<span class="literal">"true"</span>) <span class="reserved">this</span>.showMinorMeasures = true;

	<span class="reserved">this</span>.abbreviateLabel = false;
  var abbreviateLabel = widgetNode.selectSingleNode(<span class="literal">"mb:abbreviateLabel"</span>);
  <span class="reserved">if</span> (abbreviateLabel &amp;&amp; abbreviateLabel.firstChild.nodeValue==<span class="literal">"true"</span>) <span class="reserved">this</span>.abbreviateLabel = true;

	<span class="reserved">this</span>.singleLine = false;
  var singleLine = widgetNode.selectSingleNode(<span class="literal">"mb:singleLine"</span>);
  <span class="reserved">if</span> (singleLine &amp;&amp; singleLine.firstChild.nodeValue==<span class="literal">"true"</span>) <span class="reserved">this</span>.singleLine = true;

	<span class="reserved">this</span>.align = <span class="literal">'center'</span>; // left, center, or right supported
  var align = widgetNode.selectSingleNode(<span class="literal">"mb:align"</span>);
  <span class="reserved">if</span> (align) <span class="reserved">this</span>.align = align.firstChild.nodeValue;

	<span class="reserved">this</span>.resolution = 72; // dpi
<span class="comment">
	// create scalebar elements</span>
	<span class="reserved">this</span>.container = document.createElement(<span class="literal">'div'</span>);
	<span class="reserved">this</span>.container.className = <span class="literal">'sbWrapper'</span>;
	<span class="reserved">this</span>.container.style.position = <span class="literal">'relative'</span>;
	<span class="reserved">this</span>.container.setAttribute(<span class="literal">"id"</span>,<span class="reserved">this</span>.outputNodeId);
	<span class="reserved">this</span>.labelContainer = document.createElement(<span class="literal">'div'</span>);
	<span class="reserved">this</span>.labelContainer.className = <span class="literal">'sbUnitsContainer'</span>;
	<span class="reserved">this</span>.labelContainer.style.position = <span class="literal">'absolute'</span>;
	<span class="reserved">this</span>.graphicsContainer = document.createElement(<span class="literal">'div'</span>);
	<span class="reserved">this</span>.graphicsContainer.style.position = <span class="literal">'absolute'</span>;
	<span class="reserved">this</span>.graphicsContainer.className = <span class="literal">'sbGraphicsContainer'</span>;
	<span class="reserved">this</span>.numbersContainer = document.createElement(<span class="literal">'div'</span>);
	<span class="reserved">this</span>.numbersContainer.style.position = <span class="literal">'absolute'</span>;
	<span class="reserved">this</span>.numbersContainer.className = <span class="literal">'sbNumbersContainer'</span>;
<span class="comment">
	// private functions</span>
<span class="comment">	// put in some markers and bar pieces so style attributes can be grabbed</span>
<span class="comment">	// this is a solution for Safari support</span>
	var markerMajor = document.createElement(<span class="literal">'div'</span>);
	markerMajor.className = <span class="literal">'sbMarkerMajor'</span>;
	<span class="reserved">this</span>.graphicsContainer.appendChild(markerMajor);
	var markerMinor = document.createElement(<span class="literal">'div'</span>);
	markerMinor.className = <span class="literal">'sbMarkerMinor'</span>;
	<span class="reserved">this</span>.graphicsContainer.appendChild(markerMinor);
	var barPiece = document.createElement(<span class="literal">'div'</span>);
	barPiece.className = <span class="literal">'sbBar'</span>;
	<span class="reserved">this</span>.graphicsContainer.appendChild(barPiece);
	var barPieceAlt = document.createElement(<span class="literal">'div'</span>);
	barPieceAlt.className = <span class="literal">'sbBarAlt'</span>;
	<span class="reserved">this</span>.graphicsContainer.appendChild(barPieceAlt);

  <span class="comment">/**
   * adds a bbox listener on the model 
   */</span>
  <span class="reserved">this</span>.model.addListener(<span class="literal">"bbox"</span>, <span class="reserved">this</span>.update, <span class="reserved">this</span>);
  <span class="reserved">this</span>.model.addListener(<span class="literal">"refresh"</span>, <span class="reserved">this</span>.update, <span class="reserved">this</span>);
}

<span class="comment">/**
 * Render the widget.
 * <span class="attrib">@param</span> objRef Pointer to widget object.
 */</span>
MapScaleBar.<span class="reserved">prototype</span>.update = <span class="reserved">function</span>(objRef) {
<span class="comment">
  //create the output node the first time this is called</span>
  var outputNode = document.getElementById( objRef.outputNodeId );
  <span class="reserved">if</span> (!outputNode) objRef.node.appendChild(objRef.container);

  var scaleDenominator = objRef.model.extent.getScale()
	<span class="reserved">if</span>(scaleDenominator != null) {
		objRef.scaleDenominator = scaleDenominator;
	}
<span class="comment">	// local functions (and object constructors)</span>
	<span class="reserved">function</span> HandsomeNumber(smallUglyNumber, bigUglyNumber, sigFigs) {
		var sigFigs = (sigFigs == null) ? 10 : sigFigs;
		var bestScore = Number.POSITIVE_INFINITY;
		var bestTieBreaker = Number.POSITIVE_INFINITY;
<span class="comment">		// if all else fails, return a small ugly number</span>
		var handsomeValue = smallUglyNumber;
		var handsomeNumDec = 3;
<span class="comment">		// try the first three comely multiplicands (in order of comliness)</span>
		<span class="reserved">for</span>(var halvingExp = 0; halvingExp &lt; 3; ++halvingExp) {
			var comelyMultiplicand = Math.pow(2, (-1 * halvingExp));
			var maxTensExp = Math.floor(Math.log(bigUglyNumber / comelyMultiplicand) / Math.LN10)
			<span class="reserved">for</span>(var tensExp = maxTensExp; tensExp &gt; (maxTensExp - sigFigs + 1); --tensExp) {
				var numDec = Math.max(halvingExp - tensExp, 0);
				var testMultiplicand = comelyMultiplicand * Math.pow(10, tensExp);
<span class="comment">				// check if there is an integer multiple of testMultiplicand between smallUglyNumber and bigUglyNumber</span>
				<span class="reserved">if</span>((testMultiplicand * Math.floor(bigUglyNumber / testMultiplicand)) &gt;= smallUglyNumber) {
<span class="comment">					// check if smallUglyNumber is an integer multiple of testMultiplicand</span>
					<span class="reserved">if</span>(smallUglyNumber % testMultiplicand == 0) {
						var testMultiplier = smallUglyNumber / testMultiplicand;
					}
<span class="comment">					// otherwise go for the smallest integer multiple between small and big</span>
					<span class="reserved">else</span> {
						var testMultiplier = Math.floor(smallUglyNumber / testMultiplicand) + 1;
					}
<span class="comment">					// test against the best (lower == better)</span>
					var testScore = testMultiplier + (2 * halvingExp);
					var testTieBreaker = (tensExp &lt; 0) ? (Math.abs(tensExp) + 1) : tensExp;
					<span class="reserved">if</span>((testScore &lt; bestScore) || ((testScore == bestScore) &amp;&amp; (testTieBreaker &lt; bestTieBreaker))) {
						bestScore = testScore;
						bestTieBreaker = testTieBreaker;
						handsomeValue = (testMultiplicand * testMultiplier).toFixed(numDec);
						handsomeNumDec = numDec;
					}
				}
			}
		}
		<span class="reserved">this</span>.value = handsomeValue;
		<span class="reserved">this</span>.score = bestScore;
		<span class="reserved">this</span>.tieBreaker = bestTieBreaker;
		<span class="reserved">this</span>.numDec = handsomeNumDec;
	}
	HandsomeNumber.<span class="reserved">prototype</span>.toString = <span class="reserved">function</span>() {
		<span class="reserved">return</span> <span class="reserved">this</span>.value.toString();
	}
	HandsomeNumber.<span class="reserved">prototype</span>.valueOf = <span class="reserved">function</span>() {
		<span class="reserved">return</span> <span class="reserved">this</span>.value;
	}
	<span class="reserved">function</span> styleValue(aSelector, styleKey) {
<span class="comment">		// returns an integer value associated with a particular selector and key</span>
<span class="comment">		// given a stylesheet with .someSelector {border: 2px solid red}</span>
<span class="comment">		// styleValue('.someSelector', 'borderWidth') returns 2</span>
		var aValue = 0;
		<span class="reserved">if</span>(document.styleSheets) {
			<span class="reserved">for</span>(var sheetIndex = document.styleSheets.length - 1; sheetIndex &gt;= 0; --sheetIndex) {
				var aSheet = document.styleSheets[sheetIndex];
				<span class="reserved">if</span>(!aSheet.disabled) {
					var allRules;
					<span class="reserved">if</span>(typeof(aSheet.cssRules) == <span class="literal">'undefined'</span>) {
						<span class="reserved">if</span>(typeof(aSheet.rules) == <span class="literal">'undefined'</span>) {
<span class="comment">							// can't get rules, assume zero</span>
							<span class="reserved">return</span> 0;
						}
						<span class="reserved">else</span> {
							allRules = aSheet.rules;
						}
					}
					<span class="reserved">else</span> {
						allRules = aSheet.cssRules;
					}
					<span class="reserved">for</span>(var ruleIndex = 0; ruleIndex &lt; allRules.length; ++ruleIndex) {
						var aRule = allRules[ruleIndex];
						<span class="reserved">if</span>(aRule.selectorText &amp;&amp; (aRule.selectorText.toLowerCase() == aSelector.toLowerCase())) {
							<span class="reserved">if</span>(aRule.style[styleKey] != <span class="literal">''</span>) {
								aValue = parseInt(aRule.style[styleKey]);
							}
						}
					}
				}
			}
		}
<span class="comment">		// if the styleKey was not found, the equivalent value is zero</span>
		<span class="reserved">return</span> aValue ? aValue : 0;
	}
	<span class="reserved">function</span> formatNumber(aNumber, numDecimals) {
		numDecimals = (numDecimals) ? numDecimals : 0;
		var formattedInteger = <span class="literal">''</span> + Math.round(aNumber);
		var thousandsPattern = /(-?[0-9]+)([0-9]{3})/;
		<span class="reserved">while</span>(thousandsPattern.test(formattedInteger)) {
			formattedInteger = formattedInteger.replace(thousandsPattern, <span class="literal">'$1,$2'</span>);
		}
		<span class="reserved">if</span>(numDecimals &gt; 0) {
			var formattedDecimal = Math.floor(Math.pow(10, numDecimals) * (aNumber - Math.round(aNumber)));
			<span class="reserved">if</span>(formattedDecimal == 0) {
				<span class="reserved">return</span> formattedInteger;
			}
			<span class="reserved">else</span> {
				<span class="reserved">return</span> formattedInteger + <span class="literal">'.'</span> + formattedDecimal;
			}
		}
		<span class="reserved">else</span> {
			<span class="reserved">return</span> formattedInteger;
		}
	}
<span class="comment">	// update the container title (for displaying scale as a tooltip)</span>
	objRef.container.title = <span class="literal">'scale 1:'</span> + formatNumber(objRef.scaleDenominator);
<span class="comment">	// measurementProperties holds display units, abbreviations,</span>
<span class="comment">	// and conversion to inches (since we're using dpi) - per measurement sytem</span>
	var measurementProperties = new Object();
	measurementProperties.english = {
		units: [<span class="literal">'miles'</span>, <span class="literal">'feet'</span>, <span class="literal">'inches'</span>],
		abbr: [<span class="literal">'mi'</span>, <span class="literal">'ft'</span>, <span class="literal">'in'</span>],
		inches: [63360, 12, 1]
	}
	measurementProperties.metric = {
		units: [<span class="literal">'kilometers'</span>, <span class="literal">'meters'</span>, <span class="literal">'centimeters'</span>],
		abbr: [<span class="literal">'km'</span>, <span class="literal">'m'</span>, <span class="literal">'cm'</span>],
		inches: [39370.07874, 39.370079, 0.393701]
	}
<span class="comment">	// check each measurement unit in the display system</span>
	var comparisonArray = new Array();
	<span class="reserved">for</span>(var unitIndex = 0; unitIndex &lt; measurementProperties[objRef.displaySystem].units.length; ++unitIndex) {
		comparisonArray[unitIndex] = new Object();
		var pixelsPerDisplayUnit = objRef.resolution * measurementProperties[objRef.displaySystem].inches[unitIndex] / objRef.scaleDenominator;
		var minSDDisplayLength = (objRef.minWidth / pixelsPerDisplayUnit) / (objRef.divisions * objRef.subdivisions);
		var maxSDDisplayLength = (objRef.maxWidth / pixelsPerDisplayUnit) / (objRef.divisions * objRef.subdivisions);
<span class="comment">		// add up scores for each marker (even if numbers aren't displayed)</span>
		<span class="reserved">for</span>(var valueIndex = 0; valueIndex &lt; (objRef.divisions * objRef.subdivisions); ++valueIndex) {
			var minNumber = minSDDisplayLength * (valueIndex + 1);
			var maxNumber = maxSDDisplayLength * (valueIndex + 1);
			var niceNumber = new HandsomeNumber(minNumber, maxNumber);
			comparisonArray[unitIndex][valueIndex] = {value: (niceNumber.value / (valueIndex + 1)), score: 0, tieBreaker: 0, numDec: 0, displayed: 0};
<span class="comment">			// now tally up scores for all values given this subdivision length</span>
			<span class="reserved">for</span>(var valueIndex2 = 0; valueIndex2 &lt; (objRef.divisions * objRef.subdivisions); ++valueIndex2) {
				displayedValuePosition = niceNumber.value * (valueIndex2 + 1) / (valueIndex + 1);
				niceNumber2 = new HandsomeNumber(displayedValuePosition, displayedValuePosition);
				var isMajorMeasurement = ((valueIndex2 + 1) % objRef.subdivisions == 0);
				var isLastMeasurement = ((valueIndex2 + 1) == (objRef.divisions * objRef.subdivisions));
				<span class="reserved">if</span>((objRef.singleLine &amp;&amp; isLastMeasurement) || (!objRef.singleLine &amp;&amp; (isMajorMeasurement || objRef.showMinorMeasures))) {
<span class="comment">					// count scores for displayed marker measurements</span>
					comparisonArray[unitIndex][valueIndex].score += niceNumber2.score;
					comparisonArray[unitIndex][valueIndex].tieBreaker += niceNumber2.tieBreaker;
					comparisonArray[unitIndex][valueIndex].numDec = Math.max(comparisonArray[unitIndex][valueIndex].numDec, niceNumber2.numDec);
					comparisonArray[unitIndex][valueIndex].displayed += 1;
				}
				<span class="reserved">else</span> {
<span class="comment">					// count scores for non-displayed marker measurements</span>
					comparisonArray[unitIndex][valueIndex].score += niceNumber2.score / objRef.subdivisions;
					comparisonArray[unitIndex][valueIndex].tieBreaker += niceNumber2.tieBreaker / objRef.subdivisions;
				}
			}
<span class="comment">			// adjust scores so numbers closer to 1 are preferred for display</span>
			var scoreAdjustment = (unitIndex + 1) * comparisonArray[unitIndex][valueIndex].tieBreaker / comparisonArray[unitIndex][valueIndex].displayed;
			comparisonArray[unitIndex][valueIndex].score *= scoreAdjustment;
		}
	}
<span class="comment">	// get the value (subdivision length) with the lowest cumulative score</span>
	var subdivisionDisplayLength = null;
	var displayUnits = null;
	var displayUnitsAbbr = null;
	var subdivisionPixelLength = null;
	var bestScore = Number.POSITIVE_INFINITY;
	var bestTieBreaker = Number.POSITIVE_INFINITY;
	var numDec = 0;
	<span class="reserved">for</span>(var unitIndex = 0; unitIndex &lt; comparisonArray.length; ++unitIndex) {
		<span class="reserved">for</span>(valueIndex in comparisonArray[unitIndex]) {
			<span class="reserved">if</span>((comparisonArray[unitIndex][valueIndex].score &lt; bestScore) || ((comparisonArray[unitIndex][valueIndex].score == bestScore) &amp;&amp; (comparisonArray[unitIndex][valueIndex].tieBreaker &lt; bestTieBreaker))) {
				bestScore = comparisonArray[unitIndex][valueIndex].score;
				bestTieBreaker = comparisonArray[unitIndex][valueIndex].tieBreaker;
				subdivisionDisplayLength = comparisonArray[unitIndex][valueIndex].value;
				numDec = comparisonArray[unitIndex][valueIndex].numDec;
				displayUnits = measurementProperties[objRef.displaySystem].units[unitIndex];
				displayUnitsAbbr = measurementProperties[objRef.displaySystem].abbr[unitIndex];
				pixelsPerDisplayUnit = objRef.resolution * measurementProperties[objRef.displaySystem].inches[unitIndex] / objRef.scaleDenominator;
				subdivisionPixelLength = pixelsPerDisplayUnit * subdivisionDisplayLength; // round before use in style
			}
		}
	}
<span class="comment">	// determine offsets for graphic elements</span>
	var xOffsetMarkerMajor = (styleValue(<span class="literal">'.sbMarkerMajor'</span>, <span class="literal">'borderLeftWidth'</span>) + styleValue(<span class="literal">'.sbMarkerMajor'</span>, <span class="literal">'width'</span>) + styleValue(<span class="literal">'.sbMarkerMajor'</span>, <span class="literal">'borderRightWidth'</span>)) / 2;
	var xOffsetMarkerMinor = (styleValue(<span class="literal">'.sbMarkerMinor'</span>, <span class="literal">'borderLeftWidth'</span>) + styleValue(<span class="literal">'.sbMarkerMinor'</span>, <span class="literal">'width'</span>) + styleValue(<span class="literal">'.sbMarkerMinor'</span>, <span class="literal">'borderRightWidth'</span>)) / 2;
	var xOffsetBar = (styleValue(<span class="literal">'.sbBar'</span>, <span class="literal">'borderLeftWidth'</span>) + styleValue(<span class="literal">'.sbBar'</span>, <span class="literal">'border-right-width'</span>)) / 2;
	var xOffsetBarAlt = (styleValue(<span class="literal">'.sbBarAlt'</span>, <span class="literal">'borderLeftWidth'</span>) + styleValue(<span class="literal">'.sbBarAlt'</span>, <span class="literal">'borderRightWidth'</span>)) / 2;
<span class="comment">	// support for browsers without the Document.styleSheets property (Opera)</span>
	<span class="reserved">if</span>(!document.styleSheets) {
<span class="comment">		// this is a two part hack, one for the offsets here and one for the css below</span>
		xOffsetMarkerMajor = 0.5;
		xOffsetMarkerMinor = 0.5;
	}
<span class="comment">	// clean out any old content from containers</span>
	<span class="reserved">while</span>(objRef.labelContainer.hasChildNodes()) {
		objRef.labelContainer.removeChild(objRef.labelContainer.firstChild);
	}
	<span class="reserved">while</span>(objRef.graphicsContainer.hasChildNodes()) {
		objRef.graphicsContainer.removeChild(objRef.graphicsContainer.firstChild);
	}
	<span class="reserved">while</span>(objRef.numbersContainer.hasChildNodes()) {
		objRef.numbersContainer.removeChild(objRef.numbersContainer.firstChild);
	}
<span class="comment">	// create all divisions</span>
	var aMarker, aBarPiece, numbersBox, xOffset;
	var alignmentOffset = {
		left: 0,
		center: (-1 * objRef.divisions * objRef.subdivisions * subdivisionPixelLength / 2),
		right: (-1 * objRef.divisions * objRef.subdivisions * subdivisionPixelLength)
	}
	var xPosition = 0 + alignmentOffset[objRef.align];
	var markerMeasure = 0;
	<span class="reserved">for</span>(var divisionIndex = 0; divisionIndex &lt; objRef.divisions; ++divisionIndex) {
<span class="comment">		// set xPosition and markerMeasure to start of division</span>
		xPosition = divisionIndex * objRef.subdivisions * subdivisionPixelLength;
		xPosition += alignmentOffset[objRef.align];
		markerMeasure = (divisionIndex == 0) ? 0 : ((divisionIndex * objRef.subdivisions) * subdivisionDisplayLength).toFixed(numDec);
<span class="comment">		// add major marker</span>
		aMarker = document.createElement(<span class="literal">'div'</span>);
		aMarker.className = <span class="literal">'sbMarkerMajor'</span>;
		aMarker.style.position = <span class="literal">'absolute'</span>;
		aMarker.style.overflow = <span class="literal">'hidden'</span>;
		aMarker.style.left = Math.round(xPosition - xOffsetMarkerMajor) + <span class="literal">'px'</span>;
		aMarker.appendChild(document.createTextNode(<span class="literal">' '</span>));
		objRef.graphicsContainer.appendChild(aMarker);
<span class="comment">		// add initial measure</span>
		<span class="reserved">if</span>(!objRef.singleLine) {
			numbersBox = document.createElement(<span class="literal">'div'</span>);
			numbersBox.className = <span class="literal">'sbNumbersBox'</span>;
			numbersBox.style.position = <span class="literal">'absolute'</span>;
			numbersBox.style.overflow = <span class="literal">'hidden'</span>;
			numbersBox.style.textAlign = <span class="literal">'center'</span>;
			<span class="reserved">if</span>(objRef.showMinorMeasures) {
				numbersBox.style.width = Math.round(subdivisionPixelLength * 2) + <span class="literal">'px'</span>;
				numbersBox.style.left = Math.round(xPosition - subdivisionPixelLength) + <span class="literal">'px'</span>;
			}
			<span class="reserved">else</span> {
				numbersBox.style.width = Math.round(objRef.subdivisions * subdivisionPixelLength * 2) + <span class="literal">'px'</span>;
				numbersBox.style.left = Math.round(xPosition - (objRef.subdivisions * subdivisionPixelLength)) + <span class="literal">'px'</span>;
			}
			numbersBox.appendChild(document.createTextNode(markerMeasure));
			objRef.numbersContainer.appendChild(numbersBox);
		}
<span class="comment">		// create all subdivisions</span>
		<span class="reserved">for</span>(var subdivisionIndex = 0; subdivisionIndex &lt; objRef.subdivisions; ++subdivisionIndex) {
			aBarPiece = document.createElement(<span class="literal">'div'</span>);
			aBarPiece.style.position = <span class="literal">'absolute'</span>;
			aBarPiece.style.overflow = <span class="literal">'hidden'</span>;
			aBarPiece.style.width = Math.round(subdivisionPixelLength) + <span class="literal">'px'</span>;
			<span class="reserved">if</span>((subdivisionIndex % 2) == 0) {
				aBarPiece.className = <span class="literal">'sbBar'</span>;
				aBarPiece.style.left = Math.round(xPosition - xOffsetBar) + <span class="literal">'px'</span>;
			}
			<span class="reserved">else</span> {
				aBarPiece.className = <span class="literal">'sbBarAlt'</span>;
				aBarPiece.style.left = Math.round(xPosition - xOffsetBarAlt) + <span class="literal">'px'</span>;
			}
			aBarPiece.appendChild(document.createTextNode(<span class="literal">' '</span>));
			objRef.graphicsContainer.appendChild(aBarPiece);
<span class="comment">			// add minor marker if not the last subdivision</span>
			<span class="reserved">if</span>(subdivisionIndex &lt; (objRef.subdivisions - 1)) {
<span class="comment">				// set xPosition and markerMeasure to end of subdivision</span>
				xPosition = ((divisionIndex * objRef.subdivisions) + (subdivisionIndex + 1)) * subdivisionPixelLength;
				xPosition += alignmentOffset[objRef.align];
				markerMeasure = (divisionIndex * objRef.subdivisions + subdivisionIndex + 1) * subdivisionDisplayLength;
				aMarker = document.createElement(<span class="literal">'div'</span>);
				aMarker.className = <span class="literal">'sbMarkerMinor'</span>;
				aMarker.style.position = <span class="literal">'absolute'</span>;
				aMarker.style.overflow = <span class="literal">'hidden'</span>;
				aMarker.style.left = Math.round(xPosition - xOffsetMarkerMinor) + <span class="literal">'px'</span>;
				aMarker.appendChild(document.createTextNode(<span class="literal">' '</span>));
				objRef.graphicsContainer.appendChild(aMarker);
				<span class="reserved">if</span>(objRef.showMinorMeasures &amp;&amp; !objRef.singleLine) {
<span class="comment">					// add corresponding measure</span>
					numbersBox = document.createElement(<span class="literal">'div'</span>);
					numbersBox.className = <span class="literal">'sbNumbersBox'</span>;
					numbersBox.style.position = <span class="literal">'absolute'</span>;
					numbersBox.style.overflow = <span class="literal">'hidden'</span>;
					numbersBox.style.textAlign = <span class="literal">'center'</span>;
					numbersBox.style.width = Math.round(subdivisionPixelLength * 2) + <span class="literal">'px'</span>;
					numbersBox.style.left = Math.round(xPosition - subdivisionPixelLength) + <span class="literal">'px'</span>;
					numbersBox.appendChild(document.createTextNode(markerMeasure));
					objRef.numbersContainer.appendChild(numbersBox);
				}
			}
		}
	}
<span class="comment">	// set xPosition and markerMeasure to end of divisions</span>
	xPosition = (objRef.divisions * objRef.subdivisions) * subdivisionPixelLength;
	xPosition += alignmentOffset[objRef.align];
	markerMeasure = ((objRef.divisions * objRef.subdivisions) * subdivisionDisplayLength).toFixed(numDec);
<span class="comment">	// add the final major marker</span>
	aMarker = document.createElement(<span class="literal">'div'</span>);
	aMarker.className = <span class="literal">'sbMarkerMajor'</span>;
	aMarker.style.position = <span class="literal">'absolute'</span>;
	aMarker.style.overflow = <span class="literal">'hidden'</span>;
	aMarker.style.left = Math.round(xPosition - xOffsetMarkerMajor) + <span class="literal">'px'</span>;
	aMarker.appendChild(document.createTextNode(<span class="literal">' '</span>));
	objRef.graphicsContainer.appendChild(aMarker);
<span class="comment">	// add final measure</span>
	<span class="reserved">if</span>(!objRef.singleLine) {
		numbersBox = document.createElement(<span class="literal">'div'</span>);
		numbersBox.className = <span class="literal">'sbNumbersBox'</span>;
		numbersBox.style.position = <span class="literal">'absolute'</span>;
		numbersBox.style.overflow = <span class="literal">'hidden'</span>;
		numbersBox.style.textAlign = <span class="literal">'center'</span>;
		<span class="reserved">if</span>(objRef.showMinorMeasures) {
			numbersBox.style.width = Math.round(subdivisionPixelLength * 2) + <span class="literal">'px'</span>;
			numbersBox.style.left = Math.round(xPosition - subdivisionPixelLength) + <span class="literal">'px'</span>;
		}
		<span class="reserved">else</span> {
			numbersBox.style.width = Math.round(objRef.subdivisions * subdivisionPixelLength * 2) + <span class="literal">'px'</span>;
			numbersBox.style.left = Math.round(xPosition - (objRef.subdivisions * subdivisionPixelLength)) + <span class="literal">'px'</span>;
		}
		numbersBox.appendChild(document.createTextNode(markerMeasure));
		objRef.numbersContainer.appendChild(numbersBox);
	}
<span class="comment">	// add content to the label container</span>
	var labelBox = document.createElement(<span class="literal">'div'</span>);
	labelBox.style.position = <span class="literal">'absolute'</span>;
	var labelText;
	<span class="reserved">if</span>(objRef.singleLine) {
		labelText = markerMeasure;
		labelBox.className = <span class="literal">'sbLabelBoxSingleLine'</span>;
		labelBox.style.top = <span class="literal">'-0.6em'</span>;
		labelBox.style.left = (xPosition + 10) + <span class="literal">'px'</span>;
	}
	<span class="reserved">else</span> {
		labelText = <span class="literal">''</span>;
		labelBox.className = <span class="literal">'sbLabelBox'</span>;
		labelBox.style.textAlign = <span class="literal">'center'</span>;
		labelBox.style.width = Math.round(objRef.divisions * objRef.subdivisions * subdivisionPixelLength) + <span class="literal">'px'</span>
		labelBox.style.left = Math.round(alignmentOffset[objRef.align]) + <span class="literal">'px'</span>;
		labelBox.style.overflow = <span class="literal">'hidden'</span>;
	}
	<span class="reserved">if</span>(objRef.abbreviateLabel) {
		labelText += <span class="literal">' '</span> + displayUnitsAbbr;
	}
	<span class="reserved">else</span> {
		labelText += <span class="literal">' '</span> + displayUnits;
	}
	labelBox.appendChild(document.createTextNode(labelText));
	objRef.labelContainer.appendChild(labelBox);
<span class="comment">	// support for browsers without the Document.styleSheets property (Opera)</span>
	<span class="reserved">if</span>(!document.styleSheets) {
<span class="comment">		// override custom css with default</span>
		var defaultStyle = document.createElement(<span class="literal">'style'</span>);
		defaultStyle.type = <span class="literal">'text/css'</span>;
		var styleText = <span class="literal">'.sbBar {top: 0px; background: #666666; height: 1px; border: 0;}'</span>;
		styleText += <span class="literal">'.sbBarAlt {top: 0px; background: #666666; height: 1px; border: 0;}'</span>;
		styleText += <span class="literal">'.sbMarkerMajor {height: 7px; width: 1px; background: #666666; border: 0;}'</span>;
		styleText += <span class="literal">'.sbMarkerMinor {height: 5px; width: 1px; background: #666666; border: 0;}'</span>;
		styleText += <span class="literal">'.sbLabelBox {top: -16px;}'</span>;
		styleText += <span class="literal">'.sbNumbersBox {top: 7px;}'</span>;
		defaultStyle.appendChild(document.createTextNode(styleText));
		document.getElementsByTagName(<span class="literal">'head'</span>).item(0).appendChild(defaultStyle);
	}
<span class="comment">	// append the child containers to the parent container</span>
	objRef.container.appendChild(objRef.graphicsContainer);
	objRef.container.appendChild(objRef.labelContainer);
	objRef.container.appendChild(objRef.numbersContainer);
}
</pre>
	<hr>



<!-- ========== START OF NAVBAR ========== -->
<a name="navbar_top"><!-- --></a>
<table border="0" width="100%" cellpadding="1" cellspacing="0">
<tr>
<td colspan=2 bgcolor="#EEEEFF" class="NavBarCell1">
<a name="navbar_top_firstrow"><!-- --></a>
<table border="0" cellpadding="0" cellspacing="3">
  <tr align="center" valign="top">
  
  
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-summary.html"><font class="NavBarFont1"><b>Overview</b></font></a>&nbsp;</td>
  <td bgcolor="#FFFFFF" class="NavBarCell1Rev">	&nbsp;<font class="NavBarFont1Rev"><b>File</b></font>&nbsp;</td>
  

  <td bgcolor="#FFFFFF" class="NavBarCell1"> <font class="NavBarFont1">Class</font>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="overview-tree.html"><font class="NavBarFont1"><b>Tree</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="index-all.html"--><font class="NavBarFont1"><b>Index</b></font></a>&nbsp;</td>
  <td bgcolor="#EEEEFF" class="NavBarCell1">    <a href="help-doc.html"><font class="NavBarFont1"><b>Help</b></font></a>&nbsp;</td>
  </tr>
</table>
</td>
<td bgcolor="#EEEEFF" align="right" valign="top"><em>
<b><a href='http://mapbuilder.sourceforge.net'>Community Map Builder</a> 22 Dec 2006</b></em>
</td>
</tr>

<tr>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
&nbsp;PREV&nbsp;
&nbsp;NEXT</font></td>
<td bgcolor="white" class="NavBarCell2"><font size="-2">
  <a href="index.html" target="_top"><b>FRAMES</b></a>  &nbsp;
&nbsp;<a href="overview-summary.html" target="_top"><b>NO FRAMES</b></a>
&nbsp;&nbsp;
<script>
  <!--
  if(window==top) {
    document.writeln('<A HREF="allclasses-noframe.html" TARGET=""><B>All Classes</B></A>');
  }
  //-->
</script>
<noscript>
<a href="allclasses-noframe.html" target=""><b>All Classes</b></a>
</noscript>
</font></td>
</tr>
</table>
<!-- =========== END OF NAVBAR =========== -->

<hr>
<font size="-1">

</font>
<div class="jsdoc_ctime">Documentation generated by <a href="http://jsdoc.sourceforge.net/" target="_parent">JSDoc</a> on Fri Dec 22 07:58:58 2006</div>
</body>
</html>
