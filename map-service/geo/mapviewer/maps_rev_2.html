<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">      
<html xmlns="http://www.w3.org/1999/xhtml" >
<head>
    <title>Geoplatform MNCN - Map viewer (prototype)</title>
<script src="OpenLayers.js"></script>
<script src='http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAAqe8Fn1ofjzKv4lcSjXFNgBSlvuso6rD9neEFLR9DQDEneTRHBxRjhqCrSwUpbHDMmm_dU5-LYcsMjA'>
	
</script>
<!--<script src='http://dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=6.2'></script>-->
<script src="http://api.maps.yahoo.com/ajaxymap?v=3.0&amp;appid=euzuro-openlayers"></script>
<script src="proj4js/lib/proj4js.js"></script>
<script src="js_code/xslt_jquery.js" type="text/javascript"></script>

<script type="text/javascript" src="js_code/LoadingPanel.js"></script>
      <script src="js_code/wfs.js"></script>

<script src="jquery-1.3.2.js"></script>
	<script type="text/javascript" src="js_code/main_rev_1_b.js"></script>

	<script type="text/javascript" src="js_code/ajaxfileupload.js"></script>
	
<!--		<script type="text/javascript" src="js_code/jquery.browser.js"></script>	-->
	 <link rel='StyleSheet' type='text/css' href='../lib/skin/default/scalebar-fat.css'><!-- This style sheet is needed for the scalebar -->
<link rel="stylesheet" href="theme/default/style2.css" type="text/css">
	<link rel="stylesheet" href="theme/default/style_ppol.css" type="text/css">

	<link type="text/css" rel="stylesheet" media="all" href="css/edit_test.css">
		<link type="text/css" rel="stylesheet" media="all" href="css/lightbox.css">
	<script type="text/javascript" src="js_code/farbtastic/farbtastic.js"></script>
	<link type="text/css" rel="stylesheet" media="all" href="css/farbtastic.css">
	<link type="text/css" rel="stylesheet" media="all" href="css/tables.css">


	  
<!--	    <script src='http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAAqe8Fn1ofjzKv4lcSjXFNgBQANB-jEXPKQoPExP6Dsdx9XLLhABQImhyd1eYId-LpCS7YXTYQgi96DQ'></script>-->
	    <script type="text/javascript">
	    var third,fourth;
	    function osm_getTileURL(bounds) {
	            var res = this.map.getResolution();
	            var x = Math.round((bounds.left - this.maxExtent.left) / (res * this.tileSize.w));
	            var y = Math.round((this.maxExtent.top - bounds.top) / (res * this.tileSize.h));
	            var z = this.map.getZoom();
	            var limit = Math.pow(2, z);

	            if (y < 0 || y >= limit) {
	                return OpenLayers.Util.getImagesLocation() + "404.png";
	            } else {
	                x = ((x % limit) + limit) % limit;
	                return this.url + z + "/" + x + "/" + y + "." + this.type;
	            }
	        }


var initial_g_sld,initial_sp_sld,initial_4th_sld;	    
var reprojecting=false;
var create_json=function(reprojecting)
{

var array=Array();

for (i=0;i<map.layers.length;i++)
{


//if(map.layers[i].params.GROUP !='remote' || map.layers[i].options.GROUP=='remote')
if(map.layers[i].GROUP !='commercial' && map.layers[i].options.GROUP !=='remote' && map.layers[i].params.GROUP !='remote' && map.layers[i].params.GROUP !='points'  && map.layers[i].params.GROUP !='analysis')
{
if (map.layers[i].getVisibility())
{

var g=map.layers[i].params.GROUP;
var l=map.layers[i].params.LAYERS.split(',');


var labels=Array();
labels[g]=Array();
var layers=Array();
layers[g]=Array();

$(l).each(function(i,data)
{


if (data!=='blank')
{

p=$("#layers input[id='"+data+"']").next().get(0);

if (g=='quadricules')
{
	switch (data)
	{
		case 'grid2_pol': label="2 degrees grid";
		 	  labels[g].push("negro");
			layers[g].push(data);
		      break;
		default: break;
		
	}

}
else
{
	l=p.firstChild;

	label=l.nodeValue;
	labels[g].push(label);	
	layers[g].push(data);
}

}
})


array[g]=layers[g]+"|"+map.layers[i].params.STYLES+"|"+labels[g];


}
}
}
x=array.join(',');
//array['grup']=x;

//console.info(array['remote'])
vals="";
for (key in array)
{
//console.log("for key "+key+"values  "+array[key])
vals+=key+">"+array[key]+"/";
}
//console.warn(vals);
//removing last '/'
var bbox=map.getExtent().toBBOX();
vals=vals.substring(0,vals.length-1);
zoom=map.getZoomForExtent(bounds2);
$.get('http://edit.africamuseum.be/edit_wp5/geo/c_json.php?data='+vals+'&bbox='+bbox+'&zoom='+zoom,function(d)
{

if (reprojecting==false)
{

	  var iframe=$('iframe#info2');

	 jq_print='<iframe id="info2" name="nom_iframe" class="jqDrag" marginWidth=0 marginHeight=0 src="" frameBorder=0 width=0 height=0></iframe>';

		$('#ex_print').html(jq_print);
			$('#ex_print').jqDrag('.jqDrag').jqResize('.jqResize') ;

		$("iframe#info2").attr("src","http://edit.africamuseum.be/edit_wp5/geo/json_show.php?file="+d);
		$("#ex_print").show();
		$("#ex_print").hide();
}
else
{


getlayers2(d,"EPSG:"+proj2);

}
											
});

}


var print;

function print_legend ()
{
var tot="";
x=new Array();
i_count=$("#images img").size();

$("#images img").each(function(i,d)
{
var height=$(d).css('height');

if (height!=='0px' && height!=='0pt' )
{
if (d.id !=='num_regs' && d.id !=='num_genus' && d.id !=='taxa_record')
{
var style=d.getAttribute("s");
total=style+","+d.id+"|";
tot+=total;
}
}
})


 var iframe=$('iframe#info2');
			var jq_print="<div class='jqmdTL' style='background-size: 0%; z-index: 300;'><div class='jqmdTR><div class='jqmdTC jqDrag'>PRINT IT</div><inputsrc='JQ_win_files/close.gif' class='jqmdX jqmClose' ></div></div>"; 
		 jq_print+="<iframe id='info2' class='jqDrag' marginWidth=0 marginHeight=0 src='' frameBorder='0' width='0' height='0'></iframe>";

var bindFrameActions=function () {
		$('#ex_print').html(jq_print);
	
			$('#ex_print')
			   .jqDrag('.jqDrag')
			   .jqResize('.jqResize') ;
		};
$.get('http://edit.africamuseum.be/edit_wp5/geo/general_legend.php?data='+tot,
		function(url_image)
										{
									
										bindFrameActions();
										$("iframe#info2").attr("src",url_image);$("#ex_print").show(); 
										$("#ex_print").hide(); 
										});

}
function c_legend(data)
{
//console.log(data);
var style=data.getAttribute("stylez");
var grup=data.getAttribute("grup");

if (data.checked)
{
if (grup=="tdwg" || grup=="quadricules" || grup=="utm")
		{		
if (grup=="utm"){h='40px'}else{h='20px'}
		$("#layers li[id='"+grup+"'] input").each(function(i,d)
		{
		if ($("#images img[id='"+d.id+"']").length)
		{
		$("#images img[id='"+d.id+"']").height(0).hide();
		}
		if ($("#images img[id='"+data.id+"']").length)
		{
		$("#images img[id='"+data.id+"']").height(h).show();
		}else {
		if (grup=="quadricules") { 
		style=style+"_2";
		}

		path="http://193.190.223.53:8080/geoserver/wms/GetLegendGraphic?VERSION=1.0.0&FORMAT=image/png";
		path+="&LAYER="+data.id+"&STYLE="+style+"&LEGEND_OPTIONS=forceLabels:on;fontStyle:italic;fontSize:12";
		html='<ul><img s="'+style+'" style="height:'+h+';position: relative; left: 0px;" id="'+data.id+'" src="'+path+'"></ul>';
		$("#images").append(html);
		}
		})
		}
else
{
if (grup=='admin')
{
	var array=new Array();
	$("#images img").each(function()
	{
	array.push($(this).attr('s'))
	})

	if ($.inArray(style,array)==-1)  //not present
	{
		 if (style !=='countries')
		{
		path="http://193.190.223.53:8080/geoserver/wms/GetLegendGraphic?VERSION=1.0.0&FORMAT=image/png";
		path+="&LAYER="+data.id+"&STYLE="+style+"&LEGEND_OPTIONS=forceLabels:on;fontStyle:italic;fontSize:12";
		html='<ul><img s="'+style+'" style="height:20px; position: relative; left: 0px;" id="'+data.id+'" src="'+path+'"></ul>';
		$("#images").append(html);return false;
		}
	}
	else
	{
	 if (style =='countries' )
		{var h='40px'} else{h='20px'  }

	//	console.warn($("#images img[s='"+style+"']"));
	$("#images img[s='"+style+"']").height()
	if ($("#images img[s='"+style+"']").height() !=='0px')	
	{
		$("#images img[s='"+style+"']").height(h);$("#images img[s='"+style+"']").show();return false;
	}
	else
	{
	return false;		
	}

	}
}
if (grup=='analysis')
{
var w=$("img[id='"+data.id+"']").width();
var h=$("img[id='"+data.id+"']").height();
if($("#images img[id='"+data.id+"']").length)
{
$("#images img[id='"+data.id+"']").height(h);
$("#images img[id='"+data.id+"']").width(w).show();
}else {


path="http://193.190.223.53:8080/geoserver/wms/GetLegendGraphic?VERSION=1.0.0&FORMAT=image/png";
path+="&LAYER="+data.id+"&SLD="+eval("edit_"+data.id+".params.SLD");
html='<ul><img s="'+style+'" id="'+data.id+'" style="height:'+h+';position: relative; left: 0px;" src="'+path+'"></ul>';
$("#images").append(html);
}
}
else
{
if($("#images img[id='"+data.id+"']").length)
{
$("#images img[id='"+data.id+"']").height('20px').show();
}else {
if (grup=='utm')
{h='40px';}else{h='20px'}
path="http://193.190.223.53:8080/geoserver/wms/GetLegendGraphic?VERSION=1.0.0&FORMAT=image/png";
path+="&LAYER="+data.id+"&STYLE="+style+"&LEGEND_OPTIONS=forceLabels:on;fontStyle:italic;fontSize:12";
html='<ul><img s="'+style+'" style="height:"'+h+'"; position: relative; left: 0px;" id="'+data.id+'" src="'+path+'"></ul>';
$("#images").append(html);
}
}
}
}
else {   //we are unchecking

$("#images img[id='"+data.id+"']").height('0').hide();

}
}
userid=Math.floor(Math.random()*1000);
	    bind=function()
		{

t=$("#map").position().top+$("#map").height();
l=$("#map").position().left;
$("#escala,#escala2").css({position:'absolute'});

 if ($.browser.version!=='6.0')
 {
$("#escala").css('top',t).css('left',l+50);
$("#escala2").css('top',t).css('left',l+250);
$("#coords").css('top',t).css('left',l+$("#map").width()-200);
$("#image").css('top',$("#map").position().top+(($("#map").height()/2)-75)).css('left',l+(($("#map").width()/2)-75));
}else
{
$("#escala").css('top',t-40).css('left',l+50);
$("#escala2").css('top',t-40).css('left',l+250);
$("#coords").css('top',t-40).css('left',l+$("#map").width()-200);
}

//(".olControlLayerSwitcher ").hide();

ajax_show=false;
//w=parseInt($(window).width());
/*
w=screen.width;
switch (screen)
{
case '1280': $("#map").width('850');
			$("#map").height('425'); break;
}*/
/*
$.get('http://edit.africamuseum.be/edit_wp5/geo/check.php?userid='+userid,function() {

ajax_show=true;
});*/

$("#user_dates").hide();
$("#gbif").hide();
 change2=function(d)
{
	
if (d.css('display')=='none')
{
d.animate({opacity:1,"height":"+=50px"}, 'slow',function()
{
d.css({color:'blue'});
})
d.animate({"height":"-=50px"},2000,function()
{
d.css({color:'black'});
})
}else {
i=d.get(0);
//console.log(i);
id=i.getAttribute('id');

if (id !=="download_data" && id !=="user_dates")
{
if (id=='analysis')
{
$("interactive_analysis").fadeOut('slow');
}
d.fadeOut('slow');

}

}
}
change=function(i)
{

if ($(i).hasClass('visible'))
{
$(i).children().text('Hide module');
$(i).removeClass('visible');
}
else
{
$(i).children().text('Show');
$(i).addClass('visible');
}
//console.log($(i.target));
i=$(i).get(0);
//alert($(i.target).id);
id=i.getAttribute('id');
if (id=='analysis_m')
{
	if (map.getProjection() !='EPSG:4326')
	{
		alert("This tool only can be used in latitude/longitude"); $(i).children().text('Show');
	}
	else
	{
if ($("#user_dates").css('display')=='none')
{
alert("you must first upload point data");
$(i).children().text('Show');
}
else {
change2($("#analysis"));

}
}
}
if (id=='remote_m')
{
	if (map.getProjection() !='EPSG:4326')
	{
		alert("This tool only can be used in latitude/longitude"); $(i).children().text('Show');return false()
	}
}

if (id=='query_m')
{
	if ($("#user_dates").css('display')=='none')
	{
	alert("you must first upload point data");
	$(i).children().text('Show');
	}
	else
	{
	if (map.getProjection() !='EPSG:4326')
	{
		alert("This tool only can be used in latitude/longitude"); $(i).children().text('Show');
	}
	else
	{
if ($(".olControlEditingToolbar").css('visibility')=='visible')
{
//alert("hide it");
$(".olControlEditingToolbar").css({visibility:'hidden'});
$(".olControlEditingToolbar div").css({visibility:'hidden'});
$(".olControlFeatureInfoItemActiveItemInactive").width('0').height('0').css({visibility:'hidden'});
$(".olControlFeatureInfo2ItemInactive").width('0').height('0').css({visibility:'hidden'});
}
else
{

$(".olControlEditingToolbar").css({visibility:'visible'});

$(".olControlEditingToolbar div").css({visibility:'visible'});

$(".olControlFeatureInfoItemActiveItemInactive").width('30').height('30').css({visibility:'visible'});
$(".olControlFeatureInfo2ItemInactive").width('30').height('30').css({visibility:'visible'});
}
}
}
}
if (id=='proj_m')
{

	if ($("#user_dates").css('display')=='none')
	{
	alert("you must first upload point data");
	$(i).children().text('Show');
	}
	else
	{
change2($("#projections"));
}
}
if (id=='g_proj_m')
{
change2($("#google_projections"));
}
if (id=='remote_m')
{
change2($("#remote_layers"));
}
if (id=='gbif_m')
{
	if (map.getProjection() !='EPSG:4326')
	{
		alert("This tool only can be used in latitude/longitude"); $(i).children().text('Show');
	}
	else
	{
change2($("#gbif"));
    }

}

if (id=='projects_m')
{
	if (map.getProjection() !='EPSG:4326')
	{
		alert("This tool only can be used in latitude/longitude"); $(i).children().text('Show');
	}
	else
	{
change2($("#upload_projects"));
    }
}
if (id=='others_m')
{
if (edit_points.map==null && edit_sp_points.map==null && edit_4th_points.map==null)	
{
alert("you need to upload point data to use these tools");$(i).children().text('Show');
}
else
{
	if (map.getProjection() !='EPSG:4326')
	{
		alert("This tool only can be used in latitude/longitude"); $(i).children().text('Show');
	}
	else
	{
change2($("#others"));
	}
}

}

}		
$('#overlays_div input').click(function(){

$("input[name='Polygon to query']").hide().next().hide();
})
//$("input[id='OpenLayers.Control.LayerSwitcher_114_input_serialized_polygons']").hide().next().hide();

$("input[name='Polygon to query']").hide().next().hide();
$("input[name='Your symbolized polygons']").hide().next().hide();
$("input[name='Polygon layer']").hide().next().hide();

 $(".olControlEditingToolbar div").bind('click',function(event){

x=function() {v_select.deactivate();$("#interactive_analysis input").attr('checked',false); vectors.setVisibility(false);}

y=function () {}
$("#polygon_info_input").is(':checked')?x():y();
	if ($(event.target).attr('class')=='olControlDrawFeaturePolygonItemActive')
						{
				
						if (polygonLayer.map=='null')
						{
							
						map.addLayer(polygonLayer);
						}
		//	console.log("the tool for polygon symbolizing");
					polygonLayerControl.activate();
					} else 
					
					{
					
							if ($(event.target).attr('class')=='olControlNavigationItemActive')
							{
					
					
							pan.deactivate();
						
							  
							//feature_select.map=map;
							feature_select.activate();
						//	draw_to_query.activate();
							}
									if (polygonLayerControl.activate)
									{
									polygonLayerControl.deactivate();
									}
					

		}
})


			$("div[id='panel'] > div").bind('click',function(event){
			//console.log($(event.target).attr('class'));

x=function() {v_select.deactivate();$("#interactive_analysis input").attr('checked',false); vectors.setVisibility(false);}

y=function () {}
$("#polygon_info_input").is(':checked')?x():y();

draw_symbolize.deactivate();draw_to_query.deactivate();
						if ($(event.target).attr('class')=='olControlFeatureInfo2ItemActive')
						{
							
							$.getScript('js_code/individual_ppol_adaptat.js');
						}
						
						if ($(event.target).attr('class')=='olControlPanZoomBarItemActive')
						{
						//console.log("panning");
						 if (vlayer.features.length >1) {vlayer.destroyFeatures(vlayer.features[0])};
						draw_symbolize.deactivate();draw_to_query.deactivate();
pan.activate();
						}

if (polygonLayerControl.activate)
					{
					polygonLayerControl.deactivate();
					}
/*if (drawControls['polygon'].activate)					{
					drawControls['polygon'].deactivate();
					} */

						});
						$(".olControlEditingToolbar div").click(function(){
				
						map.addLayer(vlayer);
				
						});
		
//	user="no_user";
}  //end bind
	
function ajaxFileUpload2(type)
	{
	my_json="true";
	}

function ajaxFileUpload(type)
	{
	ajax_show=true;
		$("#loading")
		.ajaxStart(function(){
			$(this).show();
		})
		.ajaxComplete(function(){
			$(this).hide();
		});


//alert(type);-->correcte
if (type=='points')
{
datatype='points';
id='file';

if ($("input[name='dataset']:checked").attr('id')=='new_data')
{
userid=Math.floor(Math.random()*1000);
var new_data='yes';
}
else
{
	var new_data='no';
}
lat=$("#lat").val();
lon=$("#lon").val();
fields=$("#fields").val();

$("#3th_name input:textarea").val() !== "" ? third=$("#3th_name input:textarea").val() : third="Genus";
$("#4th_name input:textarea").val() !== "" ? fourth=$("#4th_name input:textarea").val() : fourth="Species";

var u;
if ($("#upload_content #fields").val() >2)
{
u="&s=";
$(".y input:checked").each(function()
{
if ($(this).attr('id')!=="symb_no")
{
u+=$(this).attr('id');

}
})

}
if (map.getProjection() !=='EPSG:4326')
{
	alert("You only can upload data using latitude/longitude (unprojected)");
	return false;
}
url='http://edit.africamuseum.be/edit_wp5/geo/upload_points.php?userid='+userid+'&new_data='+new_data+'&lon='+lon+'&lat='+lat+'&fields='+fields+u;

}
else  //uploading json
{
datatype='json';
id='json_file';
url='http://edit.africamuseum.be/edit_wp5/geo/upload_json.php';
my_json="true";
}


	$.ajaxFileUpload
		(
			{
				url:url,
				secureuri:false,
				fileElementId:id,
				dataType: 'json',
				success: function (data, status)
				{
				//	console.warn(data);
					if(typeof(data.error) != 'undefined')
					{
						if(data.error != '')
						{
							alert(data.error);
						}else
						{
									
			if (datatype=='points')
			{		
			x=new Date();

			if (data.genus_sld)
			{

				initial_g_sld=data.genus_sld;
				edit_points.params.SLD=data.genus_sld;				
				if (edit_points.map==null)
				{
				map.addLayer(edit_points);
				}
				var g_legend=document.getElementById("genera_legend");
				g_legend.setAttribute("src",legend='http://193.190.223.53:8080/geoserver/wms/GetLegendGraphic?VERSION=1.0.0&FORMAT=image/png&WIDTH=25&HEIGHT=20&LAYER=user_points&sld='+edit_points.params.SLD+'?date='+x);
//							$("#g_data div:first").text('Your '+third+' data').css('display','inline');
						$("#g_data").get(0).firstChild.nodeValue='Your '+third+' data';
							   $("#u_points input[id='edit_points']").bind('click',function() { set_Visible(this); });  
							$("#g_data").show();

			}
			
						if (data.fourth_sld)
						{
							
					initial_4th_sld=data.fourth_sld;					
					edit_4th_points.params.SLD=data.fourth_sld;
								if (edit_4th_points.map==null)
								{
								map.addLayer(edit_4th_points);
								}
								var g_sp_legend=document.getElementById("4th_legend");
								g_sp_legend.setAttribute("src",legend='http://193.190.223.53:8080/geoserver/wms/GetLegendGraphic?VERSION=1.0.0&FORMAT=image/png&WIDTH=25&HEIGHT=20&LAYER=user_points&sld='+edit_4th_points.params.SLD+'?date='+x);
					//			$("#4th_data div:first").text('Your '+fourth+' data').css('display','inline');
											$("#4th_data").get(0).firstChild.nodeValue='Your '+fourth+' data';
								 $("#u_points input[id='edit_4th_points']").bind('click',function() { set_Visible(this); });  
								$("#4th_data").show();
						}
							if (data.sp_sld)
							{
							
						initial_sp_sld=data.sp_sld;
						edit_sp_points.params.SLD=data.sp_sld;
									if (edit_sp_points.map==null)
									{
									map.addLayer(edit_sp_points);
									}
										var sp_legend=document.getElementById("species_legend");
										sp_legend.setAttribute("src",legend='http://193.190.223.53:8080/geoserver/wms/GetLegendGraphic?VERSION=1.0.0&FORMAT=image/png&WIDTH=25&HEIGHT=20&LAYER=user_points&sld='+edit_sp_points.params.SLD+'?date='+x);
								//		$("#sp_data div:first").text('Your '+third+'&'+fourth+' data').css('display','inline');
								$("#sp_data").get(0).firstChild.nodeValue='Your '+third+'&'+fourth+' data';
										$("#u_points input[id='edit_sp_points']").bind('click',function() { set_Visible(this); });  
										$("#sp_data").show();
							}


		u_bbox=data.bbox;
//		console.log(edit_points.params.SLD);
 var bounds=new OpenLayers.Bounds.fromString(u_bbox);	

	center=bounds.getCenterLonLat();

	 map.setCenter(center,map.getZoomForExtent(bounds));
	

/*	 
$("#user_dates").click(function()
{x=new Date();
		var image=document.getElementById("legend");
			g_legend.setAttribute("src",'http://193.190.223.53:8080/geoserver/wms/GetLegendGraphic?VERSION=1.0.0&FORMAT=image/png&WIDTH=25&HEIGHT=20&LAYER=user_points&sld='+edit_points.params.SLD+'?date='+x);

});
*/
//map.setCenter(bounds.getCenterLonLat(),map.getZoomForExtent(bounds));
map.zoomToExtent(bounds);

		 change2($("#user_dates"));
		 change2($("#download_data"));

   if ($("#print_params").children().size()<1)
		{

			$.getScript('js_code/print_module.js');
		}
	  if ($("#proj_params").children().size()<1)
			{

				$.getScript('js_code/proj_module.js');
			}
		  $("#upload_data").trigger("click");
		   $("#user_dates").trigger("click");

		  $.get('http://edit.africamuseum.be/edit_wp5/geo/check2.php?userid='+userid);
						}
				else
				{
			
			//	console.warn("set up myjson to"+my_json)
				getlayers('user_json/'+data.data);
				
				}
		
				}
					}
		ajax_show=false;
$("#image").hide();
							
				} //end success for points
			,
				error: function (data, status, e)
				{
				//console.log(data);
					alert(e);
				}
			}
		)
		
		return false;

	} //end ajaxfile upload??
//user_info="true";  // em sembla falta }


	 new_user=Math.floor(Math.random()*1111)    
	user_info="false";
	
toogle_wms=function(d)
{

if (d.checked)
{

$("#wms_checkbox input").attr('checked',false);
$(d).attr('checked',true);
		  eval("map.setBaseLayer("+d.id+")");
       eval(d.id+".redraw()");
        eval(d.id+".setVisibility(true)");
}
else
{
 eval(d.id+".setVisibility(false)");
}
}	
	toogle_mode=function(mode)
{
if (mode=='print')
{
edit_admin.tileSize.w=map.size.w;
edit_admin.tileSize.h=map.size.h;
edit_admin.ratio=1;
edit_admin.singleTile= true;

edit_tdwg.tileSize.w=map.size.w;
edit_tdwg.tileSize.h=map.size.h;
edit_tdwg.ratio=1;
edit_tdwg.singleTile= true;
}else {
edit_tdwg.tileSize.w=1050;
edit_tdwg.tileSize.h=525;
edit_tdwg.ratio=1.5;
edit_tdwg.singleTile= false;

edit_admin.tileSize.w=1050;
edit_admin.tileSize.h=525;
edit_admin.ratio=1.5;
edit_admin.singleTile= false;
}
edit_admin.redraw()
}

 var set_Visible=function (data)
	 {
	 	if (data.checked==true)
		{
	//	console.log("edit_"+data.id+".setVisibility(true)")
	eval(data.id+".setVisibility(true)");
//		wms_ms.setVisibility(true);
		//console.log("wms_ms.setVisibility(true)");
		}
		else
		{
		eval(data.id+".setVisibility(false)");
		//wms_ms.setVisibility(false);
		}
	 }

		toogle_gbif=function(data)
	{
	if (data.checked==true) {
	edit_gbif.setVisibility(true);
	}
	else
	{

		edit_gbif.setVisibility(false);
	}
	}	
	
	 toogle_simple=function(data,grup)
		{
	//	console.warn("simple toogle");
	ajax_show=true;		
	    var layer="edit_"+data.id;
		var style=data.getAttribute("stylez");
		var grup=data.getAttribute("grup");
	
		if (data.checked==true)
		{
	//console.log(data.id+"checked")
		//"symbolize this layer"
		var nexts=$(this).next().nextAll();
		$(nexts).css('visibility','hidden');

		$("#layers input[id='"+data.id+"']").next().next().css('visibility','visible');
		var ul=$(data).parent(); 
		$(ul).css('height','40');
		
		
		if ($("#ppol_form").length)
		{
		//console.log("yes");
		p=$("input[id='"+data.id+"']").next().get(0);
		label=p.firstChild.nodeValue;
		extra="<option id='"+data.id+"'>"+label+"</option>";
		$("#ppol_form select").append(extra);
		}
		
		if (grup!=="admin" && grup!=="nature")
		{
	//HIDDING OTHERS	
	//console.log("we hide");
$("#layers input:checked[grup='"+grup+"']").each(function()
{
var checked=$(this).attr('checked');
var s_layer=$(this).attr('id');

if ($(this).hasClass('symbolized'))
{
eval("edit_"+s_layer+".setVisibility(false)")
}
else
{
$("#layers input[id='"+s_layer+"']").trigger('click');
$("#layers input[id='"+s_layer+"']").trigger('click');
}
})
//eval("edit_"+layer+".setVisibility(true)")

		$("#layers input:checkbox[grup="+grup+"]").attr('checked',false);		
		data.checked=true;
		$("#layers li[id='"+grup+"'] input:not(:checked)").each(function()
		{
//		console.log("unchecking others");
var nexts=$(this).next().nextAll();
var ul=$(this).parent(); 

if (nexts.length > 0)
{
//console.log(nexts.length)
$(nexts).css('visibility','hidden')
$(ul).css('height','20');
		}
		})

		}
//		console.log("visualize it"+layer);
		eval(layer+".setVisibility(true)");
		}else
		{
			//console.warn("hiddin")
		$("#layers input[id='"+data.id+"']").next().next().css('visibility','hidden');
		var ul=$(data).parent(); 
		$(ul).css('height','20');
		eval(layer+".setVisibility(false)");
		if ($("#ppol_form").length)
		{
		
		$("#ppol_form option[id='"+data.id+"']").remove()
		} 
		}
		}
		
 toogle=function(data)
		{

//    console.log("toogling");
	ajax_show=true;
		var grup=data.getAttribute("grup");
	    var layer="edit_"+grup;
		var style=data.getAttribute("stylez");
		var array=eval("edit_"+grup+".params.LAYERS");
		var styles_array=eval("edit_"+grup+".params.STYLES");

	
	function isArray(variable) {
if (variable.constructor == Array)
return true;
else
return false;
}
if (!isArray(array))
{

//alert("not array");
array=array.split(',');

}
if (!isArray(styles_array))
{
styles_array=styles_array.split(',');
}
//console.warn(array);

var update=function(val,style)
	{

x=$.grep(array,function (v)
{
if (v==val)
{
//alert("to remove"+v);
index=$.inArray(v,array);
return index;
}
else
{
return val;
}
});

x2=$.grep(styles_array,function (s)
{
if (s==style)
{
//alert("to remove"+v);
index2=$.inArray(s,styles_array);
return index2;
}
else
{
return style;
}
});

//console.warn(typeof(index));

if(typeof(index) !== 'undefined')  
{
array.splice(index,1);
styles_array.splice(index,1);
//console.log("lenght is"+array.length);
if (array.length > 0)
{

//	console.warn(styles_array);
eval("edit_"+grup+".mergeNewParams({layers:'"+array+"',styles:'"+styles_array+"'})");
//eval("edit_"+grup+".mergeNewParams({styles:'"+styles_array+"'})");
//if ("edit_"+grup+".params.length" > 0)
} else { 
  		eval("map.removeLayer(edit_"+grup+")");
//eval("edit_"+grup+".setVisibility(false)");
			eval("edit_"+grup+".params.LAYERS=[]");
			eval("edit_"+grup+".params.STYLES=[]");
			}

	

}
else
{
//		console.log(array)
array.push(val);
styles_array.push(style);
//TAMBÃ‰ STYLE HAURIA DE SER PUSHAT
eval("edit_"+grup+".mergeNewParams({layers:'"+array+"',styles:'"+styles_array+"'})");
eval("edit_"+grup+".mergeNewParams({styles:'"+styles_array+"'})");

}
var index=undefined;
		}//fi funcio

	if (data.checked==true)  //volem visualitzar
		{
		count=array.length;
        
/*
if ($("#layers [id='"+data.id+"']").next().next().attr('id')=='symbolize')
{
$("#layers [id='"+data.id+"']").next().next().css('visibility','visible')
}
*/

		if ($("#ppol_form").length)
		{
		//console.log("yes");
		p=$("input[id='"+data.id+"']").next().get(0);
		label=p.firstChild.nodeValue;
		extra="<option id='"+data.id+"'>"+label+"</option>";
		$("#ppol_form select").append(extra);
		}
									
		if (layer.map==null)
			{

		eval("map.addLayer("+layer+")");

			}
		if (! eval("edit_"+grup+".getVisibility()"))
	{
	eval("edit_"+grup+".setVisibility(true)");
	}		
		
		if (grup!=="admin" && grup!=="nature")
		{
		//ONLY A LAYER CAN BE SELECTED; WE HAVE TO HIDE LABEL AND SYMBOLOGY OPTIONS WHEN NOT SELECTED

$("#layers input:checked[grup='"+grup+"']").each(function()
{
var checked=$(this).attr('checked');
var layer=$(this).attr('id');
if ($(this).hasClass('symbolized'))
{
c="edit_"+layer+".setVisibility(false)";

eval(c)
}

})
		$("#layers input:checkbox[grup="+grup+"]").attr('checked',false);
				

		data.checked=true;		       
		$("#layers li[id='"+grup+"'] input:not(:checked)").each(function()
		{
var nexts=$(this).next().nextAll();
var ul=$(this).parent(); 

if (nexts.length > 0)
{

$(nexts).css('visibility','hidden')
$(ul).css('height','20');
		}
		})
	eval(layer+".mergeNewParams({layers:'"+data.id+"',styles:'"+style+"'})");
	//eval(layer+".mergeNewParams({styles:'"+style+"'})");
		if (grup=="quadricules")
			{
	
			//so we avoid to create different grids styles (SLD) when they use the same symbology
			//we keep grid1, grid2, grid5 stylez in order to get the legend 
			switch (screen_w)
			{
				case 'medium1': style="grids_m";break;
				case 'medium2':	style="grids_label_m2";break;
				case 'big':	style="grids_b";break;
				
			}

		
				eval("edit_quadricules.mergeNewParams({layers:'"+data.id+","+data.id+"_line',styles:'nl_grids,"+style+"'})");
						
				edit_quadricules.setVisibility(true);
			}


		}
		else
			{
			update(data.id,style);
			}

	}
	else
	{  

		if ($("#ppol_form").length)
		{
		
		$("#ppol_form option[id='"+data.id+"']").remove()
		} 
			if (grup=="quadricules")
				{
					edit_quadricules.mergeNewParams({styles:'',layers:''});
					
					edit_quadricules.setVisibility(false);				
				}
				else
				{
	update(""+data.id,style);
			}

	}
		}
		
	
	        //var map;

        
		 if ($.browser.version=='6.0')
{
t_img_format='image/png8';
} else { t_img_format='image/png'; }

		
			var edit_nasa = new OpenLayers.Layer.WMS( "NASA Global Mosaic",
				                "http://wms.jpl.nasa.gov/wms.cgi?", 
				                {layers: "global_mosaic",transparent:"FALSE",GROUP:"remote"},{'displayInLayerSwitcher':true,isBaseLayer: true});
		
		
		

		
			

			taxa_id=13212109;
			gbif_filter=function(taxa_id)
			{ return "(<Filter><And><PropertyIsEqualTo><PropertyName>type</PropertyName><Literal>1</Literal></PropertyIsEqualTo><PropertyIsEqualTo><PropertyName>concept</PropertyName><Literal>"+taxa_id+"</Literal></PropertyIsEqualTo></And></Filter>)";
			}
				var edit_gbif = new OpenLayers.Layer.WMS( "GBIF",
                "http://geoserver.gbif.org/wms?", {group:"remote",layers: "gbif:gbifDensityLayer",version: "1.0.0", transparent: "true", 
                format:t_img_format, filter: gbif_filter(taxa_id),opacity:0.5} );	
             edit_gbif.setOpacity (0.5) 
             
				
var toogle_background=function(d)
	{

	if (d.map==null)
	{
	map.addLayer(d);
map.setBaseLayer(d)
d.redraw();
	}
else 
{

        map.setBaseLayer(d)
        d.redraw();
}
	
	}
	var g,drawControls; 
	   function v_toggle(element) {
	   }
	
	   function v_toggle(element) {

                if(element.checked==true) {
vectors.params.filter="<Filter><And><PropertyIsEqualTo><PropertyName>userid</PropertyName><Literal>"+userid+"</Literal></PropertyIsEqualTo></And></Filter>";
//					  v_select.activate();
					 if  ($("#interactive_analysis_input").hasClass("first"))

	             {

	            	             map.addLayer(vectors);
	            a
	              
	              $("#interactive_analysis_input").removeClass('first');
	             }
                   else {  
                   
                   vectors.setVisibility(true);
                  
                   } 
                  v_select.activate();
                  
                } 
                else 
                {              
                vectors.setVisibility(false);

                    v_select.deactivate();
            }
        }
        myStyles2 = new OpenLayers.StyleMap({
                "default": new OpenLayers.Style({                   
                    fillColor: "#ebbc1e",
					fillOpacity:0.25,
					strokeColor: "#242b32",
                    strokeWidth: 1.5
                }),
                "select": new OpenLayers.Style({
                    fillColor: "#ee3e3a", //vermell
                    fillOpacity:0.5,
                    strokeWidth: 2,
                    strokeColor: "#3399ff"
                })

            });
            

            	   vectors = new OpenLayers.Layer.WFS(
    "My polygons to hover",
    "http://193.190.223.53:8080/geoserver/wfs",
    {typeName: "point_pol",version:"1.1.0",
    FILTER:"<And><PropertyIsEqualTo><PropertyName>userid</PropertyName><Literal>"+userid+"</Literal></PropertyIsEqualTo></And>"},
    {isBaseLayer: false, extractAttributes: true, styleMap: myStyles2}
    
);
  

var options,map;
var controls,gsat,gmap,ghyb,veroad;
  create_layers=function(proj_code)
       {
		
		
		if ($("#google_projections").css('display') !=='none')
		{		
var p=$("#google_form option:selected").val();
        switch (p)
		{

			case 'gsat':
			{

	    gsat = new OpenLayers.Layer.Google(
                "Google Satellite",
                {type: G_SATELLITE_MAP, 'sphericalMercator': true, numZoomLevels: 22,GROUP:'commercial'},{isBaseLayer: true});
proj_code='EPSG:900913';
					break;
				}
			case 'gmap': 
			{
			 gmap = new OpenLayers.Layer.Google(
			                "Google Streets",
			                {'sphericalMercator': true,GROUP:'commercial'}
			            ); 
			proj_code='EPSG:900913';
			break;
			}
			case 'ghyb':
			{
			ghyb = new OpenLayers.Layer.Google(
                "Google Hybrid",
                {type: G_HYBRID_MAP, 'sphericalMercator': true,GROUP:'commercial'}
            );
proj_code='EPSG:900913';
break;
	
		}
		case 'veroad':
		{
		
		veroad = new OpenLayers.Layer.VirtualEarth(
		 	                "Virtual Earth Raods",
		 	                {'type': VEMapStyle.Road, 'sphericalMercator': true,GROUP:'commercial'}
		 	            );
		proj_code='EPSG:900913';
				break;
		}
		
			case 'veaer':
			{
			veaer = new OpenLayers.Layer.VirtualEarth(
			 	                "Virtual Earth Aerial",
			 	                {'type': VEMapStyle.Aerial, 'sphericalMercator': true,GROUP:'commercial'}
			 	            );
								proj_code='EPSG:900913';
										break;
			}
			case 'vehyb':
			{
			 	            vehyb = new OpenLayers.Layer.VirtualEarth(
			 	                "Virtual Earth Hybrid",
			 	                {'type': VEMapStyle.Hybrid, 'sphericalMercator': true,GROUP:'commercial'}
			 	            );
							proj_code='EPSG:900913';
									break;
			}
			case 'yahoo':
			{
			 	            // create Yahoo layer
			 	            yahoo = new OpenLayers.Layer.Yahoo(
			 	                "Yahoo Street",
			 	                {'sphericalMercator': true,GROUP:'commercial'}
			 	            );
								proj_code='EPSG:900913';
										break;
			}
			case 'yahoosat':
			{
			 	            yahoosat = new OpenLayers.Layer.Yahoo(
			 	                "Yahoo Sattelite",
			 	                {'type': YAHOO_MAP_SAT, 'sphericalMercator': true,GROUP:'commercial'}
			 	            );
							proj_code='EPSG:900913';
									break;
			}
			case 'yahoohyb':
			{
				            yahoohyb = new OpenLayers.Layer.Yahoo(
			 	                "Yahoo Hybrid",
			 	                {'type': YAHOO_MAP_HYB, 'sphericalMercator': true,GROUP:'commercial'}
			 	            );
							proj_code='EPSG:900913';
									break;
			}
			case 'mapnik':
			{
				//	bounds="-20037508.34,-20037508.34,20037508.34,20037508.34";
				
			 	            // create OSM layer
			 	            mapnik = new OpenLayers.Layer.TMS(
						                "OpenStreetMap (Mapnik)",
						                "http://tile.openstreetmap.org/",
						                {
						                    type: 'png', getURL: osm_getTileURL,
						                    displayOutsideMaxExtent: true,
						                    attribution: '<a href="http://www.openstreetmap.org/">OpenStreetMap</a>',
											GROUP:'commercial'
						                }
						            );
						 
							proj_code='EPSG:900913';
						
									break;
			}
		
			}
		}
		else
		{
			var p=$("form[id='crs_final'] option:selected").val();
		}


	edit_points = new OpenLayers.Layer.WMS.Untiled( "third field points","http://193.190.223.53:8080/geoserver/wms", {GROUP:'points',layers:'user_points',sld:'',format:t_img_format,transparent:"true"});
	edit_sp_points = new OpenLayers.Layer.WMS.Untiled( "third&fourth field points","http://193.190.223.53:8080/geoserver/wms", {GROUP:'points',layers:'user_points',sld:'',format:t_img_format,transparent:"true"});

	edit_4th_points = new OpenLayers.Layer.WMS.Untiled( "fourth field points","http://193.190.223.53:8080/geoserver/wms", {GROUP:'points',layers:'user_points',sld:'',format:t_img_format,transparent:"true"});
	edit_blank = new OpenLayers.Layer.WMS.Untiled( "EDIT WMS transparent",
			"http://193.190.223.53:8080/geoserver/wms",
			                {layers:"blank",projection:proj_code,transparent:"false",format: t_img_format,styles:"transparent",group:"remote"},
						{isBaseLayer: true},{singleTile: true, ratio: 1});
	
	edit_quadricules = new OpenLayers.Layer.WMS.Untiled( "Quadricules",
		"http://193.190.223.53:8080/geoserver/wms",
		                {layers:[],width:'700',height:'350',transparent:"true",styles:[],format:t_img_format,GROUP:'quadricules'}
						, {group:"vectorial"},{'displayInLayerSwitcher':true},{gutter: 1} );
	edit_nature = new OpenLayers.Layer.WMS.Untiled( "Natural features",
		"http://193.190.223.53:8080/geoserver/wms",
		                {layers:[],GROUP:"nature",transparent:"true",styles:[],format:t_img_format}
						,{'displayInLayerSwitcher':true} );

	edit_utm = new OpenLayers.Layer.WMS.Untiled( "UTM layer",
		"http://193.190.223.53:8080/geoserver/wms",
		                {layers:[],transparent:"true",styles:[],group:"utm",format:t_img_format}
						, {group:"vectorial"},{'displayInLayerSwitcher':true} );
						
	edit_admin = new OpenLayers.Layer.WMS.Untiled( "Administrative Layers",
                "http://193.190.223.53:8080/geoserver/wms",
                {layers: [],group:"admin",transparent:"true",format:t_img_format,styles:[]},{'displayInLayerSwitcher':true} );
             //   console.warn(edit_admin);

	  edit_tdwg = new OpenLayers.Layer.WMS.Untiled( "TDWG layer",
		"http://193.190.223.53:8080/geoserver/wms",
		                {layers:[],group:"tdwg",transparent:"true",styles:[],format:t_img_format},{'displayInLayerSwitcher':true} );
 
    	ms_url = "http://edit.africamuseum.be/cgi-bin/mapserv?map=/var/www/synthesys/www/geo/mapserver_data/test.map";
	//	shoreline = new OpenLayers.Layer.MapServer("Estados y Municipios",ms_url,{layers: "shoreline", transparent: true, format: "image/png"});

		edit_num_regs = new OpenLayers.Layer.WMS.Untiled( "Number of Records",
		"http://193.190.223.53:8080/geoserver/wms",
		                {layers:'num_regs',transparent:"true",styles:[],format: t_img_format,group:'analysis'}
						, {group:"vectorial"});
				
		edit_taxa_record = new OpenLayers.Layer.WMS.Untiled( "Taxa/Record",
		"http://193.190.223.53:8080/geoserver/wms",
		                {layers:'taxa_record',transparent:"true",styles:[],format:t_img_format,group:'analysis'}
						, {group:"vectorial"});
						
		edit_num_genus = new OpenLayers.Layer.WMS.Untiled( "Number of Genera",
		"http://193.190.223.53:8080/geoserver/wms",
		                {layers:'num_genus',transparent:"true",styles:[],format:t_img_format,group:'analysis'}
						, {group:"vectorial"});
		edit_gbif = new OpenLayers.Layer.WMS( "GBIF",
                "http://geoserver.gbif.org/wms?", {group:"remote",layers: "gbif:gbifDensityLayer",version: "1.0.0", transparent: "true", 
                format:t_img_format, filter: gbif_filter(taxa_id),opacity:0.5} );	

        

           
           }   //END CREATE LAYERS FUNCTION
var bounds2,map;
	     function init()
	     {
		
				
//     add_controls('EPSG:4326',"-180.0000,-90.0000,180.0000,90.0000");
//Proj4js.defs["EPSG:54004"] ="+proj=merc +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs";
       add_controls=function(proj,bounds)
       {
	   boxes  = new OpenLayers.Layer.Boxes( "Boxes" );
	    vlayer = new OpenLayers.Layer.Vector( "Polygon to query",{GROUP:"remote"});
	     draw= new OpenLayers.Control.EditingToolbar(vlayer);
		
	     			options={	controls: [
 					new OpenLayers.Control.LayerSwitcher({'ascending':false}),				
 				//	new OpenLayers.Control.OverviewMap(),
 					draw
 					
//navigationControl
	
 				//	new OpenLayers.Control.KeyboardDefaults()
 				],    
              
                   maxResolution: "auto",
					 tileSize:new OpenLayers.Size(500, 500),projection: proj
				};
//console.log(options);
options.projection=proj;
if (proj!=='EPSG:4326')
{
//	alert(proj)
options.units='m';
//options.maxResolution=156543;
if (proj=="EPSG:900913")
{

		options.maxResolution=5643.0339;
	 	options.maxExtent=new OpenLayers.Bounds(-12037508.34,-12037508.34,12037508.34,12037508.34);
		options.projection=new OpenLayers.Projection("EPSG:900913");
		bounds="-12037508.34,-12037508.34,12037508.34,12037508.34";

}

}
else//proj=4326
{

bounds="-180.0000,-90.0000,180.0000,90.0000";
options.maxResolution="auto";

//					options.maxExtent=bounds2;
options.units='dd';
}

eval("bounds2=new OpenLayers.Bounds("+bounds+")");	

options.maxExtent=bounds2;

	         map = new OpenLayers.Map('map',options);
	


			var controls2 = map.getControlsByClass('OpenLayers.Control.Navigation');

			for(var i = 0; i <controls2.length; ++i)
			{
				controls2[i].disableZoomWheel(); 
			}

 //OpenLayers.ProxyHost="/edit_wp5/geo/mapviewer/proxy?url=";
//REMOVED part  
 pan=new OpenLayers.Control.DragPan({displayClass:'olControlPanMap'});
	//	var history = new OpenLayers.Control.NavigationHistory();
		panel_controls=[
		   
		    new OpenLayers.Control.ZoomBox(),
		    new OpenLayers.Control.PanZoomBar(),
		    pan,
		    new OpenLayers.Control.ZoomToMaxExtent({title:"Zoom to the max extent"}),
		   	  featureInfo = new OpenLayers.Control({
				    displayClass: "olControlFeatureInfoItemActive",
				    title: "Query map features"
				    }),

				featureInfo2 = new OpenLayers.Control({
					    displayClass: "olControlFeatureInfo2",
					    title: "Query map features by polygon"
					    })
/*				history,
				history.next,
				history.previous*/
			]

					featureInfo.events.register("activate", featureInfo, function() {

						ppol_query="false";
					    toggleQueryMode(); });                
					featureInfo.events.register("deactivate", featureInfo, function() {
					    toggleQueryMode(); });

								featureInfo2.events.register("activate", featureInfo2, function() {

								    toggleQueryMode2(); ppol_query="true"; });                
								featureInfo2.events.register("deactivate", featureInfo2, function() {
									ppol_query="false";
								    toggleQueryMode2(); });
            		   
		   var overview_map = new OpenLayers.Layer.WMS( "EDIT WMS",
                "http://193.190.223.53:8080/geoserver/wms",
                {layers: "country_earth",group:"admin",transparent:"true",format:"image/png",styles:[]});

		

	//var o_options = {layers: [edit_blank]};
 var edit_blank2 = new OpenLayers.Layer.WMS( "EDIT WMS transparent",
			"http://193.190.223.53:8080/geoserver/wms",
			                {layers:"blank",transparent:"false",format: t_img_format,styles:"transparent",group:"remote"},
						{isBaseLayer: true});
 var o_options = {
//            maxExtent: bounds, 
            projection: proj,
           layers:[edit_blank2,overview_map]            
        };
        
var overview=new OpenLayers.Control.OverviewMap(o_options);
 map.addControl(overview);

   map.addControl( new OpenLayers.Control.LoadingPanel());  
 //  overview.maximizeControl();
							var panel = new OpenLayers.Control.Panel({
							    div: document.getElementById("panel")
							});
							map.addControl(panel);
							
			 map.addControl(new OpenLayers.Control.ScaleLine({'div':OpenLayers.Util.getElement('escala')},{theme: null}));

	var box ;//= new OpenLayers.Feature.Vector(boxes_bounds.toGeometry());				 
			 
			          var control = new OpenLayers.Control.Scale(); 
					control.div = document.getElementById("escala2"); 
					map.addControl(control); 
			 map.addControl(new OpenLayers.Control.MousePosition({'div':OpenLayers.Util.getElement('coords')},{theme: null}));
					//	var pan=new OpenLayers.Control.PanZoomBar();
							
						//	map.addControl(history);

							//panel.addControls([new OpenLayers.Control.ZoomBox(),pan,
			for (key in panel_controls)
			{
			panel.addControls(panel_controls[key])
			}
			//	map.addControl(history);

	     map.addControl(new OpenLayers.Control.LayerSwitcher({'div':OpenLayers.Util.getElement('layerswitcher')}));

if (proj=="EPSG:4326")
{
$.getScript('js_code/4326_specific.js')
}


	
  
  
     }//end add_controls
     create_layers('EPSG:4326');   
     add_controls('EPSG:4326',"-180.0000,-90.0000,180.0000,90.0000");
       map.addLayers([edit_blank,edit_admin,edit_gbif]);
//	shoreline.setVisibility(false);
	//s_america1.setVisibility(false);s_america2.setVisibility(false);oceania1.setVisibility(false);oceania2.setVisibility(false);
	  map.setBaseLayer(edit_blank);
	  edit_gbif.setVisibility(false);

	       	edit_admin.mergeNewParams({layers:'country_earth',styles:'countries'});
			//edit_admin.mergeNewParams({styles:''});      
	        edit_admin.setVisibility(true);
			map.zoomToMaxExtent(bounds2);


	        } 
	        
	        		


	    </script>
  </head>

   <body onload="init();bind();">
  			<div id="gallery">
			</div>
<div id="mainbody">

<div id="header">

	<div style="position:relative; left: 20%;font: bold 16pt Arial, Helvetica, sans-serif; padding:5px;width:300px">EDIT mapViewer [prototype]</div>
</div><!--fi header-->

<div id="middle">
  <div id="menubar">
     
 <dl>
	
	<dd>
		<dt id="google_projections">Google & Yahoo</dt>
		<dd>
					<form id="google_form">
						<select>
					<option selected value="EPSG:4326">latitude/longitude</option>
					<option value="gsat">Google maps satellite</option>
						<option value="gmap">Google maps</option>
						<option value="ghyb">Google hibrid</option>
				<!--	<option value="veroad">Virtual Earth roads</option>
					<option value="veaer">Virtual Earth Aerial</option>
					<option value="vehyb">Virtual Earth Hybrid</option>-->
					<option value="yahoo">Yahoo Street</option>
					<option value="yahoosat">Yahoo Satellite</option>
					<option value="yahoohyb">Yahoo Hybrid</option>
					</select>
					</form>
			<div class="message3" id="google_proj">Visualize it</div><br>
	</dd>
	<dt id="projections">Projection Options</dt>
	<dd id="proj_params">		
	
	</dd>
	<dt id="download_data">Printing options</dt>

			<dd id="print_params">

		</dd>

	<dt id="edit_layers">Layers</dt>
		<dd>
	

	<div id='layers'>

			<li id="tdwg">TDWG layers</li>
			<li id="nature">Natural features</li>
			<li id="quadricules">Quadricule layers (degree grids)</li>
			<li id="utm">UTM grids</li>
				<li id="admin">Administrative layers
							<ul style="height:auto;margin-left:20px">
								<li id="africa" style="height:auto">Africa</li>	
							</ul>
							<ul style="height:auto;margin-left:20px">
								<li id="antartica" style="height:auto">Antartica</li>	
							</ul>						
							<ul style="height:auto;margin-left:20px">
								<li id="asia" style="height:auto">Asia</li>	
							</ul>
								<ul style="height:auto;margin-left:20px">
									<li id="c_america" style="height:auto">Central America</li>	
								</ul>						
							<ul style="height:auto;margin-left:20px">
								<li id="east_europe" style="height:auto">East Europe</li>	
							</ul>	
									<ul style="height:auto;margin-left:20px">
										<li id="west_europe" style="height:auto">West Europe</li>	
									</ul>					
						<ul style="height:auto;margin-left:20px">
						<li id="n_america" style="height:auto">North America</li>	
						</ul>
					<ul style="height:auto;margin-left:20px">
					<li id="s_america" style="height:auto">South America</li>	
					</ul>
						<ul style="height:auto;margin-left:20px">
						<li id="oceania" style="height:auto">Oceania</li>	
						</ul>				

				</li>	
			<li id="high_resolution" style="visibility:hidden;height:0px;cursor: default; list-style-image: url(img/plus.gif);">high resolution layers</li>
			<li id="remote">Background layers
				<ul><input type="radio" name="remote" id="blank" onClick='toogle_background(edit_blank)' checked grup="remote">Transparent background</input></ul>
				<ul><input type="radio" name="remote" id="nasa" onClick='toogle_background(edit_nasa)' grup="remote">NASA JPL data</input></ul>	
				
			</li>	

	</div>
	</dd>
 <dt id="remote_layers">Remote WMS layers</dt>

<dd>	
<div id='layers'>

<form id="ext_wms_form">
WMS Provider:<br>
			<select id="ext_url" class="" style="width: 200px">
				<option value="">Please select...</option>

				<option value="http://wms.jpl.nasa.gov/wms.cgi?service=WMS&version=1.1.1" class="">NASA JPL Web Mapping Server</option>
<option value="http://ssems1.esrin.esa.int/mapServer/mapServer?VERSION=1.1.1">ESA</option>
<option value="http://onearth.jpl.nasa.gov/wms.cgi?">One Earth Nasa</option>
<!--
<option value="http://www.hondalab.star.ait.ac.th/cgi-bin/thaiwms?service=WMS">GMS Landsat 5</option>-->
<option value="http://nsidc.org/cgi-bin/atlas_north?service=WMS&version=1.1.1">Atlas of the Cryosphere (North)</option>
				<option value="http://demo.cubewerx.com/demo/cubeserv/cubeserv.cgi?service=WMS&version=1.1.1" class="">Cubewerx Demonstration Server</option>
				<option value="http://www2.dmsolutions.ca/cgi-bin/mswms_gmap?service=WMS&version=1.1.1" class="">DM Solutions GMap Server</option>
				<option value="http://terraservice.net/ogccapabilities.ashx?service=WMS&version=1.1.1" class="">TerraServer</option>
			<!--
	<option value="http://datamil.udel.edu/servlet/com.esri.wms.Esrimap?service=WMS&version=1.1.1" class="">	Delaware</option>-->
			
<!--
	<option value="http://globe.digitalearth.gov/viz-bin/wmt.cgi?VERSION=1.1.0&service=WMS">NASA GLOBE PROGRAM</option>-->
<option value="http://ims.cr.usgs.gov/servlet/com.esri.wms.Esrimap/USGS_EDC_Elev_NED?SERVICE=WMS&VERSION=1.1.1">USGS Geological maps</option>
			
	
				<option value="http://wms.alaskamapped.org/bdl?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities" class="">Alaska BDL WMS</option>
<!--
<option value="http://www.creaf.uab.es/cgi-bin/MiraMon5_0.cgi?VERSION=1.1.0&SERVICE=WMS" >CREAF UB</option>

<option value="http://shagrat.icc.es/liszardtech/iserv/ows?service=WMS">Catalonia IDE</option>
<option value="http://161.116.68.1/wmsconnector/com.esri.wms.Esrimap/UB_Geobotanica_habitats_fulls50m_1?service=WMS">Catalonia habitats</option>
<option id="http://www.idee.es/wms/IDEE-Base/IDEE-Base?service=WMS">Spanish IDE</option>

-->

			</select> 
			<br>

			<input type="button" value="Get Layers">
			<br>
<div tt="xxx" id="transformResult"></div>
<div id="abstract" class='ppol_message'></div>
<img id="ajax_image2" src='http://edit.africamuseum.be/edit_wp5/geo/mapviewer/img/ajax_loading.gif' style="visibility:hidden;width:30px;position:absolute"></img>
<div id='wms_checkbox'><ul></ul></div>

			<br>

</form>

<div id="show_WMS" class="message3 show_it" style="width:auto;left:0px">
<b>Hide information on remote WMS</b>

<div id="message">

<b>Remote WMS Layers </b><br><br>
This is a list of map layers hosted by institutions across the world. Each institution listed has one or more map layers usually detailing a specific area of the globe. All of the layers showing on this list use EPSG:4326 projection type to conform to the other layers present in the mapviewer.<br>
<br>


		</div>
	</div>

</div>
</dd>

<dt id="gbif">GBIF data</dt>

	<dd>
	  <ul>
		 

	    <li>
				<a id="gbif_trigger" href="#" class="ex2trigger">Explore GBIF data</a><br>
				<b>It doesn't work with Internet Explorer!!</b><br>
		
		 	
					<table  id="gbif_table" cellspacing="0" style="width: 100%;" class="layerControl">
							<tbody>
						<tr>
							<td>
					<input type="checkbox" onclick="toogle_gbif(this)" id="gbif"><label style='font-size:11'>GBIF data for <b>Copris</b></label>
							</td><tr><td><img src='img/gbif_legend.png'>
							</td></tr>
					</tr>
					</tbody></table>
	
			   	
		</li>
		
	</ul>
	</dd>
	<dt id="upload_projects">Your projects</dt>
		<dd>
		<div id="create_proj" onclick="create_json(false)" style="height:20px;border:1px solid #333333;background-color:#FFF8F0"><a style="text-decoration: underline">Create your project</a></div>
		<div id="upload_json" style="height:80px;border:1px solid #333333;background-color:#e8b43b">Upload your project
		
			
		<img id="loading" src="ajax_loading.gif" style="display:none;">
		
		<table style="width: 100%;" class="layerControl">
		<form id="u_json_form" name="u_json_form" action="" method="POST" enctype="multipart/form-data">
		<thead>
			<tr>
				<th style="height: 1px;font-size: 8px;">Please select a file and click Upload button</th>
			</tr>
		</thead>
		<tbody>	
		<tr>
				<td><input id="json_file" type="file" size="18" name="json_file" class="input"></td></tr>
		</tbody>
			<tfoot>
				<tr>
					<td><button class="button" id="buttonUpload" onclick="return ajaxFileUpload('json');">Upload</button></td>
				</tr>
			</tfoot>
	
	</table>
	
		</div>
		
		</dd>
		</dt>

		<dt id="upload_data">Upload your CSV data!</dt>
		<dd>
		<div id="upload_content">

		
		<table style="width: 100%;" class="layerControl">
<form id="upload_form" name="form" action="" method="POST" enctype="multipart/form-data">
		<thead>
			<tr>
				<th style="height: 1px;font-size: 10px;">Upload a CSV file</th>
			</tr>
		</thead>
		<tbody>	
			<tr>
				<td><input id="file" type="file" size="11" name="file" class="input"></td></tr>
				<label>Number of fields</label>

				<textarea style="width: 20px; height: 20px; overflow:hidden; resize: none" class="input" id="fields"></textarea>
					<br>

				<label>Position of latitude</label>

				<textarea style="width: 20px; height: 20px; overflow:hidden; resize: none"  id="lat"></textarea>
				<br>
				<label>Position of longitude</label>

				<textarea style=" width: 20px; height: 20px;overflow:hidden;resize: none"  id="lon"></textarea>

				<div id="3_4_fields" style="height:0;border:2px solid #4ba037; padding:10px;visibility:hidden;margin:10px">
					   
					<li id="3_symb" class="y" style="list-style: none;left:10px;font-weight:bold; font-size: 10px;visibility:hidden;">Third field parameters
									<ul><input type="radio" name="3th_symb" id="symb_no">Don't want my 3th field to be symbolized</input></ul>
									<ul><input type="radio" name="3th_symb" id="3" checked >I want my 3th field to be symbolized</input></ul>					
				
					<li  style="list-style: none;left:10px;font-weight:bold; font-size: 10px;height:0">Symbolization of 3th field
						<ul><input type="radio" name="3th"  checked id="genera">My 3th field is Genera data</input></ul>
						<ul><input type="radio" name="3th" >My 3th field is NOT Genera data</input></ul>
						<ul id="3th_name" style="visibility:hidden">Enter your field name
						<input type="textarea">
						</ul>
					</li>	
						</li>
				
					<li id="4_symb" class="y" style="list-style: none;left:10px;font-weight:bold; font-size: 10px;visibility:hidden;">Fourth field parameters
						<ul><input type="radio" name="4th_symb"  checked id="symb_no">Don't want my 4th field to be symbolized</input></ul>
						<ul><input type="radio" name="4th_symb" id="4" >I want my 4th field to be symbolized</input></ul>					
						</ul>
				
								<li style="list-style: none;left:10px;font-weight:bold;font-size: 10px;height:0;">Symbolization of 4th field
									<ul><input type="radio" name="4th"  checked id="genera">My 4th field is Species data</input></ul>
									<ul><input type="radio" name="4th">My 4th field is NOT Species data</input></ul>
									<ul id="4th_name" style="visibility:hidden">Enter your 4th field name
						<input type="textarea">
						</ul>
						</li>
							</li>
						<li id="3_4_symb" class="y" style="list-style: none;left:10px;font-weight:bold; font-size: 10px;visibility:hidden;">Third AND Fourth field 
							<ul><input type="radio" name="3_4th_symb"  checked id="symb_no">Don't want my 3 AND 4th field to be symbolized</input></ul>
							<ul><input type="radio" name="3_4th_symb" id="5" >I want my 3th AND 4th field to be symbolized</input></ul>					
							</ul>
						</li>	
					   
				</div>
			
		</tbody>
			<tfoot>
				<tr>
					<td><button class="button" id="buttonUpload" onclick="return ajaxFileUpload('points');">Upload</button></td>
				</tr>
			</tfoot>
	
	</table>
		<input checked="true" name="dataset" type="radio" id="new_data">create new dataset</input><br>
	<input name="dataset" type="radio" id="add_data" >add to the current data</input><br>
		<div id="show_csv" class="message3 show_it" style="width:auto;left:0px"><b>Show data format and CSV example</b>
	<div id="message">
	<a href="http://edit.africamuseum.be/geoserverweb/for_testing.zip" target="blank">Here</a> you can download an example of a valid CSV file (1000 records)<br><br>
	The parameters to fill <b>for this test file</b> are:
	<ul>
	<li>Number of fields:5</li>
		<li>Latitude: 1</li>
			<li>Longitude: 2</li>
	</ul>
	The file must be a CSV (comma-separated values) and have at least latitude and longitude in WGS84 datum and a field (genus, species...) for future filtering and symbolization.<br>

The system is currently designed to work with Genus and Species, and these must be the third (and fourth) field in your CSV.<p>
You can try to work with other kind of data, but you must have at least a third field in the CSV.<br><br>
Don't leave any blank space! don't use non-latin letters or symbols (accents, ' > < commas...)<br><br>

Coordinates must follow Decimal notation (eg: 0.44, -79.9). To 
 to Decimal notation you can use the <a href="http://gis.miiz.waw.pl/webapps/coordinateconverter/default.aspx" target="blank">Coordinate Conversor</a>
	</div>
	</div>
	
		</form>    

	
	</div>	  
		  
		</dd>

		
	<dt id="user_dates">Your Point Data</dt>	
	<dd>
<div id="u_points">

		    <li id='g_data'>
     <ul style="height:auto;margin-left:20px;">
            <input checked name='p_data' type='checkbox' id='edit_points'>Show/hide</input><br>
	<a id="genus_g_legend" class="message3" href="#" style="top: 5px;" onClick="return false">Get the legend</a><br>	<br>				
				<a id="g_symbolize" class="message3" href="#"  onClick="return false" class="ex2trigger">Symbolize it</a><br>
			<div style="padding-top:10px"><img  id="genera_legend" style="margin-left:18px;margin-top:20px;" src=""></div>
	</ul>	
	</li>	
	<li id='sp_data'>
		<ul style="height:auto;margin-left:20px;"><label></label>
			<input  checked name='sp_data' type='checkbox' id='edit_sp_points'>Show/hide</input><br>
<a id="sp_g_legend" class="message3" href="#" onClick="return false"><label>Get the legend</label></a><br><br>						
				<a id="sp_symbolize" class="message3" href="#" onClick="return false" class="ex2trigger"><label>Symbolize it</label></a><br>
			<div style="padding-top:10px;"><img  id="species_legend" style="margin-left:18px;margin-top:20px;" src=""></div>
		
			
		</ul>
	</li>
	<li id='4th_data'>
		<ul style="height:auto;margin-left:20px">
			<input checked name='4th_data' type='checkbox' id='edit_4th_points'>Show/hide</input><br><br>	
<a id="4th_g_legend" class="message3" href="#" onClick="return false"><label>Get the legend</label></a><br><br>			
				<a id="4th_symbolize" class="message3" href="#" onClick="return false" class="ex2trigger"><label>Symbolize it</label></a><br>

			<div style="padding-top:10px"><img  id="4th_legend" style="margin-left:18px;margin-top:20px;" src=""></div>
		</ul>

			</li>
			

</div>	  
	</dd>
		<dt id="others">Other tools</dt>
		<dd>
			<div class='message3' id="boxes_tool">Boxes tool</div>
			<div class='message3' id="data_tool">Data manipulation tool</div>
		</dd>	
			<dt id="analysis">Spatial analysis</dt>
			<dd>
				<ul>			 								
				 <div>	
				 	
					<form  id="run_analysis">
						<select>
							<!--<option value="utm250000sqkm_europe">UTM 250000 sqkm Europe</option>-->
										<option value="grid10_pol">10 degrees grid</option>
										<option value="grid5_pol">5 degrees grid</option>
										<option value="grid2_pol">2 degrees grid</option>
										<option value="grid1_pol">1 degree grid</option>
										<option value="wwf_ecoregions">WWF ecoregions</option>
										<option value="europe_west_level_1">Europe West level 1</option>
			<option value="europe_west_level_2">Europe West level 2</option>
			<option value="c_america_level_1">Central America level 1</option>
<option value="c_america_level_2">Central America level 2</option>
<option value="n_america_level_1">North America level 1</option>
<option value="s_america_level_1">South America level 1</option>
										<option value="utm_world">UTM world</option>
						
				<option value="utm_europe_50km">UTM Europe 50km</option>
						</select><br>
					<a href="#">run analysis</a>
<!--					<div class="message3" id="run_analysis">run analysis</div>-->
					</form>

					</div>
					<div id="analysis_lay">
				     </div>
					<div id="ppol_message">
				
					</div>
					</ul>
					
			</dd>

		<dt id="interactive_analysis">Interactive analysis tools</dt>		
		<dd>

<input type="checkbox" name="type" class="first" id="interactive_analysis_input" onclick="v_toggle(this);">Click here, wait the layer to appear on the map and hover the desired polygon</input>

<table id="polygon_info"><tbody>
<tr><td id='code'>Polygon code:</td></tr>
<tr><td id="num_regs">Number of records</td></tr>
<tr><td id="num_genus">Number of genera</td></tr>
<tr><td id="taxa_record">Taxa/record</td></tr>
</tbody></table>

		</dd>
			<dt id="modules">Add/Remove modules</dt>
				<dd>
<div id='projects_m' class='ppol_message visible' onclick="change($(this))"><b>Show</b> Projects module</div>
<div id='proj_m' class='ppol_message visible' onclick="change($(this))"><b>Show</b> Projections module</div>
<div id='g_proj_m' class='ppol_message visible' onclick="change($(this))"><b>Show</b> Google & Yahoo module</div>
			<div id='analysis_m' class='ppol_message visible' onclick="change($(this))"><b>Show</b> Analysis module</div>
			<div id='remote_m' class='ppol_message visible' onclick="change($(this))"><b>Show</b> remote WMS module</div>
			<div id='gbif_m' class='ppol_message visible' onclick="change($(this))"><b>Show</b> GBIF module</div>
			<div id='query_m' class='ppol_message visible' onclick="change($(this))"><b>Show</b> Query & draw module</div>
			<div id='others_m' class='ppol_message visible' onclick="change($(this))"><b>Show</b> other modules</div>						
		
			</dd>  
<dt>Videos&Contact
<dd class='ppol_message'>
 <a href="http://edit.africamuseum.be/edit_wp5/edit_info/edit_videos.html" target="blank"><b>Check these videos</b> </a> to see all EDIT mapViewer can offer you<br><br> 
EDIT mapViewer has been developed by Pere Roca (peroc79@gmail.com) in the context of the  <a href="http://www.e-taxonomy.eu/" target="blank">European Distributed Institute of Taxonomy (EDIT)</a> project.
<br><br>

 <a href="http://edit.africamuseum.be/edit_wp5/edit_info/GeoTools.zip" target="blank">Here</a> you can download presentations about EDIT Geographic tools.
<br><br>

Most of the GIS layers here can be found on <a href="http://edit.csic.es/GISdownloads.html" target="blank">EDIT GIS download site</a><br><br>
All the features developed are Open Source. You can <b>soon</b> download updated source code from <a href="http://dev.e-taxonomy.eu/svn/trunk/geo/" target="blank">EDIT "geo repository"</a>

</dd>
</dt>
		</dl>

</div> <!-- fi menubar-->
</div> <!-- fi middle -->


<div id="ex2"  style="position:absolute;width:350px;height:345px;margin-left:0px" class="jqmDialog">
	
</div>
<div id="3_4th"  style="position:absolute;width:350px;height:345px;margin-left:0px" class="jqmDialog">
	
</div>
<div id="4th"  style="position:absolute;width:350px;height:345px;margin-left:0px" class="jqmDialog">
	
</div>
<div id="geo_win"  style="position:absolute;width:370px;height:345px;margin-left:0px" class="jqmDialog">
	
</div>
<div id="others_win"  style="position:absolute;width:370px;height:345px;margin-left:0px" class="jqmDialog">
	
</div>




<div id="layer_symbol"  style="position:absolute;width:400px;height:325px;margin-left:0px" class=" jqmDialog">
	
</div>

				<div id="print"  class="ex2trigger"></div>
		    <div id="ex_print" class="jqmDialog">
				</div>
<div id="ppol_win"  style="width:300px;height:155px" class="jqmDialog">
	
	<div class="jqmdTL">
    <div class="jqmdTR">
	<input  class="jqmdX jqmClose" >
	     <div class="jqmdTC jqDrag">Spatial Analysis (you can click and drag me)</div>

			<div id="sp_query_container"></div>
	</div>
	</div>
</div>
<div id="ex4"  style="left:350px;margin-left:0px;width:200px;height:440px"class="jqmDialog">
</div>
<div id="gbif_win"  style="left:200px;margin-left:0px;width:380px;height:325px"class="jqmDialog">
</div>

 <div id="query_result" style="margin-left:0px;" class="jqmDialog">
  <div class="jqmdTL">
    <div class="jqmdTR">

	     <div class="jqmdTC jqDrag">Query results (you can click and drag me)</div>   
	        <div id="wrapper">
	  		  <div id="query_container">					  
			   </div>
		    </div>
       </div>
  </div>
<input  class="jqmdX jqmClose">
</div>


<div id="right" style="border:3px" class="right"><div id='panel' style="z-index:30000;"></div>
<div id="map" style="top:20px;width: 700px; height: 350px;" class="right">

</div>

<script type="text/javascript">
sc_project=2722414; 
sc_invisible=0; 
sc_partition=27; 
sc_security="301c0f80"; 
sc_text=2; 
</script>
<script type="text/javascript" src="http://www.statcounter.com/counter/counter.js"></script>
<noscript><div style="visibility:hidden" class="statcounter"><a title="web analytics" href="http://www.statcounter.com/" target="_blank">
<img  style="visibility:hidden" class="statcounter" src="http://c28.statcounter.com/2722414/0/301c0f80/0/" alt="web analytics">
</a></div></noscript>

<div id="images" style='position:absolute;top:40px;border: solid 1px #000000;'></div>
<div id="escala" class=".olControlScale" style="left:40px;top:130px;"></div>
<div id="escala2"  style="width:200px;font-size:12px"></div>
<div id="coords"  style="position:absolute;width:250px;font-size:12px"></div>	

<img id="ajax_image" src='img/ajax_loading.gif' style="visibility:hidden;width:100px;position:absolute"></img>
<img id="windrose" src='../geo/images/windroses/windrose1.png' style="visibility:hidden;display:block;width:0px;position:absolute;index:20000"></img>

<img id="scalebar" src='../geo/images/legends/275.png' style="visibility: hidden; display: block; width: 200px; position: absolute; z-index: 20000;"></img>	



		
	    <div id="ex_print" class="jqmDialog">

</div>
	<!--	<table id="edit_logo">
			    <tr>
               <td><img src="http://edit.africamuseum.be/edit_wp5/web/dingen/logoEDIT.png"/><td>
		</tr>
	</table>	-->


</body>
</html>
