<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">      
<html xmlns="http://www.w3.org/1999/xhtml" >
<head>
    <title>Geoplatform MNCN - Map viewer (prototype)</title>
<script src="OpenLayers.js"></script>
<script src="proj4js/lib/proj4js.js"></script>
<script type="text/javascript" src="js_code/LoadingPanel.js"></script>
      <script src="js_code/wfs.js"></script>
<!--	   <script src="js_code/jquery.pack.js"></script>-->
<script src="jquery-1.3.2.js"></script>
	<script type="text/javascript" src="js_code2/main_s_new2.js"></script>
	<script type="text/javascript" src="js_code/ajaxfileupload.js"></script>
	 <link rel='StyleSheet' type='text/css' href='../lib/skin/default/scalebar-fat.css'><!-- This style sheet is needed for the scalebar -->
<link rel="stylesheet" href="theme/default/style2.css" type="text/css" />
	<link rel="stylesheet" href="theme/default/style_ppol.css" type="text/css" />

	<link type="text/css" rel="stylesheet" media="all" href="css/edit_test.css">
		<link type="text/css" rel="stylesheet" media="all" href="css/lightbox.css">
	<script type="text/javascript" src="http://edit.africamuseum.be/edit_wp5/geo/mapviewer/js_code/farbtastic/farbtastic.js"></script>
	<link type="text/css" rel="stylesheet" media="all" href="css/farbtastic.css">
	<link type="text/css" rel="stylesheet" media="all" href="css/tables.css">
	.olControlLoadingPanel {
	            background-image:url(img/ajax_loading.gif);
	            width:100px;

	            position:relative;
	            background-repeat:no-repeat;           
	            display: none;
	        }
	</style>
	
	<script type="text/javascript">
	    
	   var create_json=function()
{

var array=Array();

for (i=0;i<map.layers.length;i++)
{
//console.warn(map.layers[i]);
//if(map.layers[i].params.GROUP !='remote' || map.layers[i].options.GROUP=='remote')
if( map.layers[i].options.GROUP !=='remote' && map.layers[i].params.GROUP !='remote' && map.layers[i].params.GROUP !='points' )
{
if (map.layers[i].getVisibility())
{

var g=map.layers[i].params.GROUP;
var l=map.layers[i].params.LAYERS.split(',');


var labels=Array();
labels[g]=Array();
$(l).each(function(i,data)
{

l=data.substring(5);
if (l!=='blank')
{

p=$("#layers input[id='"+l+"']").next().get(0);
//p.nodeValue;
//console.warn(p);
label=p.firstChild.nodeValue;
labels[g].push(label);

}
})


array[g]=map.layers[i].params.LAYERS+"|"+map.layers[i].params.STYLES+"|"+labels[g];

//console.warn(array[g]);
}
}
}
x=array.join(',');
//array['grup']=x;

//console.info(array['remote'])
vals="";
for (key in array)
{
//console.log("for key "+key+"values  "+array[key])
vals+=key+">"+array[key]+"/";
}
//console.warn(vals);
//removing last '/'
vals=vals.substring(0,vals.length-1);
var bbox=map.getExtent().toBBOX();
var bounds=new OpenLayers.Bounds.fromString(bbox);
var zoom=map.getZoomForExtent(bounds);
$.get('http://edit.africamuseum.be/edit_wp5/geo/c_json.php?data='+vals+'&bbox='+bbox+'&zoom='+zoom,function(d)
{

		  var iframe=$('iframe#info2');

	 jq_print='<iframe id="info2" name="nom_iframe" class="jqDrag" marginWidth=0 marginHeight=0 src="" frameBorder=0 width=0 height=0></iframe>';

		$('#ex_print').html(jq_print);
			$('#ex_print').jqDrag('.jqDrag').jqResize('.jqResize') ;

		$("iframe#info2").attr("src","http://edit.africamuseum.be/edit_wp5/geo/json_show.php?file="+d);
		$("#ex_print").show();
		$("#ex_print").hide();
											
});

}


var print;
var tot="";
function print_legend ()
{
x=new Array();
i_count=$("#images img").size();

$("#images img").each(function(i,d)
{
height=$(d).css('height');
//console.log(display);
if (height!=='0pt')
{
var style=d.getAttribute("s");
total=style+","+d.id+"|";
tot+=total;
}
})
//console.log(tot);
print='legend';
$.getScript('js_code2/added_prints.js');

}
function c_legend(data)
{
//console.log(data);
var style=data.getAttribute("stylez");
var grup=data.getAttribute("grup");

if (data.checked)
{
if (grup=="tdwg" || grup=="quadricules")
		{		
		$("#layers li[id='"+grup+"'] input").each(function(i,d)
		{
		if ($("#images img[id='"+d.id+"']").length)
		{
		$("#images img[id='"+d.id+"']").height(0).hide();
		}
		if ($("#images img[id='"+data.id+"']").length)
		{
		$("#images img[id='"+data.id+"']").height('20').show();
		}else {
		if (grup=="quadricules") { 
		style=style+"_2";
		}
		path="http://193.190.223.46:8080/geoserver/wms/GetLegendGraphic?VERSION=1.0.0&FORMAT=image/png";
		path+="&LAYER="+data.id+"&STYLE="+style+"&LEGEND_OPTIONS=forceLabels:on;fontStyle:italic;fontSize:12";
		html='<ul><img s="'+style+'" style="height:20px;position: relative; left: 0px;" id="'+data.id+'" src="'+path+'"/></ul>';
		$("#images").append(html);

		}
		})
		}
else
{
if (grup=='analysis')
{
var w=$("img[id='"+data.id+"']").width();
var h=$("img[id='"+data.id+"']").height();
if($("#images img[id='"+data.id+"']").length)
{
$("#images img[id='"+data.id+"']").height(h);
$("#images img[id='"+data.id+"']").width(w).show();
}else {

path="http://193.190.223.46:8080/geoserver/wms/GetLegendGraphic?VERSION=1.0.0&FORMAT=image/png";
path+="&LAYER="+data.id+"&SLD="+eval("edit_"+data.id+".params.SLD");
html='<ul><img s="'+style+'" id="'+data.id+'" style="height:'+h+';position: relative; left: 0px;" src="'+path+'"/></ul>';
$("#images").append(html);
}
}
else
{
if (grup=="admin" && data.id !=="cities" && data.id !=="country_earth")
{
var c=$(data).parent().parent().attr('id');

var sld="http://edit.africamuseum.be/edit_wp5/geo/layers_sld/admin_legend.php?l="+data.id+"/"+c;

if($("#images img[id='"+data.id+"']").length)
{
$("#images img[id='"+data.id+"']").height('20').show();
}else {
path="http://193.190.223.46:8080/geoserver/wms/GetLegendGraphic?VERSION=1.0.0&FORMAT=image/png";
path+="&LAYER="+data.id+"&SLD="+sld+"&LEGEND_OPTIONS=forceLabels:on;fontStyle:italic;fontSize:12";

html='<ul><img s="'+style+'" style="height:20px; position: relative; left: 0px;" id="'+data.id+'" src="'+path+'"/></ul>';
$("#images").append(html);
}
}
else
{

if($("#images img[id='"+data.id+"']").length)
{
$("#images img[id='"+data.id+"']").height('20').show();
}else {
path="http://193.190.223.46:8080/geoserver/wms/GetLegendGraphic?VERSION=1.0.0&FORMAT=image/png";
path+="&LAYER="+data.id+"&STYLE="+style+"&LEGEND_OPTIONS=forceLabels:on;fontStyle:italic;fontSize:12";
html='<ul><img s="'+style+'" style="height:20px; position: relative; left: 0px;" id="'+data.id+'" src="'+path+'"/></ul>';
$("#images").append(html);
}
}
}
}
}
else {   //we are unchecking

$("#images img[id='"+data.id+"']").height('0').hide();

}
}
userid=Math.floor(Math.random()*1000);
	    bind=function()
		{

t=$("#map").position().top+$("#map").height();
l=$("#map").position().left;
$("#escala,#escala2").css({position:'absolute'});

 if ($.browser.version!=='6.0')
 {
$("#escala").css('top',t).css('left',l+50);
$("#escala2").css('top',t).css('left',l+250);
$("#coords").css('top',t).css('left',l+$("#map").width()-200);
$("#image").css('top',$("#map").position().top+(($("#map").height()/2)-75)).css('left',l+(($("#map").width()/2)-75));
}else
{
$("#escala").css('top',t-40).css('left',l+50);
$("#escala2").css('top',t-40).css('left',l+250);
$("#coords").css('top',t-40).css('left',l+$("#map").width()-200);
}

$(".olControlLayerSwitcher ").hide();

ajax_show=false;
//w=parseInt($(window).width());
/*
w=screen.width;
switch (screen)
{
case '1280': $("#map").width('850');
			$("#map").height('425'); break;
}*/
/*
$.get('http://edit.africamuseum.be/edit_wp5/geo/check.php?userid='+userid,function() {

ajax_show=true;
});*/

$("#user_dates").hide();
$("#gbif").hide();
 change2=function(d)
{
if (d.css('display')=='none')
{
d.animate({opacity:1,"height":"+=50px"}, 'slow',function()
{
d.css({color:'blue'});
})
d.animate({"height":"-=50px"},2000,function()
{
d.css({color:'black'});
})
}else {
i=d.get(0);
//console.log(i);
id=i.getAttribute('id');

if (id !=="download_data" && id !=="user_dates")
{
if (id=='analysis')
{
$("interactive_analysis").fadeOut('slow');
}
d.fadeOut('slow');

}

}
}
change=function(i)
{

if ($(i).hasClass('visible'))
{
$(i).children().text('Hide module');
$(i).removeClass('visible');
}
else
{
$(i).children().text('Show module');
$(i).addClass('visible');
}
//console.log($(i.target));
i=$(i).get(0);
//alert($(i.target).id);
id=i.getAttribute('id');
if (id=='analysis_m')
{

if ($("#user_dates").css('display')=='none')
{
alert("you must first upload point data");
$(i).children().text('Show module');
}
else {
change2($("#analysis"));

}
}
if (id=='query_m')
{
if ($(".olControlEditingToolbar").css('visibility')=='visible')
{
//alert("hide it");
$(".olControlEditingToolbar").css({visibility:'hidden'});
$(".olControlEditingToolbar div").css({visibility:'hidden'});
$(".olControlFeatureInfoItemActiveItemInactive").width('0').height('0').css({visibility:'hidden'});
$(".olControlFeatureInfo2ItemInactive").width('0').height('0').css({visibility:'hidden'});
}
else
{

$(".olControlEditingToolbar").css({visibility:'visible'});

$(".olControlEditingToolbar div").css({visibility:'visible'});

$(".olControlFeatureInfoItemActiveItemInactive").width('30').height('30').css({visibility:'visible'});
$(".olControlFeatureInfo2ItemInactive").width('30').height('30').css({visibility:'visible'});
}
}
if (id=='gbif_m')
{
change2($("#gbif"));
}

}		
$('#overlays_div input').click(function(){

$("input[name='Polygon to query']").hide().next().hide();
})
//$("input[id='OpenLayers.Control.LayerSwitcher_114_input_serialized_polygons']").hide().next().hide();

$("input[name='Polygon to query']").hide().next().hide();
$("input[name='Your symbolized polygons']").hide().next().hide();
$("input[name='Polygon layer']").hide().next().hide();

 $(".olControlEditingToolbar div").bind('click',function(event){

x=function() {v_select.deactivate();$("#interactive_analysis input").attr('checked',false); vectors.setVisibility(false);}

y=function () {}
$("#polygon_info_input").is(':checked')?x():y();
	if ($(event.target).attr('class')=='olControlDrawFeaturePolygonItemActive')
						{
						
						if (polygonLayer.map==null)
						{
						map.addLayer(polygonLayer);
						}
		//	console.log("the tool for polygon symbolizing");
					polygonLayerControl.activate();
					} else {
					
			if ($(event.target).attr('class')=='olControlNavigationItemActive')
			{
		//	console.log("querying draw polygons");
			pan.deactivate();
			feature_select.activate();
		//	draw_to_query.activate();
			}
					if (polygonLayerControl.activate)
					{
					polygonLayerControl.deactivate();
					}
					

		}
})


			$("div[id='panel'] > div").bind('click',function(event){
			//console.log($(event.target).attr('class'));

x=function() {v_select.deactivate();$("#interactive_analysis input").attr('checked',false); vectors.setVisibility(false);}

y=function () {}
$("#polygon_info_input").is(':checked')?x():y();

draw_symbolize.deactivate();draw_to_query.deactivate();
						if ($(event.target).attr('class')=='olControlFeatureInfo2ItemActive')
						{
							
							$.getScript('js_code/old_stuff/individual_ppol_adaptat.js');
						}
						
						if ($(event.target).attr('class')=='olControlPanZoomBarItemActive')
						{
						//console.log("panning");
						 if (vlayer.features.length >1) {vlayer.destroyFeatures(vlayer.features[0])};
						draw_symbolize.deactivate();draw_to_query.deactivate();
pan.activate();
						}

if (polygonLayerControl.activate)
					{
					polygonLayerControl.deactivate();
					}
/*if (drawControls['polygon'].activate)					{
					drawControls['polygon'].deactivate();
					} */

						});
						$(".olControlEditingToolbar div").click(function(){
				
						map.addLayer(vlayer);
				
						});
		
//	user="no_user";
}  //end bind
	  
function ajaxFileUpload(type)
	{
	ajax_show=true;
		$("#loading")
		.ajaxStart(function(){
			$(this).show();
		})
		.ajaxComplete(function(){
			$(this).hide();
		});

var new_data='no';

if (type=='points')
{
datatype='points';
id='file';

if ($("#upload_content input:checked").attr('id')=='new_data')
{
userid=Math.floor(Math.random()*1000);
new_data='yes';
}
lat=$("#lat").val();
lon=$("#lon").val();
fields=$("#fields").val();
url='http://edit.africamuseum.be/edit_wp5/geo/doajaxfileupload.php?userid='+userid+'&new_data='+new_data+'&lon='+lon+'&lat='+lat+'&fields='+fields;

}
else  //uploading json
{
datatype='json';
id='json_file';
url='http://edit.africamuseum.be/edit_wp5/geo/upload_json.php';
my_json="true";
}
	$.ajaxFileUpload
		(
			{
				url:url,
				secureuri:false,
				fileElementId:id,
				dataType: 'json',
				success: function (data, status)
				{
					if(typeof(data.error) != 'undefined')
					{
						if(data.error != '')
						{
							alert(data.error);
						}else
						{
						
						

			if (datatype=='points')
			{		
			x=new Date();
			if (edit_points.map==null)
			{
			
			edit_points.params.SLD=data.data;
			map.addLayer(edit_points);
		 
			}
			else
			{
		
			edit_points.params.SLD=data.data;
			var image=document.getElementById("legend");
			image.setAttribute("src",legend='http://193.190.223.46:8080/geoserver/wms/GetLegendGraphic?VERSION=1.0.0&FORMAT=image/png&WIDTH=25&HEIGHT=20&LAYER=user_points&sld='+edit_points.params.SLD+'?date='+x);
	
			}
		
				

		u_bbox=data.bbox;
//		console.log(edit_points.params.SLD);
 var bounds=new OpenLayers.Bounds.fromString(u_bbox);	

	center=bounds.getCenterLonLat();

	 map.setCenter(center,map.getZoomForExtent(bounds));
	 
$("#user_dates").click(function()
{x=new Date();
		var image=document.getElementById("legend");
console.warn(edit_points.params.SLD);
console.log('http://193.190.223.46:8080/geoserver/wms/GetLegendGraphic?VERSION=1.0.0&FORMAT=image/png&WIDTH=25&HEIGHT=20&LAYER=user_points&sld='+edit_points.params.SLD+'?date='+x);
			image.setAttribute("src",'http://193.190.223.46:8080/geoserver/wms/GetLegendGraphic?VERSION=1.0.0&FORMAT=image/png&WIDTH=25&HEIGHT=20&LAYER=user_points&sld='+edit_points.params.SLD+'?date='+x);

});
map.setCenter(bounds.getCenterLonLat(),map.getZoomForExtent(bounds));

		 change2($("#user_dates"));
		 change2($("#download_data"));
//		 		$("#upload_data").trigger('click');
		  $("#upload_data").trigger("click");
		   $("#user_dates").trigger("click");
		//  $.get('http://edit.africamuseum.be/edit_wp5/geo/check2.php?userid='+userid);
						}
				else
				{
			
				getlayers('user_json/'+data.data);
				}
		
				}
					}
		ajax_show=false;
$("#image").hide();
							
				} //end success for points
			,
				error: function (data, status, e)
				{
				//console.log(data);
					alert(e);
				}
			}
		)
		
		return false;

	} //end ajaxfile upload??
//user_info="true";  // em sembla falta }


	 new_user=Math.floor(Math.random()*1111)    
	user_info="false";
	
	
	toogle_mode=function(mode)
{
if (mode=='print')
{
edit_admin.tileSize.w=map.size.w;
edit_admin.tileSize.h=map.size.h;
edit_admin.ratio=1;
edit_admin.singleTile= true;
/*
edit_tdwg.tileSize.w=map.size.w;
edit_tdwg.tileSize.h=map.size.h;
edit_tdwg.ratio=1;
edit_tdwg.singleTile= true;
*/
}else {
/*
edit_tdwg.tileSize.w=1050;
edit_tdwg.tileSize.h=525;
edit_tdwg.ratio=1.5;
edit_tdwg.singleTile= false;
*/
edit_admin.tileSize.w=1050;
edit_admin.tileSize.h=525;
edit_admin.ratio=1.5;
edit_admin.singleTile= false;
}
edit_admin.redraw()
}

 var set_Visible=function (data)
	 {
	 	if (data.checked==true)
		{
	//	console.log("edit_"+data.id+".setVisibility(true)")
	eval(data.id+".setVisibility(true)");
//		wms_ms.setVisibility(true);
		//console.log("wms_ms.setVisibility(true)");
		}
		else
		{
		eval(data.id+".setVisibility(false)");
		//wms_ms.setVisibility(false);
		}
	 }

		toogle_gbif=function(data)
	{
	if (data.checked==true) {
	edit_gbif.setVisibility(true);
	}
	else
	{

		edit_gbif.setVisibility(false);
	}
	}	
	
	 toogle_simple=function(data,grup)
		{
	//	console.warn("simple toogle");
	ajax_show=true;		
	    var layer="edit_"+data.id;
		var style=data.getAttribute("stylez");
		var grup=data.getAttribute("grup");
	
		if (data.checked==true)
		{
	//console.log(data.id+"checked")
		//"symbolize this layer"
		var nexts=$(this).next().nextAll();
		$(nexts).css('visibility','hidden');
		$("#layers input[id='"+data.id+"']").next().next().css('visibility','visible');
		var ul=$(data).parent(); 
		$(ul).css('height','40');
		
		
		if ($("#ppol_form").length)
		{
		//console.log("yes");
		p=$("input[id='"+data.id+"']").next().get(0);
		label=p.firstChild.nodeValue;
		extra="<option id='"+data.id+"'>"+label+"</option>";
		$("#ppol_form select").append(extra);
		}
		
		if (grup!=="admin" && grup!=="nature")
		{
	//HIDDING OTHERS	
	//console.log("we hide");
$("#layers input:checked[grup='"+grup+"']").each(function()
{
var checked=$(this).attr('checked');
var s_layer=$(this).attr('id');

if ($(this).hasClass('symbolized'))
{
eval("edit_"+s_layer+".setVisibility(false)")
}
else
{
$("#layers input[id='"+s_layer+"']").trigger('click');
$("#layers input[id='"+s_layer+"']").trigger('click');
}
})
//eval("edit_"+layer+".setVisibility(true)")

		$("#layers input:checkbox[grup="+grup+"]").attr('checked',false);		
		data.checked=true;
		$("#layers li[id='"+grup+"'] input:not(:checked)").each(function()
		{
//		console.log("unchecking others");
var nexts=$(this).next().nextAll();
var ul=$(this).parent(); 

if (nexts.length > 0)
{
//console.log(nexts.length)
$(nexts).css('visibility','hidden')
$(ul).css('height','20');
		}
		})

		}
//		console.log("visualize it"+layer);
		eval(layer+".setVisibility(true)");
		}else
		{
		$("#layers input[id='"+data.id+"']").next().next().css('visibility','hidden');
		var ul=$(data).parent(); 
		$(ul).css('height','20');
		eval(layer+".setVisibility(false)");
		if ($("#ppol_form").length)
		{
		
		$("#ppol_form option[id='"+data.id+"']").remove()
		} 
		}
		}
		
 toogle=function(data)
		{

//console.log("toogling");
     	ajax_show=true;
		var grup=data.getAttribute("grup");
	    var layer="edit_"+grup;
		var style=data.getAttribute("stylez");
		var array=eval("edit_"+grup+".params.LAYERS");
		var styles_array=eval("edit_"+grup+".params.STYLES");

	
	function isArray(variable) {
if (variable.constructor == Array)
return true;
else
return false;
}
if (isArray(array))
{
//alert("array");
}
else
{
//alert("not array");
array=array.split(',');
styles_array=styles_array.split(',');
}
//console.warn(array);

var update=function(val,style)
	{
x=$.grep(array,function (v)
{
//console.log(v+" v is and val"+val);
if (v==val)
{
//alert("to remove"+v);
index=$.inArray(v,array);
return index;
}
else
{
//console.info(v+"not equal to"+val);
return val;

}
});

//console.warn(typeof(index));

if(typeof(index) !== 'undefined')  
{
array.splice(index,1);
styles_array.splice(index,1);
//console.log("lenght is"+array.length);
if (array.length > 0)
{
eval("edit_"+grup+".mergeNewParams({layers:'"+array+"'})");
eval("edit_"+grup+".mergeNewParams({styles:'"+styles_array+"'})");
//if ("edit_"+grup+".params.length" > 0)
} else { 
  		eval("map.removeLayer(edit_"+grup+")");
//eval("edit_"+grup+".setVisibility(false)");
			eval("edit_"+grup+".params.LAYERS=[]");
			eval("edit_"+grup+".params.STYLES=[]");
			}

}
else
{
array.push(val);
styles_array.push(style);
//TAMBÃ‰ STYLE HAURIA DE SER PUSHAT
eval("edit_"+grup+".mergeNewParams({layers:'"+array+"'})");
eval("edit_"+grup+".mergeNewParams({styles:'"+styles_array+"'})");

}
var index=undefined;
		}//fi funcio

	if (data.checked==true)  //volem visualitzar
		{
		count=array.length;
        
/*
if ($("#layers [id='"+data.id+"']").next().next().attr('id')=='symbolize')
{
$("#layers [id='"+data.id+"']").next().next().css('visibility','visible')
}
*/

		if ($("#ppol_form").length)
		{
		//console.log("yes");
		p=$("input[id='"+data.id+"']").next().get(0);
		label=p.firstChild.nodeValue;
		extra="<option id='"+data.id+"'>"+label+"</option>";
		$("#ppol_form select").append(extra);
		}
									
		if (layer.map==null)
			{

		eval("map.addLayer("+layer+")");

			}
		if (! eval("edit_"+grup+".getVisibility()"))
	{
	eval("edit_"+grup+".setVisibility(true)");
	}		
		
		if (grup!=="admin" && grup!=="nature")
		{
		//ONLY A LAYER CAN BE SELECTED; WE HAVE TO HIDE LABEL AND SYMBOLOGY OPTIONS WHEN NOT SELECTED

$("#layers input:checked[grup='"+grup+"']").each(function()
{
var checked=$(this).attr('checked');
var layer=$(this).attr('id');
if ($(this).hasClass('symbolized'))
{
c="edit_"+layer+".setVisibility(false)";
eval(c)
}

})
		$("#layers input:checkbox[grup="+grup+"]").attr('checked',false);
				

		data.checked=true;		       
		$("#layers li[id='"+grup+"'] input:not(:checked)").each(function()
		{
var nexts=$(this).next().nextAll();
var ul=$(this).parent(); 

if (nexts.length > 0)
{
//console.log(nexts.length)
$(nexts).css('visibility','hidden')
$(ul).css('height','20');
		}
		})
		eval(layer+".mergeNewParams({layers:'"+data.id+"'})");
		if (grup=="quadricules")
			{
	
			//so we avoid to create different grids styles (SLD) when they use the same symbology
			//we keep grid1, grid2, grid5 stylez in order to get the legend 
			switch (screen_w)
			{
				case 'medium1': style="grids_m";break;
				case 'medium2':	style="grids_label_m2";break;
				case 'big':	style="grids_b";break;
				
			}
		
				eval("edit_quadricules.mergeNewParams({layers:'"+data.id+","+data.id+"_line'})");
						eval(layer+".mergeNewParams({styles:'nl_grids,"+style+"'})");	
				edit_quadricules.setVisibility(true);
			}


		}
		else
			{
			update(""+data.id,style);
			}

	}
	else
	{  //NOT CHECKED
   /*  if (data.id=='country_earth')
{
map.setBaseLayer(edit_blank);
}*/
		if ($("#ppol_form").length)
		{
		
		$("#ppol_form option[id='"+data.id+"']").remove()
		} 
	update(""+data.id,style);

	}
		}
		
	
	        var map;

        
		 if ($.browser.version=='6.0')
{
t_img_format='image/png8';
} else { t_img_format='image/png'; }


	edit_points = new OpenLayers.Layer.WMS.Untiled( "third field points","http://193.190.223.46:8080/geoserver/wms", {GROUP:'points',layers:'user_points',sld:'',format:t_img_format,transparent:"true"});
		/*	var edit_nasa = new OpenLayers.Layer.WMS( "NASA Global Mosaic",
				                "http://wms.jpl.nasa.gov/wms.cgi?", 
				                {layers: "global_mosaic",transparent:"false",GROUP:"remote"},{'displayInLayerSwitcher':true,isBaseLayer: true});
			*/	                
		
		

		
			var edit_blank = new OpenLayers.Layer.WMS.Untiled( "EDIT WMS transparent",
			"http://193.190.223.46:8080/geoserver/wms",
			                {layers:"blank",transparent:"false",format: t_img_format,styles:"transparent",group:"remote"},
						{'displayInLayerSwitcher':true,isBaseLayer: true},{singleTile: true, ratio: 1});
						
			

			var ol_wms = new OpenLayers.Layer.WMS( "OpenLayers WMS",
	                "http://labs.metacarta.com/wms/vmap0",
	                {layers: 'basic',opacity:1, group:'remote'},{opacity:1},{'displayInLayerSwitcher':false} );

		edit_blank = new OpenLayers.Layer.WMS( "EDIT WMS transparent",
			"http://193.190.223.46:8080/geoserver/wms",
			                {layers:"blank",transparent:"false",format: t_img_format,styles:"transparent",group:"remote"},
						{isBaseLayer: true},{singleTile: true, ratio: 1});
	
	edit_quadricules = new OpenLayers.Layer.WMS.Untiled( "Quadricules",
		"http://193.190.223.46:8080/geoserver/wms",
		                {layers:[],width:'700',height:'350',transparent:"true",styles:[],format:t_img_format,GROUP:'quadricules'}
						, {group:"vectorial"},{'displayInLayerSwitcher':true},{gutter: 1} );
	edit_nature = new OpenLayers.Layer.WMS.Untiled( "Natural features",
		"http://193.190.223.46:8080/geoserver/wms",
		                {layers:[],GROUP:"nature",transparent:"true",styles:[],format:t_img_format}
						,{'displayInLayerSwitcher':true} );

	edit_utm = new OpenLayers.Layer.WMS.Untiled( "UTM layer",
		"http://193.190.223.46:8080/geoserver/wms",
		                {layers:[],transparent:"true",styles:[],group:"utm",format:t_img_format}
						, {group:"vectorial"},{'displayInLayerSwitcher':true} );
						
	edit_admin = new OpenLayers.Layer.WMS.Untiled( "EDIT WMS",
                "http://193.190.223.46:8080/geoserver/wms",
                {layers: [],group:"admin",transparent:"true",format:t_img_format,styles:[],
                width:'700',height:'350'});
             //   console.warn(edit_admin);

	  edit_tdwg = new OpenLayers.Layer.WMS.Untiled( "TDWG layer",
		"http://193.190.223.46:8080/geoserver/wms",
		                {layers:[],group:"tdwg",transparent:"true",styles:[],format:t_img_format});


      edit_admin.mergeNewParams({styles:'new_countries'});      

      edit_admin.setVisibility(true);
		


	     edit_tdwg = new OpenLayers.Layer.WMS( "TDWG layer",
		"http://193.190.223.46:8080/geoserver/wms",
		                {layers:[],group:"tdwg",transparent:"true",styles:[],format:t_img_format}
						,{'displayInLayerSwitcher':true} );
 
    		var ms_url = "http://edit.africamuseum.be/cgi-bin/mapserv?map=/var/www/synthesys/www/geo/mapserver_data/test.map";
			var shoreline = new OpenLayers.Layer.MapServer("Estados y Municipios",ms_url,{layers: "shoreline", transparent: true, format: "image/png",GROUP: "remote"});
	/*		var s_america1 = new OpenLayers.Layer.MapServer("High resolution administrative layer",ms_url,{layers: "s_america1", transparent: true, format: "image/png"});
			var s_america2 = new OpenLayers.Layer.MapServer("High resolution administrative layer",ms_url,{layers: "s_america2", transparent: true, format: "image/png"});
			var oceania1 = new OpenLayers.Layer.MapServer("High resolution administrative layer",ms_url,{layers: "oceania_level_1", transparent: true, format: "image/png"});
			var oceania2 = new OpenLayers.Layer.MapServer("High resolution administrative layer",ms_url,{layers: "oceania_level_2", transparent: true, format: "image/png"});
 		*/
				var edit_num_regs = new OpenLayers.Layer.WMS.Untiled( "Number of Records",
		"http://193.190.223.46:8080/geoserver/wms",
		                {layers:'num_regs',transparent:"true",styles:[],format: t_img_format,group:'quadricules'}
						, {group:"vectorial"},{'displayInLayerSwitcher':true} );
				
				var edit_taxa_record = new OpenLayers.Layer.WMS.Untiled( "Taxa/Record",
		"http://193.190.223.46:8080/geoserver/wms",
		                {layers:'taxa_record',transparent:"true",styles:[],format:t_img_format,group:'quadricules'}
						, {group:"vectorial"},{'displayInLayerSwitcher':true} );
						
				var edit_num_genus = new OpenLayers.Layer.WMS.Untiled( "Number of Genera",
		"http://193.190.223.46:8080/geoserver/wms",
		                {layers:'num_genus',transparent:"true",styles:[],format:t_img_format,group:'quadricules'}
						, {group:"vectorial"},{'displayInLayerSwitcher':true} );

			taxa_id=13212109;
			gbif_filter=function(taxa_id)
			{ return "(<Filter><And><PropertyIsEqualTo><PropertyName>type</PropertyName><Literal>1</Literal></PropertyIsEqualTo><PropertyIsEqualTo><PropertyName>concept</PropertyName><Literal>"+taxa_id+"</Literal></PropertyIsEqualTo></And></Filter>)";
			}
				var edit_gbif = new OpenLayers.Layer.WMS( "GBIF",
                "http://geoserver.gbif.org/wms?", {group:"remote",layers: "gbif:gbifDensityLayer",version: "1.0.0", transparent: "true", 
                format:t_img_format, filter: gbif_filter(taxa_id),opacity:0.5} );	
             edit_gbif.setOpacity (0.5) 
             
				var edit_nasa = new OpenLayers.Layer.WMS( "NASA Blue Marble BMNG",
										"http://wms.jpl.nasa.gov/wms.cgi?", {group:"remote",layers: 'global_mosaic',
											format: 'image/png'},{opacity:1},
										{isBaseLayer: true});														



var toogle_background=function(d)
	{

	if (d.map==null)
	{
	map.addLayer(d);
map.setBaseLayer(d)
d.redraw();
	}
else 
{

        map.setBaseLayer(d)
        d.redraw();
}
	
	}
	var g,drawControls; 
	
	   function v_toggle(element) {

                if(element.checked==true) {
vectors.params.filter="<Filter><And><PropertyIsEqualTo><PropertyName>userid</PropertyName><Literal>"+userid+"</Literal></PropertyIsEqualTo></And></Filter>";
//					  v_select.activate();
					 if  ($("#interactive_analysis_input").hasClass("first"))

	             {

	            	             map.addLayer(vectors);
	            
	              
	              $("#interactive_analysis_input").removeClass('first');
	             }
                   else {  
                   
                   vectors.setVisibility(true);
                  
                   } 
                  v_select.activate();
                  
                } 
                else 
                {              
                vectors.setVisibility(false);

                    v_select.deactivate();
            }
        }
        myStyles2 = new OpenLayers.StyleMap({
                "default": new OpenLayers.Style({                   
                    fillColor: "#ebbc1e",
					fillOpacity:0.25,
					strokeColor: "#242b32",
                    strokeWidth: 1.5
                }),
                "select": new OpenLayers.Style({
                    fillColor: "#ee3e3a", //vermell
                    fillOpacity:0.5,
                    strokeWidth: 2,
                    strokeColor: "#3399ff"
                })

            });
            

            	   vectors = new OpenLayers.Layer.WFS(
    "My polygons to hover",
    "http://193.190.223.46:8080/geoserver/wfs",
    {typename: "point_pol",
    filter:"<Filter><And><PropertyIsEqualTo><PropertyName>userid</PropertyName><Literal>"+userid+"</Literal></PropertyIsEqualTo></And></Filter>"},
    {isBaseLayer: false, extractAttributes: true, styleMap: myStyles2}
);


	     function init(){
	            // no pink please
      
    //  alert("initint");
	  
	    vlayer = new OpenLayers.Layer.Vector( "Polygon to query",{GROUP:"remote"});
	     draw= new OpenLayers.Control.EditingToolbar(vlayer);

	     			var options={	controls: [
 					new OpenLayers.Control.LayerSwitcher({'ascending':false}),				
 				//	new OpenLayers.Control.OverviewMap(),
 					draw
 				//	new OpenLayers.Control.KeyboardDefaults()
 				], tileSize:new OpenLayers.Size(500, 500),projection: new OpenLayers.Projection("EPSG:4326"),
 				 maxResolution: "auto",maxExtent:new OpenLayers.Bounds(-180,-90,180,90)
				};

	         map = new OpenLayers.Map('map',options);
  				var controls2 = map.getControlsByClass('OpenLayers.Control.Navigation');
			//	console.warn(draw.controls.length)
				for(var i = 0; i<controls2.length; ++i)
				{
					controls2[i].disableZoomWheel(); 
				}

//  OpenLayers.ProxyHost="http://edit.africamuseum.be/edit_wp5/edit_geo/proxy?url=";



       v_options = {
               hover: true,
               onSelect: function(feature) { 
//             console.warn(feature.attributes.code);
  if ($("#polygon_info").length)
         {
         $("#polygon_info tr").each(function(i)
{
$(this).remove();


})

  			$("#polygon_info tbody").append('<tr><td>Polygon code: </td><td>'+feature.attributes.code+'</td></tr><tr><td>Number of genus: </td><td>'+feature.attributes.numtax+'</td></tr><tr><td>Number of records: </td><td>'+feature.attributes.numreg+'</td></tr><tr><td>Taxa/record: </td><td>'+feature.attributes.taxa_record+'</td></tr>'); 

              
               }
 
}
            };
            v_select = new OpenLayers.Control.SelectFeature(vectors, v_options);
            map.addControl(v_select);
            v_select.handlers.feature.stopDown = false;

            v_select.handlers.feature.stopUp = false;

	    			 g = new OpenLayers.Format.GML();
	
	    serialized = new OpenLayers.Layer.WMS.Untiled( "Your symbolized polygons",
			        "http://193.190.223.46:8080/geoserver/wms", {layers:'serialized_pols',GROUP:'remote',sld: 'http://edit.africamuseum.be/synthesys/www/fitxers/sld/transparent_pols.sld',transparent:"true",format:t_img_format},{opacity:1},{'reproject': false});

		//polygonLayer.features.attributes.color='#f9cac3';
		
		 myStyles = new OpenLayers.StyleMap({
		          "first": new OpenLayers.Style({
                  //  pointRadius: "20", // sized according to type attribute
                    fillColor: "#bcf099",
                    strokeColor: "#3399ff",
                    strokeWidth: "2",
                     fillOpacity: "0.5"

                }),
                "default": new OpenLayers.Style({
                    pointRadius: "20", // sized according to type attribute
                    fillColor: "${color}",
                    fillOpacity: "${fillOpacity}",
                    strokeColor: "${strokeColor}",
                    strokeWidth: "${strokeWidth}",
                    strokeDashstyle: "${strokeDashstyle}"
                }),
                "select": new OpenLayers.Style({
                    fillColor: "##baa2e2",
                    strokeColor: "#3399ff",
                    fillOpacity: "0.5"
                })
                })
           
           pointLayer = new OpenLayers.Layer.Vector("Point Layer",{styleMap: myStyles},{GROUP:"remote"});
           polygonLayer = new OpenLayers.Layer.Vector("Polygon Layer",{GROUP:"remote"},{styleMap: myStyles["first"]});
  
  	    
	      
        var id=0;
        var gml_serialize=function (feature)
        {
//        alert("sfd");

polygonLayer.setVisibility(true);

 

if (polygonLayer.features.length == 0) {id=0; } else { id=(polygonLayer.features.length -1);}
polygonLayer.features[id].fid=id;

  html='<div id="polygon_symbolize" class="jqmdTL" style="background-size: 40%; z-index: 300;"><div class="jqmdTR"><div class="jqmdTC jqDrag">POLYGON SYMBOLIZER TOOL</div><input type="image" class="jqmdX jqmClose"/>';
  html+='<form id="fill_form"><label>Polygon fill color<select style="margin-left:20px;"><option value="e4381b">red</option><option value="252ab6">blue</option><option value="617589">grey</option><option value="6ef028">green</option></select></form>';
 html+='<form id="opacity_form"><label>Polygon opacity<select style="margin-left:20px;"><option value="1">100%</option><option value="0.5">50%</option><option value="0.3">30%</option><option value="0.1">10%</option><option value="0.01">0%</option></select></form>';
  html+='<form id="stroke_width_form"><label>Stroke width<select style="margin-left:20px;"><option value="1">1</option><option value="2">2</option><option value="5">5</option></select></form>';
  html+='<form id="stroke_color_form"><label>Polygon stroke color<select style="margin-left:20px;"><option value="e4381b">red</option><option value="252ab6">blue</option><option value="617589">grey</option><option value="6ef028">green</option></select></form>';
    html+='<form id="stroke_opacity_form"><label>Stroke opacity<select style="margin-left:20px;"><option value="1">100%</option><option value="0.5">50%</option><option value="0">0%</option></select></form>';
  html+='<form id="stroke_style_form"><label>Stroke style<select style="margin-left:20px;"><option value="solid">solid</option><option value="2_3">dotted</option><option value="2_7">long dotted</option><option value="4_2">short dash</option><option value="5_7">dashed</option><option value="10_5">long dashed</option><option value="10_30">Very long dashed</option></select></form>';
  html+='<br><br><p>If desired, add a text to your polygon</p><br><TEXTAREA id="label" COLS=40 ROWS=3></TEXTAREA>';
  html+='<form id="text_size_form"><label>Select the text size <select style="margin-left:20px;"><option value="5">5</option><option value="10">10</option><option value="30">30</option><option value="40">40</option></select></form>';
  html+='<form id="text_style_form"><label>Select the text font <select style="margin-left:20px;"><option value="Verdana">Verdana</option><option value="Times New Roman">Times New Roman</option><option value="Helvetica">Helvetica</option></select></form>';
  html+='</div><br> <input type="button" value="print it" id="serialize"/><div class="jqmdTC jqDrag">POLYGON SYMBOLIZER TOOL</div>';

  if ($('#fill_form').length > 0)
        {
  $('#ex4').empty();        
  $('#ex4').append(html);
  }
  else {  $('#ex4').append(html);}
 	$('input.jqmdX').hover(function(){
         $(this).addClass('jqmdXFocus')},function(){  $(this).removeClass('jqmdXFocus')}).focus(function(){this.hideFocus=true;$(this).addClass('jqmdXFocus')}).blur(function(){$(this).removeClass('jqmdXFocus')}).click(function(){$('#ex4').empty().hide();
		});
 msie=($.browser.msie==true)?true:false; 
if (msie)
{

 $('input.jqmdX').css('background','url(http://edit.africamuseum.be/edit_wp5/edit_geo/prototype/JQ_win_files/close.gif)  no-repeat top left').css('width','15px');
}
else 
{
$('input.jqmdX').css('background','url(http://edit.africamuseum.be/edit_wp5/edit_geo/prototype/JQ_win_files/close.gif) no-repeat top left');
}
$('input.jqmdX').hover(function(){$(this).addClass('jqmdXFocus')},function(){ $(this).removeClass('jqmdXFocus')}).focus(function(){this.hideFocus=true;$(this).addClass('jqmdXFocus')}).blur(function(){$(this).removeClass('jqmdXFocus')}).click(function(){$('#ex2').hide(); 
 });
   $("#ex4") .jqDrag('.jqDrag')
	   .jqResize('.jqResize') ;

$("#ex4").animate({width:'420',height:'415'},"slow");
            
            feature.attributes = {};

$("#ex4 input:button").click(function()
{

//defining the Feature in GML
       feature.attributes['fill_color'] = $("#fill_form option:selected").val();  
       feature.attributes['fill_opacity'] = $("#opacity_form option:selected").val(); 
       feature.attributes['stroke_color'] = $("#stroke_color_form option:selected").val();
               feature.attributes['stroke_opacity'] =  $("#stroke_opacity_form option:selected").val();
       feature.attributes['stroke_width'] = $("#stroke_width_form option:selected").val();
       feature.attributes['text_size'] = $("#text_size_form option:selected").val();
       feature.attributes['text_font'] =  $("#text_style_form option:selected").val();

       
      // = $("#stroke_style_form option:selected").val();
     switch ($("#stroke_style_form option:selected").val())
     {
    case 'solid': { feature.attributes['stroke_style']='no_style';break}
     	case '2_3':{ feature.attributes['stroke_style']="2 3 2 3";break;}  //short dotted 
		case '2_7':{ feature.attributes['stroke_style']="2 7 2 7";break;} //long dotted
			case '4_2':{ feature.attributes['stroke_style']="4 2 4 2";break;}
				case '5_7':{feature.attributes['stroke_style']="5 7 5 7";break;}
				case '10_5':{ feature.attributes['stroke_style']="10 5 10 5";break;}
					case '10_30':{ feature.attributes['stroke_style']="10 30 10 30";break;} //very long dash
     }
       feature.attributes['label'] = $("#label").val();
       feature.attributes['id'] = id;

//definint polygonLayer
    polygonLayer.features[id].attributes.color=$("#fill_form option:selected").val();    
    polygonLayer.features[id].attributes.fillOpacity=$("#opacity_form option:selected").val();
 polygonLayer.features[id].attributes.strokeColor=$("#stroke_color_form option:selected").val();
 polygonLayer.features[id].attributes.strokeWidth=$("#stroke_width_form option:selected").val();
  polygonLayer.features[id].attributes.strokeDashstyle=$("#stroke_style_form option:selected").val();

           polygonLayer.redraw();
         //g variable is... new OpenLayers.Format.GML(); 
   var data = g.write(feature.layer.features);  //ALL THE FEATURES will be written in g (& data) variable-->GML-->SLD
            //OpenLayers.Util.getElement("gml").value = data;
   var wkt= new OpenLayers.Format.WKT(map.baseLayer.projection);
	to_insert = wkt.write(feature);

	$.ajax({url:'http://edit.africamuseum.be/edit_wp5/geo/queries/data_insert.php',
						processData:false, type:'GET',dataType:'text',data:'data='+to_insert+'&gid='+id+'&user='+userid,success:function()
						{
					//	alert("polygon inserted on dbase");
						//let's create SLD
        $.ajax({url:'http://edit.africamuseum.be/edit_wp5/geo/gml_sld.php',
						processData:false, type:'POST',dataType:'text',data:'data='+data+'&user='+userid,
						success:function(url)
						{
						serialized.params.SLD=url;
						if (serialized.map==null)
						{
						map.addLayer(serialized);
						}
						else{						
						serialized.redraw();
						}
						polygonLayer.setVisibility(false);
						}
						})
						}
						});
 
$("input[name='Your symbolized polygons']").show().next().show();
             //var text = format.write(doc);
  })
						
        } //end serialize function
   vlayer.onFeatureInsert =function(){
      $("input[name='Polygon to query']").show().next().show();
   if (vlayer.features.length >1) {vlayer.destroyFeatures(vlayer.features[0])};
   ppol_query="false";						

//user='no_user';		

 feature_select.activate();
  draw_to_query.deactivate();


   };
  polygonLayer.onFeatureInsert = gml_serialize; 
             
          var select_options = {
               onClick: true,
               multiple:false,
               onUnselect:function(feature) {feature.selected=false;},
               onSelect: function(feature) { 
                
				polygonLayer.setVisibility(true);
                feature.selected=true;               
                html='<div class="jqmdTL" style="background-size: 40%; z-index: 300;"><div class="jqmdTR"><div class="jqmdTC jqDrag">HOLA</div><input type="image" class="jqmdX jqmClose"/>';
				html+='<b><div id="remove_div">Do you want to delete some polygon? if yes, you can select more than one (just click over it). Then, if really want to delete, just click';
				html+='<button id="delete" onclick="remove()" value="Delete them!">Delete them!</button></div>';
		
			if ($('#remove_div').length == 0)
        {
  $('#ex5').empty();        
  $('#ex5').append(html);

msie=($.browser.msie==true)?true:false; 
if (msie)
{$('input.jqmdX').css('background','url(http://edit.africamuseum.be/edit_wp5/edit_geo/prototype/JQ_win_files/close.gif)  no-repeat top left').css('width','15px');}
else {$('input.jqmdX').css('background','url(http://edit.africamuseum.be/edit_wp5/edit_geo/prototype/JQ_win_files/close.gif) no-repeat top left');}
$('input.jqmdX').hover(function(){$(this).addClass('jqmdXFocus')},function(){        $(this).removeClass('jqmdXFocus')}).focus(function(){this.hideFocus=true;$(this).addClass('jqmdXFocus')}).blur(function(){$(this).removeClass('jqmdXFocus')}).click(function(){$('#ex2').hide();  });
$("#ex5").animate({width:'280',height:'105'},"slow");
			}
               }
            }; //END OnSelect de select_options
	        
		var history = new OpenLayers.Control.NavigationHistory();
		var panel_controls=[
		   
		    new OpenLayers.Control.ZoomBox(),
		    new OpenLayers.Control.PanZoomBar(),
		    pan=new OpenLayers.Control.DragPan({displayClass:'olControlPanMap'}),
		    new OpenLayers.Control.ZoomToMaxExtent({title:"Zoom to the max extent"}),
		     featureInfo = new OpenLayers.Control({
			    displayClass: "olControlFeatureInfoItemActive",
			    title: "Query map features"
			    }),
			
			featureInfo2 = new OpenLayers.Control({
				    displayClass: "olControlFeatureInfo2",
				    title: "Query map features by polygon"
				    }),
			history,
			history.next,
			history.previous
			]

			featureInfo.events.register("activate", featureInfo, function() {

				ppol_query="false";
			    toggleQueryMode(); });                
			featureInfo.events.register("deactivate", featureInfo, function() {
			    toggleQueryMode(); });
			
						featureInfo2.events.register("activate", featureInfo2, function() {

						    toggleQueryMode2(); ppol_query="true"; });                
						featureInfo2.events.register("deactivate", featureInfo2, function() {
							ppol_query="false";
						    toggleQueryMode2(); });

			//var bounds=new OpenLayers.Bounds(-11.6,36.2,3.2,41.7);
		//	var bounds=new OpenLayers.Bounds(-10.6,43.8,4.14,36.44);
//			var bounds=new OpenLayers.Bounds(-123.046875,-61.523437,123.046875,61.523438);
	bounds=new OpenLayers.Bounds(-180,-90,180,90);
//    options.maxExtent=new OpenLayers.Bounds(-180,-90,180,90);
			center=bounds.getCenterLonLat();	
            		   
		   var overview_map = new OpenLayers.Layer.WMS( "EDIT WMS",
                "http://193.190.223.46:8080/geoserver/wms",
                {layers: "country_earth",group:"admin",transparent:"true",format:"image/png",styles:[]});

		var edit_blank2 = new OpenLayers.Layer.WMS( "EDIT WMS transparent",
			"http://193.190.223.46:8080/geoserver/wms",
			                {layers:"blank",transparent:"false",format: t_img_format,styles:"transparent",group:"remote"},
						{isBaseLayer: true});

	//var o_options = {layers: [edit_blank]};
   var o_options = {
//            maxExtent: new OpenLayers.Bounds(-123.046875,-61.523437,123.046875,61.523438), 
            projection: "EPSG:4326",
           layers:[edit_blank2,overview_map]            
        };
        
var overview=new OpenLayers.Control.OverviewMap(o_options);
 map.addControl(overview);
   map.addControl( new OpenLayers.Control.LoadingPanel());  
 //  overview.maximizeControl();
							var panel = new OpenLayers.Control.Panel({
							    div: document.getElementById("panel")
							});
							map.addControl(panel);
							
			 map.addControl(new OpenLayers.Control.ScaleLine({'div':OpenLayers.Util.getElement('escala')},{theme: null}));
			 
			 
			          var control = new OpenLayers.Control.Scale(); 
					control.div = document.getElementById("escala2"); 
					map.addControl(control); 
			 map.addControl(new OpenLayers.Control.MousePosition({'div':OpenLayers.Util.getElement('coords')},{theme: null}));
					//	var pan=new OpenLayers.Control.PanZoomBar();
							
						//	map.addControl(history);

							//panel.addControls([new OpenLayers.Control.ZoomBox(),pan,
			for (key in panel_controls)
			{
			panel.addControls(panel_controls[key])
			}
				map.addControl(history);

	     map.addControl(new OpenLayers.Control.LayerSwitcher({'div':OpenLayers.Util.getElement('layerswitcher')}));

	queryEventHandler = new OpenLayers.Handler.Click({ 'map': map }, {  ondblclick: function() {alert("dounle lick")}, 
	'click': function(e) { doGetFeatureInfo(e); }});	
	
	// toggle the queryEventHandler active state
	function toggleQueryMode()
	{            

	    if(featureInfo.active) {
	        queryEventHandler.activate();
	    }
	    else {
	        queryEventHandler.deactivate();
	    }
	}

            polygonLayerControl=new OpenLayers.Control.DrawFeature(polygonLayer, OpenLayers.Handler.Polygon);
           map.addControl(polygonLayerControl);



function doGetFeatureInfo(evt) { 
	
	  var lonlat = map.getLonLatFromViewPortPx(evt.xy);
	  //console.info(lonlat);
/*        alert("You clicked near " + lonlat.lat + " N, " +
                                  + lonlat.lon + " E");
*/
								    x = parseFloat(lonlat.lon);	// make into floats
									y = parseFloat(lonlat.lat);
     						if (ppol_query=="false")
									{									
									var ul = new Array();// x, y
									var ur = new Array();
									var bl = new Array();
									var br = new Array();// x, y	
									ul[0] = x-0.1;
									ul[1] = y+0.1;
									bl[0]= x-0.1;
									bl[1]= y-0.1;
									ur[0]= x+0.1;
									ur[1]= y +0.1;
									br[0] = x+0.1;
									br[1] = y-0.1;
								    bbox=[];
									bbox.push(ul,bl,ur,br,ul);	
								
//console.log("ppol_query false");
								$.getScript('js_code/bind_results_sld.js');
							}
						  else
						{
//console.log("ppol_query true");			
								$.getScript('js_code/bind_results_ppol_adaptat.js');			
						}
							}

	
map.addLayers([vlayer,edit_blank,edit_admin,shoreline]);
shoreline.setVisibility(false);
//s_america1.setVisibility(false);s_america2.setVisibility(false);oceania1.setVisibility(false);oceania2.setVisibility(false);
  map.setBaseLayer(edit_blank);
  map.addLayer(edit_gbif);
  edit_gbif.setVisibility(false);
 map.zoomToExtent(bounds);
//map.setCenter(bounds.getCenterLonLat(),map.getZoomForExtent(bounds));
queryEventHandler2 = new OpenLayers.Handler.Click({ 'map': map }, {  ondblclick: 
	function() {alert("dounle lick")}, 'click': function(e) {//
	
	doGetFeatureInfo(e); 
	}});	

queryEventHandler2 = new OpenLayers.Handler.Click({ 'map': map }, {  ondblclick: 
	function() {alert("dounle lick")}, 'click': function(e) {//
	//alert("dogetfeature"); 
	doGetFeatureInfo(e); 
	}});
	
// toggle the queryEventHandler active state
	function toggleQueryMode()
	{            

	    if(featureInfo.active) {
	        queryEventHandler.activate();
	    } 
	    else {
	        queryEventHandler.deactivate();
	    }
	}
	function toggleQueryMode2()
	{            

	    if(featureInfo2.active) {
	        queryEventHandler.activate();
	    }
	    else {
	        queryEventHandler.deactivate();
	    }
	}
//	map.zoomToMaxExtent(bounds);

	//l'ordre influeeeix!
function serialize(feature) 
   {

   queryEventHandler.deactivate();
//function(evt) {alert ('You clicked on marker m1'); OpenLayers.Event.stop (evt); }
	
	var wkt= new OpenLayers.Format.WKT(map.baseLayer.projection);
	polygon = wkt.write(feature);
    $.getScript('js_code/polygon_q_adaptat.js');

	}	

	 var f_options = {
                hover: false,
//                highlightOnly: true,
				click:true,
				clickout: true,
                 onSelect: serialize
  
  };
  
            feature_select = new OpenLayers.Control.SelectFeature(vlayer, f_options);
  //vlayer.events.register ('mouseout', vlayer, function() {alert("out")});
  //  feature_select
         //   OpenLayers.Feature.Vector.style['default']['strokeWidth'] = '2';
             function show_mouseover_text(evt)
        {
            textContent =
                "The mouse is over" +
                " feature '" + evt.feature.id + "'" +
                " of group '" + evt.name + "'.";
              //  console.warn(textContent);
        }


            map.addControl(feature_select);
           
            
       var select = new OpenLayers.Control.SelectFeature(polygonLayer, select_options);
            map.addControl(select);
            select.activate();       



	        } 
	legend='http://193.190.223.46:8080/geoserver/wms/GetLegendGraphic?VERSION=1.0.0&FORMAT=image/png&WIDTH=25&HEIGHT=20&LAYER=user_points&sld='+edit_points.params.SLD;

	    </script>
  </head>

   <body onload="init();bind();">
  <em id="em1">New tools are avaible here <p>for this Module</em>
<div id="mainbody">

<div id="header">

	<div style="position:relative; left: 20%;font: bold 16pt Arial, Helvetica, sans-serif; padding:5px;width:300px">EDIT mapViewer [prototype]</div>
</div><!--fi header-->

<div id="middle">
  <div id="menubar">
     
 <dl>

	<dt id="download_data">Printing options</dt>

			<dd id="print_params">
			<li>Image format
				<ul style="height:20px">
						 <form id="format_form" >
							<select>
							<option value="png/gray">PNG gray</option>	
							<option value="jpeg/gray">JPEG gray</option>	
							<option value="gif/gray">GIF gray</option>	
							<option value="tif/gray">TIF gray</option>					
							<option value="image/png">PNG</option>

							<option value="image/jpeg">JPEG</option>
								<option value="tif">TIF</option>
							<option value="image/gif">GIF</option>

							</select>

						</form>

			
						<form id="tif_form" style="visibility:hidden;" >
							<label>Do you want TIFF in CMYK?</label>
							<select>
	<option value="no_cmyk">no CMYK</option>
								<option value="cmyk">CMYK</option>

							</select>
						</form>	<br>
						<form id="bits_form" style="visibility:hidden;">
							<label>Do you want 8bit or 16bit?</label><br>
							<select>
								<option value="8bit">8bit</option>
								<option value="16bit">16bit</option>
							</select>
						</form>	
			 </ul>
			 </li>
			<li id="resolution">Resolution data
				<ul>
						 <form id="dpi_form">
							<select>
							<option value="120">120 dpi</option>
							<option value="240">240 dpi</option>
							<option value="480">480 dpi</option>
							<option value="600">600 dpi</option>	
			
						</select>
						</form><br>
						 <form id="img_size_form">
							<select>
							<option value="medium">7.5x3.75 cm</option>
							<option selected="selected" value="big">15x7.5 cm</option>			
						</select>

					</form>
				</ul>
			</li>
			<li>Windrose
			<ul>
					<form id="windrose_form">
								<label>Do you want a windrose?</label><br>
								<select>
									<option selected="selected" value="no">NO</option>
									<option value="yes">YES</option>

								</select>
							</form>
					<form id="choose_windrose_form">
								<label>Choose a windrose</label><br>
								<select>
									<option selected="selected" value="no_windrose"></option>
									<option value="windrose1.png">windrose 1</option>
									<option value="windrose2.png">windrose 2</option>
									<option value="windrose3.png">windrose 3</option>
									<option value="windrose4.png">windrose 4</option>
									<option value="windrose5.png">windrose 5</option>
								</select>
							</form>

			</ul>
			</li>
			
			<li>Scalebar options
			<ul>
			     <form id="scalebar_form">
								<label>Do you want a scalebar?</label><br>
								<select>
								    <option selected="selected" value="no">NO</option>
									<option value="yes">YES</option>
									
								</select>
				</form>
				<div>
				<form id="l_size"><label>Scalebar size</label><br>
				<select>
				 <option selected="selected" value="200">Medium</option>
				 <option value="400">Large</option>				
				</select>
				 </form>
				 <form id="l_label_size"><label>Scalebar label size</label><br>
				<select>
				 <option value="tiny">tiny</option>
				 <option value="small">small</option>	
				 <option selected="selected" value="medium">medium</option>
				 <option value="large">large</option>
				 <option value="giant">giant</option>
				</select>				 
				</form>
				<form id="l_intervals"><label>Scalebar intervals</label><br>
				<select>				 
				 <option value="2">2</option>
				 <option selected="selected" value="4">4</option>	
				 <option value="6">6</option>	
				</select>
				</form>
				<form id="l_units"><label>Scalebar units</label><br>
				<select>
				 <option value="METERS">meters</option>
				 <option  value="KILOMETERS" selected="selected">kilometers</option>	
				 <option value="MILES">miles</option>	
				</select>			
			</form>			
			    
			<!--	<img id="map_legend" src='' />-->
			<div class="message3" id="get_scalebar">UPDATE the scalebar</div>
		<!--<div id="get_legend">click <a style="text-decoration: underline">here</a> to UPDATE the scalebar</div>-->
				</div>

			</ul>
			</li>

		<!--<ul><input type="radio"  id="browse_mode" onClick='toogle_mode("browse")' checked name="browsing">Browsing mode</input>
				<div class="message2">After printing is important to switch to browsing mode!</div>
				</ul>	
				
				<ul><input type="radio" id="print_mode" onClick='toogle_mode("print")'  name="browsing">Printing mode</input></ul>
				<div class="message2">Use printing mode only to check that what you see is what you will get on printing</div>-->
				
		<li>Print your map, legends & keymap
        <ul>
      
        <div class="message3" id="get_points">GET the points legend</div><br>
		<div class="message3" id="get_keymap">GET the keymap</div><br>
		<div class="message3" onclick='print_legend()'>GET the legend</div><br>
		<div class="message3" id="get_image">GET this image </div>

	    </ul>
		</li>
		</dd>
	</dt>
	<dt id="edit_layers">Layers</dt>
		<dd>
	

	<div id='layers'>

			<li id="tdwg">TDWG layers</li>
			<li id="nature">Natural features</li>
			<li id="quadricules">Quadricule layers (degree grids)</li>
			<li id="utm">UTM grids</li>
			<li id="admin">Administrative layers
						<ul style="height:auto;margin-left:20px">
							<li id="africa" style="height:auto">Africa</li>	
						</ul>
						<ul style="height:auto;margin-left:20px">
							<li id="antartica" style="height:auto">Antartica</li>	
						</ul>						
						<ul style="height:auto;margin-left:20px">
							<li id="asia" style="height:auto">Asia</li>	
						</ul>
							<ul style="height:auto;margin-left:20px">
								<li id="c_america" style="height:auto">Central America</li>	
							</ul>						
								<ul style="height:auto;margin-left:20px">
									<li id="east_europe" style="height:auto">East Europe</li>	
								</ul>	
										<ul style="height:auto;margin-left:20px">
											<li id="west_europe" style="height:auto">West Europe</li>	
										</ul>					
					<ul style="height:auto;margin-left:20px">
					<li id="n_america" style="height:auto">North America</li>	
					</ul>
				<ul style="height:auto;margin-left:20px">
				<li id="s_america" style="height:auto">South America</li>	
				</ul>
					<ul style="height:auto;margin-left:20px">
					<li id="oceania" style="height:auto">Oceania</li>	
					</ul>				
	    
			</li>												
			<li id="remote">Background layers
				<ul><input type="radio" name="remote" id="blank" onClick='toogle_background(edit_blank)' checked grup="remote">Transparent background</input></ul>
				<ul><input type="radio" name="remote" id="nasa" onClick='toogle_background(edit_nasa)' grup="remote">NASA JPL data</input></ul>	
				
			</li>	

	</div>
	</dd>
 
    <dt id="upload_projects">Your projects</dt>
		<dd>
		<div id="create_proj" onclick="create_json()" style="height:20px;border:1px solid #333333;background-color:#FFF8F0"><a style="text-decoration: underline">Create your project</a></div>
		<div id="upload_json" style="height:80px;border:1px solid #333333;background-color:#e8b43b">Upload your project
		
			
		<img id="loading" src="loading.gif" style="display:none;">
		
		<table style="width: 100%;" class="layerControl">
		<form id="u_json_form" name="u_json_form" action="" method="POST" enctype="multipart/form-data">
		<thead>
			<tr>
				<th style="height: 1px;font-size: 8px;">Select a project file and click Upload button</th>
			</tr>
		</thead>
		<tbody>	
		<tr>
				<td><input id="json_file" type="file" size="18" name="json_file" class="input"></td></tr>
		</tbody>
			<tfoot>
				<tr>
					<td><button class="button" id="buttonUpload" onclick="return ajaxFileUpload('json');">Upload</button></td>
				</tr>
			</tfoot>
	
	</table>
	
		</div>
		
		</dd>
<dt id="gbif">GBIF data</dt>

	<dd>
	  <ul>
		 

	    <li>
				<a id="gbif_trigger" href="#" class="ex2trigger">Explore GBIF data</a><br>
				<b>It doesn't work with Internet Explorer!!</b><br>
		
		 	
					<table  id="gbif_table" cellspacing="0" style="width: 100%;" class="layerControl">
							<tbody>
						<tr>
							<td>
					<input type="checkbox" onclick="toogle_gbif(this)" id="gbif"/><label style='font-size:11'>GBIF data for <b>Copris</b></label>
							</td><tr><td><img src='http://edit.africamuseum.be/edit_wp5/edit_geo/prototype/images/gbif_legend.png'/>
							</td></tr>
					</tr>
					</tbody></table>
	
			   	
		</li>
		
	</ul>
	</dd>
<!--	<dt id="upload_projects">Your projects</dt>
		<dd>
		<div id="create_proj" onclick="create_json()" style="height:20px;border:1px solid #333333;background-color:#FFF8F0"><a style="text-decoration: underline">Create your project</a></div>
		<div id="upload_json" style="height:80px;border:1px solid #333333;background-color:#e8b43b">Upload your project
		
			
		<img id="loading" src="loading.gif" style="display:none;">
		
		<table style="width: 100%;" class="layerControl">
		<form id="u_json_form" name="u_json_form" action="" method="POST" enctype="multipart/form-data">
		<thead>
			<tr>
				<th style="height: 1px;font-size: 8px;">Please select a file and click Upload button</th>
			</tr>
		</thead>
		<tbody>	
		<tr>
				<td><input id="json_file" type="file" size="18" name="json_file" class="input"></td></tr>
		</tbody>
			<tfoot>
				<tr>
					<td><button class="button" id="buttonUpload" onclick="return ajaxFileUpload('json');">Upload</button></td>
				</tr>
			</tfoot>
	
	</table>
	
		</div>
		
		</dd>
		</dt>
		-->
		<dt id="upload_data">Upload your CSV data!</dt>
		<dd>
		<div id="upload_content">
		<img id="loading" src="img/loading.gif" style="display:none;">
		
		<table style="width: 100%;" class="layerControl">
<form id="upload_form" name="form" action="" method="POST" enctype="multipart/form-data">
		<thead>
			<tr>
				<th style="height: 1px;font-size: 10px;">Upload a CSV file</th>
			</tr>
		</thead>
		<tbody>	
			<tr>
				<td><input id="file" type="file" size="11" name="file" class="input"></td></tr>
				<label>Number of fields</label>

				<textarea style="width: 20px; height: 20px; overflow:hidden; resize: none" class="input" id="fields"></textarea>
					<br>

				<label>Position of latitude</label>

				<textarea style="width: 20px; height: 20px; overflow:hidden; resize: none"  id="lat"></textarea>
				<br>
				<label>Position of longitude</label>

				<textarea style=" width: 20px; height: 20px;overflow:hidden;resize: none"  id="lon"></textarea>

		</tbody>
			<tfoot>
				<tr>
					<td><button class="button" id="buttonUpload" onclick="return ajaxFileUpload('points');">Upload</button></td>
				</tr>
			</tfoot>
	
	</table>
		<input checked="true" name="dataset" type="radio" id="new_data">create new dataset</input><br>
	<input name="dataset" type="radio" id="add_data" >add to the current data</input><br>
	<div id="show_csv" class="message3 show_it" style="width:auto;left:0px"><b>Show data format and CSV example</b>
	<div id="message">
	<a href="http://edit.africamuseum.be/edit_wp5/web/for_testing.zip" target="blank">Here</a> you can download an example of a valid CSV file (1000 records)<br><br>
	The parameters to fill <b>for this test file</b> are:
	<ul>
	<li>Number of fields:5</li>
		<li>Latitude: 1</li>
			<li>Longitude: 2</li>
	</ul>
	The file must be a CSV (comma-separated values) and have at least latitude and longitude in WGS84 datum and a field (genus, species...) for future filtering and symbolization.<br>

The system is currently designed to work with Genus and Species, and these must be the third (and fourth) field in your CSV.<p>
You can try to work with other kind of data, but you must have at least a third field in the CSV.<br><br>
Don't leave any blank space! don't use non-latin letters or symbols (accents, ' > < commas...)<br><br>

Coordinates must follow Decimal notation (eg: 0.44, -79.9). To transform to Decimal notation you can use the <a href="http://gis.miiz.waw.pl/webapps/coordinateconverter/default.aspx" target="blank">Coordinate Conversor</a>
	</div>
	</div>
		</form>    

	
	</div>	  
		  
		</dd>

		
	<dt id="user_dates">Your Point Data</dt>	
	<dd>
	<ul>
		    <li>
          <!--  <a style="text-decoration: underline" id="puntos_info">
            Sample Point Data</a><br>-->
            <input  checked='true' name='p_data' type='checkbox' id='edit_points'">Your data</input><br>
			<!--<div id="puntos_lay"><table id="control"><td id="puntos_legend"></a></li></td> </table></div>-->
				<a id="id" style="text-decoration: underline" href="#" onClick="return false" class="ex2trigger">Symbolize your data</a><br>
			<div style="padding-top:10px"><img name="legend" id="legend" src=""/></div>
		

			</li>
			
	  </ul>
	  
	</dd>
			<dt id="analysis">Spatial analysis</dt>
			<dd>
				<ul>			 								
				 <div>	
				 	
					<form  id="run_analysis">
						<select>
							<option value="utm250000sqkm_earth">UTM 250000 sqkm Earth</option>
						<option value="europe_level_1">Europe level 1</option>
						<!--	<option value="europe_level_0">Europe level 0</option>-->
							<option value="grid10_pol">10 degrees grid</option>
							<option value="grid5_pol">5 degrees grid</option>
							<option value="grid2_pol">2 degrees grid</option>
							<option value="grid1_pol">1 degrees grid</option>
							<option value="grid_0_5_pol">0.5 degrees grid</option>
							<option value="utm_world">UTM world</option>
							<option value="utm_europe">UTM Europe</option>
							
						 
						</select><br>
					<a href="#">run analysis</a>
<!--					<div class="message3" id="run_analysis">run analysis</div>-->
					</form>

					</div>
					<div id="analysis_lay">
				     </div>
					<div id="ppol_message">
					<a href="http://edit.africamuseum.be/edit_wp5/geo/curves/edit_curves.html" target="_blank"><em>Collector's curves (graphic) for this demo</em></a><br>
					A review of the available scientific information on the possibilities and usefulness of the compiled species distribution data for basic and applied purposes is available for download at http://wp5.e-taxonomy.eu/blog/files_edit_wp5/2007-07-26_D5.35_&_D5.38.doc
					</div>
					</ul>
					
			</dd>

		<dt id="interactive_analysis">Interactive analysis tools</dt>		
		<dd>

<input type="checkbox" name="type" class="first" id="interactive_analysis_input" onclick="v_toggle(this);">Click here, wait the layer to appear on the map and hover the desired polygon</input>

<table id="polygon_info"><tbody>
<tr><td id='code'>Polygon code:</td></tr>
<tr><td id="num_regs">Number of records</td></tr>
<tr><td id="num_genus">Number of genera</td></tr>
<tr><td id="taxa_record">Taxa/record</td></tr>
</tbody></table>

		</dd>
			<dt id="modules">Add/Remove modules</dt>
				<dd>

			<div id='analysis_m' class='ppol_message visible' onclick="change($(this))"><b>Show</b> analysis module</div>
			<div id='gbif_m' class='ppol_message visible' onclick="change($(this))"><b>Show</b> GBIF module</div>
			<div id='query_m' class='ppol_message visible' onclick="change($(this))"><b>Show</b> Query & draw module</div>
		
			</dd>  
<dt>Help&Contact
<dd>
We are updating documentation, but you can <a href="http://edit.africamuseum.be/edit_wp5/edit_info/edit_videos.html" target="blank">check these videos </a>(previous version)<br><br>
We are in development, but you can share your experience, complain or just suggest something to peroc79gmail.com (Pere Roca)<br>
Most of the GIS layers here can be found on <a href="http://edit.africamuseum.be/edit_wp5/GISdownloads.html" target="blank">EDIT GIS download site</a>
</dd>
</dt>
		</dl>

</div> <!-- fi menubar-->
</div> <!-- fi middle -->


<div id="ex2"  style="position:absolute;width:350px;height:345px;margin-left:0px" class="jqmDialog">
	
</div>


<div id="layer_symbol"  style="position:absolute;width:400px;height:325px;margin-left:0px" class=" jqmDialog">
	
</div>

				<div id="print"  class="ex2trigger"></div>
		    <div id="ex_print" class="jqmDialog">
				</div>
<div id="ppol_win"  style="width:300px;height:155px" class="jqmDialog">
	
	<div class="jqmdTL">
    <div class="jqmdTR">
	<input  class="jqmdX jqmClose" />
	     <div class="jqmdTC jqDrag">Spatial Analysis (you can click and drag me)</div>

			<div id="sp_query_container"></div>
	</div>
	</div>
</div>
<div id="ex4"  style="left:350px;margin-left:0px;width:200px;height:440px"class="jqmDialog">
</div>
<div id="gbif_win"  style="left:200px;margin-left:0px;width:380px;height:325px"class="jqmDialog">
</div>

 <div id="query_result" style="margin-left:0px;" class="jqmDialog">
  <div class="jqmdTL">
    <div class="jqmdTR">

	     <div class="jqmdTC jqDrag">Query results (you can click and drag me)</div>   
	        <div id="wrapper">
	  		  <div id="query_container">					  
			   </div>
		    </div>
       </div>
  </div>
<input  class="jqmdX jqmClose" />
</div>


<div id="right" style="border:3px" class="right"><div id='panel' style="z-index:30000;"></div>
<div id="map" style="top:20px;width: 700px; height: 350px;" class="right">

</div>

<div id="images" style='position:absolute;top:40px;border: solid 1px #000000;'></div>
<div id="escala" class=".olControlScale" style="left:40px;top:130px;"></div>
<div id="escala2"  style="width:200px;font-size:12px"></div>
<div id="coords"  style="position:absolute;width:150px;font-size:12px"></div>	
<img id="ajax_image" src='http://edit.africamuseum.be/edit_wp5/edit_geo/prototype/images/loading.gif' style="visibility:hidden;width:100px;position:absolute"></img>

<img id="windrose" src='http://edit.africamuseum.be/edit_wp5/geo/images/windroses/windrose1.png' style="visibility:hidden;display:block;width:0px;position:absolute;index:20000"></img>

<img id="scalebar" src='http://edit.africamuseum.be/edit_wp5/geo/images/legends/275.png' style="visibility: hidden; display: block; width: 200px; position: absolute; z-index: 20000;"></img>	



		
	    <div id="ex_print" class="jqmDialog">

</div>
	<!--	<table id="edit_logo">
			    <tr>
               <td><img src="http://edit.africamuseum.be/edit_wp5/web/dingen/logoEDIT.png"/><td>
		</tr>
	</table>	-->
<script type="text/javascript">
sc_project=2722414; 
sc_invisible=0; 
sc_partition=27; 
sc_security="301c0f80"; 
sc_text=2; 
</script>
<script type="text/javascript" src="http://www.statcounter.com/counter/counter.js"></script>
<noscript><div style="visibility:hidden" class="statcounter"><a title="web analytics" href="http://www.statcounter.com/" target="_blank">
<img  style="visibility:hidden" class="statcounter" src="http://c28.statcounter.com/2722414/0/301c0f80/0/" alt="web analytics">
</a></div></noscript>	

</body>
</html>